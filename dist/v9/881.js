"use strict";(self.webpackChunkdocs_nestjs_com=self.webpackChunkdocs_nestjs_com||[]).push([[881],{2881:(X,B,h)=>{h.r(B),h.d(B,{RecipesModule:()=>O});var s=h(1180),z=h(6895),g=h(6641),$=h(4466),l=h(4834),e=h(1571),Z=h(4336),d=h(4521),m=h(7297);class f extends l.y{}(0,s.Z)(f,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(f)))(o||f)}}()),(0,s.Z)(f,"\u0275cmp",e.Xpm({type:f,selectors:[["app-cqrs"]],features:[e.qOj],decls:372,vars:64,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/cqrs.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","cqrs"],["rel","nofollow","target","_blank","href","https://en.wikipedia.org/wiki/Create,_read,_update_and_delete"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/cqrs"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","commands"],[1,"filename"],["appf634037a3edd9be0a9bc9ba763d801c4dec8915a",""],[1,"language-typescript"],["app67160251cb42cef477a7c636a2bc48dea789cce9",""],["appea4f573d6e53ecfa8980af6c38bbc699fd02ab5c",""],["appAnchor","","id","events"],["app938260cb8dd0a1462878ba30add3a7539e3d89a2",""],["appc1797d833fb0177b05442111e99e93c7792ed3ee",""],["app2ec3de46b10b31a1b1d9d096dbc168517de86059",""],[1,"info"],["app45d2a230f1a177983f92b48792ec8a3142ad3e27",""],["routerLink","/exception-filters"],["href","/recipes/cqrs#sagas"],["routerLink","/websockets/gateways"],["routerLink","/techniques/server-sent-events"],["appAnchor","","id","sagas"],["rel","nofollow","target","_blank","href","https://github.com/ReactiveX/rxjs"],["app7d58cdd1c3de46c9a235bcbf09a8b714b521d8b7",""],["appAnchor","","id","queries"],["appAnchor","","id","setup"],["app1aef04bd719fbe6a4d1be8946545f549b9cae842",""],["appAnchor","","id","summary"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/kamilmysliwiec/nest-cqrs-example"]],template:function(n,o){if(1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"CQRS"),e.qZA(),e.TgZ(7,"p"),e._uU(8,"The flow of simple "),e.TgZ(9,"a",6),e._uU(10,"CRUD"),e.qZA(),e._uU(11," (Create, Read, Update and Delete) applications can be described using the following steps:"),e.qZA(),e.TgZ(12,"ol")(13,"li"),e._uU(14,"The "),e.TgZ(15,"strong"),e._uU(16,"controllers"),e.qZA(),e._uU(17," layer handles HTTP requests and delegates tasks to the services layer."),e.qZA(),e.TgZ(18,"li"),e._uU(19,"The "),e.TgZ(20,"strong"),e._uU(21,"services layer"),e.qZA(),e._uU(22," is where most of the business logic lives."),e.qZA(),e.TgZ(23,"li"),e._uU(24,"Services use "),e.TgZ(25,"strong"),e._uU(26,"repositories / DAOs"),e.qZA(),e._uU(27," to change / persist entities."),e.qZA(),e.TgZ(28,"li"),e._uU(29,"Entities act as containers for the values, with setters and getters."),e.qZA()(),e.TgZ(30,"p"),e._uU(31,"In most cases, for small and medium-sized applications, this pattern is sufficient. However, when our requirements become more complex, the "),e.TgZ(32,"strong"),e._uU(33,"CQRS"),e.qZA(),e._uU(34," model may be more appropriate and scalable. To facilitate that model, Nest provides a lightweight "),e.TgZ(35,"a",7),e._uU(36,"CQRS module"),e.qZA(),e._uU(37,". This chapter describes how to use it."),e.qZA(),e.TgZ(38,"h4",8)(39,"span"),e._uU(40,"Installation"),e.qZA()(),e.TgZ(41,"p"),e._uU(42,"First install the required package:"),e.qZA(),e.TgZ(43,"pre")(44,"code",9),e._uU(45,"\n$ npm install --save @nestjs/cqrs\n"),e.qZA()(),e.TgZ(46,"h4",10)(47,"span"),e._uU(48,"Commands"),e.qZA()(),e.TgZ(49,"p"),e._uU(50,"In this model, each action is called a "),e.TgZ(51,"strong"),e._uU(52,"Command"),e.qZA(),e._uU(53,". When a command is dispatched, the application reacts to it. Commands can be dispatched from the services layer, or directly from controllers/gateways. Commands are consumed by "),e.TgZ(54,"strong"),e._uU(55,"Command Handlers"),e.qZA(),e._uU(56,"."),e.qZA(),e.TgZ(57,"span",11),e._uU(58),e.ALo(59,"extension"),e._UZ(60,"app-tabs",null,12),e.qZA(),e.TgZ(62,"pre")(63,"code",13),e._uU(64,"\n@Injectable()\nexport class HeroesGameService {\n  constructor(private commandBus: CommandBus) {}\n\n  async killDragon(heroId: string, killDragonDto: KillDragonDto) {\n    return this.commandBus.execute(\n      new KillDragonCommand(heroId, killDragonDto.dragonId)\n    );\n  }\n}\n"),e.qZA()(),e.TgZ(65,"pre")(66,"code",13),e._uU(67,"\n@Injectable()\n@Dependencies(CommandBus)\nexport class HeroesGameService {\n  constructor(commandBus) {\n    this.commandBus = commandBus;\n  }\n\n  async killDragon(heroId, killDragonDto) {\n    return this.commandBus.execute(\n      new KillDragonCommand(heroId, killDragonDto.dragonId)\n    );\n  }\n}\n"),e.qZA()(),e.TgZ(68,"p"),e._uU(69,"Here's a sample service that dispatches "),e.TgZ(70,"code"),e._uU(71,"KillDragonCommand"),e.qZA(),e._uU(72,". Let's see how the command looks:"),e.qZA(),e.TgZ(73,"span",11),e._uU(74),e.ALo(75,"extension"),e._UZ(76,"app-tabs",null,14),e.qZA(),e.TgZ(78,"pre")(79,"code",13),e._uU(80,"\nexport class KillDragonCommand {\n  constructor(\n    public readonly heroId: string,\n    public readonly dragonId: string,\n  ) {}\n}\n"),e.qZA()(),e.TgZ(81,"pre")(82,"code",13),e._uU(83,"\nexport class KillDragonCommand {\n  constructor(heroId, dragonId) {\n    this.heroId = heroId;\n    this.dragonId = dragonId;\n  }\n}\n"),e.qZA()(),e.TgZ(84,"p"),e._uU(85,"The "),e.TgZ(86,"code"),e._uU(87,"CommandBus"),e.qZA(),e._uU(88," is a "),e.TgZ(89,"strong"),e._uU(90,"stream"),e.qZA(),e._uU(91," of commands. It delegates commands to the equivalent handlers. Each command must have a corresponding "),e.TgZ(92,"strong"),e._uU(93,"Command Handler"),e.qZA(),e._uU(94,":"),e.qZA(),e.TgZ(95,"span",11),e._uU(96),e.ALo(97,"extension"),e._UZ(98,"app-tabs",null,15),e.qZA(),e.TgZ(100,"pre")(101,"code",13),e._uU(102,"\n@CommandHandler(KillDragonCommand)\nexport class KillDragonHandler implements ICommandHandler<KillDragonCommand> {\n  constructor(private repository: HeroRepository) {}\n\n  async execute(command: KillDragonCommand) {\n    const { heroId, dragonId } = command;\n    const hero = this.repository.findOneById(+heroId);\n\n    hero.killEnemy(dragonId);\n    await this.repository.persist(hero);\n  }\n}\n"),e.qZA()(),e.TgZ(103,"pre")(104,"code",13),e._uU(105,"\n@CommandHandler(KillDragonCommand)\n@Dependencies(HeroRepository)\nexport class KillDragonHandler {\n  constructor(repository) {\n    this.repository = repository;\n  }\n\n  async execute(command) {\n    const { heroId, dragonId } = command;\n    const hero = this.repository.findOneById(+heroId);\n\n    hero.killEnemy(dragonId);\n    await this.repository.persist(hero);\n  }\n}\n"),e.qZA()(),e.TgZ(106,"p"),e._uU(107,"With this approach, every application state change is driven by the occurrence of a "),e.TgZ(108,"strong"),e._uU(109,"Command"),e.qZA(),e._uU(110,". The logic is encapsulated in handlers. With this approach, we can simply add behavior like logging or persisting commands in the database (e.g., for diagnostics purposes)."),e.qZA(),e.TgZ(111,"h4",16)(112,"span"),e._uU(113,"Events"),e.qZA()(),e.TgZ(114,"p"),e._uU(115,"Command handlers neatly encapsulate logic. While beneficial, the application structure is still not flexible enough, not "),e.TgZ(116,"strong"),e._uU(117,"reactive"),e.qZA(),e._uU(118,". To remedy this, we also introduce "),e.TgZ(119,"strong"),e._uU(120,"events"),e.qZA(),e._uU(121,"."),e.qZA(),e.TgZ(122,"span",11),e._uU(123),e.ALo(124,"extension"),e._UZ(125,"app-tabs",null,17),e.qZA(),e.TgZ(127,"pre")(128,"code",13),e._uU(129,"\nexport class HeroKilledDragonEvent {\n  constructor(\n    public readonly heroId: string,\n    public readonly dragonId: string,\n  ) {}\n}\n"),e.qZA()(),e.TgZ(130,"pre")(131,"code",13),e._uU(132,"\nexport class HeroKilledDragonEvent {\n  constructor(heroId, dragonId) {\n    this.heroId = heroId;\n    this.dragonId = dragonId;\n  }\n}\n"),e.qZA()(),e.TgZ(133,"p"),e._uU(134,"Events are asynchronous. They are dispatched either by "),e.TgZ(135,"strong"),e._uU(136,"models"),e.qZA(),e._uU(137," or directly using "),e.TgZ(138,"code"),e._uU(139,"EventBus"),e.qZA(),e._uU(140,". In order to dispatch events, models have to extend the "),e.TgZ(141,"code"),e._uU(142,"AggregateRoot"),e.qZA(),e._uU(143," class."),e.qZA(),e.TgZ(144,"span",11),e._uU(145),e.ALo(146,"extension"),e._UZ(147,"app-tabs",null,18),e.qZA(),e.TgZ(149,"pre")(150,"code",13),e._uU(151,"\nexport class Hero extends AggregateRoot {\n  constructor(private id: string) {\n    super();\n  }\n\n  killEnemy(enemyId: string) {\n    // logic\n    this.apply(new HeroKilledDragonEvent(this.id, enemyId));\n  }\n}\n"),e.qZA()(),e.TgZ(152,"pre")(153,"code",13),e._uU(154,"\nexport class Hero extends AggregateRoot {\n  constructor(id) {\n    super();\n    this.id = id;\n  }\n\n  killEnemy(enemyId) {\n    // logic\n    this.apply(new HeroKilledDragonEvent(this.id, enemyId));\n  }\n}\n"),e.qZA()(),e.TgZ(155,"p"),e._uU(156,"The "),e.TgZ(157,"code"),e._uU(158,"apply()"),e.qZA(),e._uU(159," method does not dispatch events yet because there's no relationship between the model and the "),e.TgZ(160,"code"),e._uU(161,"EventPublisher"),e.qZA(),e._uU(162," class. How do we associate the model and the publisher? By using a publisher "),e.TgZ(163,"code"),e._uU(164,"mergeObjectContext()"),e.qZA(),e._uU(165," method inside our command handler."),e.qZA(),e.TgZ(166,"span",11),e._uU(167),e.ALo(168,"extension"),e._UZ(169,"app-tabs",null,19),e.qZA(),e.TgZ(171,"pre")(172,"code",13),e._uU(173,"\n@CommandHandler(KillDragonCommand)\nexport class KillDragonHandler implements ICommandHandler<KillDragonCommand> {\n  constructor(\n    private repository: HeroRepository,\n    private publisher: EventPublisher,\n  ) {}\n\n  async execute(command: KillDragonCommand) {\n    const { heroId, dragonId } = command;\n    const hero = this.publisher.mergeObjectContext(\n      await this.repository.findOneById(+heroId),\n    );\n    hero.killEnemy(dragonId);\n    hero.commit();\n  }\n}\n"),e.qZA()(),e.TgZ(174,"pre")(175,"code",13),e._uU(176,"\n@CommandHandler(KillDragonCommand)\n@Dependencies(HeroRepository, EventPublisher)\nexport class KillDragonHandler {\n  constructor(repository, publisher) {\n    this.repository = repository;\n    this.publisher = publisher;\n  }\n\n  async execute(command) {\n    const { heroId, dragonId } = command;\n    const hero = this.publisher.mergeObjectContext(\n      await this.repository.findOneById(+heroId),\n    );\n    hero.killEnemy(dragonId);\n    hero.commit();\n  }\n}\n"),e.qZA()(),e.TgZ(177,"p"),e._uU(178,"Now everything works as expected. Notice that we need to "),e.TgZ(179,"code"),e._uU(180,"commit()"),e.qZA(),e._uU(181," events since they're not being dispatched immediately. Obviously, an object doesn't have to exist up front. We can easily merge type context as well:"),e.qZA(),e.TgZ(182,"pre")(183,"code",13),e._uU(184,"\nconst HeroModel = this.publisher.mergeClassContext(Hero);\nnew HeroModel('id');\n"),e.qZA()(),e.TgZ(185,"p"),e._uU(186,"Now the model has the ability to publish events. Additionally, we can emit events manually using "),e.TgZ(187,"code"),e._uU(188,"EventBus"),e.qZA(),e._uU(189,":"),e.qZA(),e.TgZ(190,"pre")(191,"code",13),e._uU(192,"\nthis.eventBus.publish(new HeroKilledDragonEvent());\n"),e.qZA()(),e.TgZ(193,"blockquote",20)(194,"strong"),e._uU(195,"Hint"),e.qZA(),e._uU(196," The "),e.TgZ(197,"code"),e._uU(198,"EventBus"),e.qZA(),e._uU(199," is an injectable class.\n"),e.qZA(),e.TgZ(200,"p"),e._uU(201,"Each event can have multiple "),e.TgZ(202,"strong"),e._uU(203,"Event Handlers"),e.qZA(),e._uU(204,"."),e.qZA(),e.TgZ(205,"span",11),e._uU(206),e.ALo(207,"extension"),e._UZ(208,"app-tabs",null,21),e.qZA(),e.TgZ(210,"pre")(211,"code",13),e._uU(212,"\n@EventsHandler(HeroKilledDragonEvent)\nexport class HeroKilledDragonHandler implements IEventHandler<HeroKilledDragonEvent> {\n  constructor(private repository: HeroRepository) {}\n\n  handle(event: HeroKilledDragonEvent) {\n    // logic\n  }\n}\n"),e.qZA()(),e.TgZ(213,"p"),e._uU(214,"Now we can move the "),e.TgZ(215,"strong"),e._uU(216,"write logic"),e.qZA(),e._uU(217," into the event handlers."),e.qZA(),e.TgZ(218,"blockquote",20)(219,"strong"),e._uU(220,"Hint"),e.qZA(),e._uU(221," Be aware that when you start using event handlers you get out of the traditional HTTP web context.\n"),e.TgZ(222,"ul")(223,"li"),e._uU(224,"Errors in "),e.TgZ(225,"code"),e._uU(226,"CommandHandlers"),e.qZA(),e._uU(227," can still be caught by built-in "),e.TgZ(228,"a",22),e._uU(229,"Exception filters"),e.qZA(),e._uU(230,"."),e.qZA(),e.TgZ(231,"li"),e._uU(232,"Errors in "),e.TgZ(233,"code"),e._uU(234,"EventHandlers"),e.qZA(),e._uU(235," can't be caught by Exception filters: you will have to handle them manually. Either by a simple "),e.TgZ(236,"code"),e._uU(237,"try/catch"),e.qZA(),e._uU(238,", using "),e.TgZ(239,"a",23),e._uU(240,"Sagas"),e.qZA(),e._uU(241," by triggering a compensating event, or whatever other solution you choose."),e.qZA(),e.TgZ(242,"li"),e._uU(243,"HTTP Responses in "),e.TgZ(244,"code"),e._uU(245,"CommandHandlers"),e.qZA(),e._uU(246," can still be sent back to the client."),e.qZA(),e.TgZ(247,"li"),e._uU(248,"HTTP Responses in "),e.TgZ(249,"code"),e._uU(250,"EventHandlers"),e.qZA(),e._uU(251," cannot. If you want to send information to the client you could use "),e.TgZ(252,"a",24),e._uU(253,"WebSocket"),e.qZA(),e._uU(254,", "),e.TgZ(255,"a",25),e._uU(256,"SSE"),e.qZA(),e._uU(257,", or whatever other solution you choose."),e.qZA()()(),e.TgZ(258,"h4",26)(259,"span"),e._uU(260,"Sagas"),e.qZA()(),e.TgZ(261,"p"),e._uU(262,"This type of "),e.TgZ(263,"strong"),e._uU(264,"Event-Driven Architecture"),e.qZA(),e._uU(265," improves application "),e.TgZ(266,"strong"),e._uU(267,"reactiveness and scalability"),e.qZA(),e._uU(268,". Now, when we have events, we can simply react to them in various ways. "),e.TgZ(269,"strong"),e._uU(270,"Sagas"),e.qZA(),e._uU(271," are the final building block from an architectural point of view."),e.qZA(),e.TgZ(272,"p"),e._uU(273,"Sagas are an extremely powerful feature. A single saga may listen for 1..* events. Using the "),e.TgZ(274,"a",27),e._uU(275,"RxJS"),e.qZA(),e._uU(276," library, it can combine, merge, filter or apply other "),e.TgZ(277,"code"),e._uU(278,"RxJS"),e.qZA(),e._uU(279," operators on the event stream. Each saga returns an Observable which contains a command. This command is dispatched "),e.TgZ(280,"strong"),e._uU(281,"asynchronously"),e.qZA(),e._uU(282,"."),e.qZA(),e.TgZ(283,"span",11),e._uU(284),e.ALo(285,"extension"),e._UZ(286,"app-tabs",null,28),e.qZA(),e.TgZ(288,"pre")(289,"code",13),e._uU(290,"\n@Injectable()\nexport class HeroesGameSagas {\n  @Saga()\n  dragonKilled = (events$: Observable<any>): Observable<ICommand> => {\n    return events$.pipe(\n      ofType(HeroKilledDragonEvent),\n      map((event) => new DropAncientItemCommand(event.heroId, fakeItemID)),\n    );\n  }\n}\n"),e.qZA()(),e.TgZ(291,"pre")(292,"code",13),e._uU(293,"\n@Injectable()\nexport class HeroesGameSagas {\n  @Saga()\n  dragonKilled = (events$) => {\n    return events$.pipe(\n      ofType(HeroKilledDragonEvent),\n      map((event) => new DropAncientItemCommand(event.heroId, fakeItemID)),\n    );\n  }\n}\n"),e.qZA()(),e.TgZ(294,"blockquote",20)(295,"strong"),e._uU(296,"Hint"),e.qZA(),e._uU(297," The "),e.TgZ(298,"code"),e._uU(299,"ofType"),e.qZA(),e._uU(300," operator and the "),e.TgZ(301,"code"),e._uU(302,"@Saga()"),e.qZA(),e._uU(303," decorator are exported from the "),e.TgZ(304,"code"),e._uU(305,"@nestjs/cqrs"),e.qZA(),e._uU(306," package.\n"),e.qZA(),e.TgZ(307,"p"),e._uU(308,"We declared a rule - when any hero kills the dragon, the ancient item should be dropped. With this in place, "),e.TgZ(309,"code"),e._uU(310,"DropAncientItemCommand"),e.qZA(),e._uU(311," will be dispatched and processed by the appropriate handler."),e.qZA(),e.TgZ(312,"h4",29)(313,"span"),e._uU(314,"Queries"),e.qZA()(),e.TgZ(315,"p"),e._uU(316,"The "),e.TgZ(317,"code"),e._uU(318,"CqrsModule"),e.qZA(),e._uU(319," can also be used for handling queries. The "),e.TgZ(320,"code"),e._uU(321,"QueryBus"),e.qZA(),e._uU(322," follows the same pattern as the "),e.TgZ(323,"code"),e._uU(324,"CommandsBus"),e.qZA(),e._uU(325,". Query handlers should implement the "),e.TgZ(326,"code"),e._uU(327,"IQueryHandler"),e.qZA(),e._uU(328," interface and be marked with the "),e.TgZ(329,"code"),e._uU(330,"@QueryHandler()"),e.qZA(),e._uU(331," decorator."),e.qZA(),e.TgZ(332,"h4",30)(333,"span"),e._uU(334,"Setup"),e.qZA()(),e.TgZ(335,"p"),e._uU(336,"Finally, let's look at how to set up the whole CQRS mechanism."),e.qZA(),e.TgZ(337,"span",11),e._uU(338),e.ALo(339,"extension"),e._UZ(340,"app-tabs",null,31),e.qZA(),e.TgZ(342,"pre")(343,"code",13),e._uU(344,"\nexport const CommandHandlers = [KillDragonHandler, DropAncientItemHandler];\nexport const EventHandlers =  [HeroKilledDragonHandler, HeroFoundItemHandler];\n\n@Module({\n  imports: [CqrsModule],\n  controllers: [HeroesGameController],\n  providers: [\n    HeroesGameService,\n    HeroesGameSagas,\n    ...CommandHandlers,\n    ...EventHandlers,\n    HeroRepository,\n  ]\n})\nexport class HeroesGameModule {}\n"),e.qZA()(),e.TgZ(345,"h4",32)(346,"span"),e._uU(347,"Summary"),e.qZA()(),e.TgZ(348,"p")(349,"code"),e._uU(350,"CommandBus"),e.qZA(),e._uU(351,", "),e.TgZ(352,"code"),e._uU(353,"QueryBus"),e.qZA(),e._uU(354," and "),e.TgZ(355,"code"),e._uU(356,"EventBus"),e.qZA(),e._uU(357," are "),e.TgZ(358,"strong"),e._uU(359,"Observables"),e.qZA(),e._uU(360,". This means that you can easily subscribe to the whole stream and enrich your application with "),e.TgZ(361,"strong"),e._uU(362,"Event Sourcing"),e.qZA(),e._uU(363,"."),e.qZA(),e.TgZ(364,"h4",33)(365,"span"),e._uU(366,"Example"),e.qZA()(),e.TgZ(367,"p"),e._uU(368,"A working example is available "),e.TgZ(369,"a",34),e._uU(370,"here"),e.qZA(),e._uU(371,"."),e.qZA()()),2&n){const r=e.MAs(61),a=e.MAs(77),u=e.MAs(99),c=e.MAs(126),i=e.MAs(148),p=e.MAs(170),U=e.MAs(209),A=e.MAs(287),_=e.MAs(341);e.xp6(58),e.hij(" ",e.xi3(59,37,"heroes-game.service",r.isJsActive),"\n"),e.xp6(4),e.ekj("hide",r.isJsActive),e.xp6(3),e.ekj("hide",!r.isJsActive),e.xp6(9),e.hij(" ",e.xi3(75,40,"kill-dragon.command",a.isJsActive),"\n"),e.xp6(4),e.ekj("hide",a.isJsActive),e.xp6(3),e.ekj("hide",!a.isJsActive),e.xp6(15),e.hij(" ",e.xi3(97,43,"kill-dragon.handler",u.isJsActive),"\n"),e.xp6(4),e.ekj("hide",u.isJsActive),e.xp6(3),e.ekj("hide",!u.isJsActive),e.xp6(20),e.hij(" ",e.xi3(124,46,"hero-killed-dragon.event",c.isJsActive),"\n"),e.xp6(4),e.ekj("hide",c.isJsActive),e.xp6(3),e.ekj("hide",!c.isJsActive),e.xp6(15),e.hij(" ",e.xi3(146,49,"hero.model",i.isJsActive),"\n"),e.xp6(4),e.ekj("hide",i.isJsActive),e.xp6(3),e.ekj("hide",!i.isJsActive),e.xp6(15),e.hij(" ",e.xi3(168,52,"kill-dragon.handler",p.isJsActive),"\n"),e.xp6(4),e.ekj("hide",p.isJsActive),e.xp6(3),e.ekj("hide",!p.isJsActive),e.xp6(32),e.hij(" ",e.xi3(207,55,"hero-killed-dragon.handler",U.isJsActive),"\n"),e.xp6(78),e.hij(" ",e.xi3(285,58,"heroes-game.saga",A.isJsActive),"\n"),e.xp6(4),e.ekj("hide",A.isJsActive),e.xp6(3),e.ekj("hide",!A.isJsActive),e.xp6(47),e.hij(" ",e.xi3(339,61,"heroes-game.module",_.isJsActive),"\n")}},dependencies:[Z.n,d.U,g.rH,m.F],encapsulation:2,changeDetection:0}));class y extends l.y{}(0,s.Z)(y,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(y)))(o||y)}}()),(0,s.Z)(y,"\u0275cmp",e.Xpm({type:y,selectors:[["app-crud-generator"]],features:[e.qOj],decls:128,vars:0,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/crud-generator.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","crud-generator"],["appAnchor","","id","introduction"],["routerLink","/cli/overview"],[1,"info"],["appAnchor","","id","generating-a-new-resource"],[1,"language-shell"],[1,"language-typescript"],[1,"warning"]],template:function(n,o){1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"CRUD generator"),e.qZA(),e.TgZ(7,"p"),e._uU(8,"Throughout the life span of a project, when we build new features, we often need to add new resources to our application. These resources typically require multiple, repetitive operations that we have to repeat each time we define a new resource."),e.qZA(),e.TgZ(9,"h4",6)(10,"span"),e._uU(11,"Introduction"),e.qZA()(),e.TgZ(12,"p"),e._uU(13,"Let's imagine a real-world scenario, where we need to expose CRUD endpoints for 2 entities, let's say "),e.TgZ(14,"strong"),e._uU(15,"User"),e.qZA(),e._uU(16," and "),e.TgZ(17,"strong"),e._uU(18,"Product"),e.qZA(),e._uU(19," entities.\nFollowing the best practices, for each entity we would have to perform several operations, as follows:"),e.qZA(),e.TgZ(20,"ul")(21,"li"),e._uU(22,"Generate a module ("),e.TgZ(23,"code"),e._uU(24,"nest g mo"),e.qZA(),e._uU(25,") to keep code organized and establish clear boundaries (grouping related components)"),e.qZA(),e.TgZ(26,"li"),e._uU(27,"Generate a controller ("),e.TgZ(28,"code"),e._uU(29,"nest g co"),e.qZA(),e._uU(30,") to define CRUD routes (or queries/mutations for GraphQL applications)"),e.qZA(),e.TgZ(31,"li"),e._uU(32,"Generate a service ("),e.TgZ(33,"code"),e._uU(34,"nest g s"),e.qZA(),e._uU(35,") to implement & isolate business logic"),e.qZA(),e.TgZ(36,"li"),e._uU(37,"Generate an entity class/interface to represent the resource data shape"),e.qZA(),e.TgZ(38,"li"),e._uU(39,"Generate Data Transfer Objects (or inputs for GraphQL applications) to define how the data will be sent over the network"),e.qZA()(),e.TgZ(40,"p"),e._uU(41,"That's a lot of steps!"),e.qZA(),e.TgZ(42,"p"),e._uU(43,"To help speed up this repetitive process, "),e.TgZ(44,"a",7),e._uU(45,"Nest CLI"),e.qZA(),e._uU(46," provides a generator (schematic) that automatically generates all the boilerplate code to help us avoid doing all of this, and make the developer experience much simpler."),e.qZA(),e.TgZ(47,"blockquote",8)(48,"strong"),e._uU(49,"Note"),e.qZA(),e._uU(50," The schematic supports generating "),e.TgZ(51,"strong"),e._uU(52,"HTTP"),e.qZA(),e._uU(53," controllers, "),e.TgZ(54,"strong"),e._uU(55,"Microservice"),e.qZA(),e._uU(56," controllers, "),e.TgZ(57,"strong"),e._uU(58,"GraphQL"),e.qZA(),e._uU(59," resolvers (both code first and schema first), and "),e.TgZ(60,"strong"),e._uU(61,"WebSocket"),e.qZA(),e._uU(62," Gateways.\n"),e.qZA(),e.TgZ(63,"h4",9)(64,"span"),e._uU(65,"Generating a new resource"),e.qZA()(),e.TgZ(66,"p"),e._uU(67,"To create a new resource, simply run the following command in the root directory of your project:"),e.qZA(),e.TgZ(68,"pre")(69,"code",10),e._uU(70,"\n$ nest g resource\n"),e.qZA()(),e.TgZ(71,"p")(72,"code"),e._uU(73,"nest g resource"),e.qZA(),e._uU(74," command not only generates all the NestJS building blocks (module, service, controller classes) but also an entity class, DTO classes as well as the testing ("),e.TgZ(75,"code"),e._uU(76,".spec"),e.qZA(),e._uU(77,") files."),e.qZA(),e.TgZ(78,"p"),e._uU(79,"Below you can see the generated controller file (for REST API):"),e.qZA(),e.TgZ(80,"pre")(81,"code",11),e._uU(82,"\n@Controller('users')\nexport class UsersController {\n  constructor(private readonly usersService: UsersService) {}\n\n  @Post()\n  create(@Body() createUserDto: CreateUserDto) {\n    return this.usersService.create(createUserDto);\n  }\n\n  @Get()\n  findAll() {\n    return this.usersService.findAll();\n  }\n\n  @Get(':id')\n  findOne(@Param('id') id: string) {\n    return this.usersService.findOne(+id);\n  }\n\n  @Patch(':id')\n  update(@Param('id') id: string, @Body() updateUserDto: UpdateUserDto) {\n    return this.usersService.update(+id, updateUserDto);\n  }\n\n  @Delete(':id')\n  remove(@Param('id') id: string) {\n    return this.usersService.remove(+id);\n  }\n}\n"),e.qZA()(),e.TgZ(83,"p"),e._uU(84,"Also, it automatically creates placeholders for all the CRUD endpoints (routes for REST APIs, queries and mutations for GraphQL, message subscribes for both Microservices and WebSocket Gateways) - all without having to lift a finger."),e.qZA(),e.TgZ(85,"blockquote",12)(86,"strong"),e._uU(87,"Note"),e.qZA(),e._uU(88," Generated service classes are "),e.TgZ(89,"strong"),e._uU(90,"not"),e.qZA(),e._uU(91," tied to any specific "),e.TgZ(92,"strong"),e._uU(93,"ORM (or data source)"),e.qZA(),e._uU(94,". This makes the generator generic enough to meet the needs of any project. By default, all methods will contain placeholders, allowing you to populate it with the data sources specific to your project.\n"),e.qZA(),e.TgZ(95,"p"),e._uU(96,"Likewise, if you want to generate resolvers for a GraphQL application, simply select the "),e.TgZ(97,"code"),e._uU(98,"GraphQL (code first)"),e.qZA(),e._uU(99," (or "),e.TgZ(100,"code"),e._uU(101,"GraphQL (schema first)"),e.qZA(),e._uU(102,") as your transport layer."),e.qZA(),e.TgZ(103,"p"),e._uU(104,"In this case, NestJS will generate a resolver class instead of a REST API controller:"),e.qZA(),e.TgZ(105,"pre")(106,"code",10),e._uU(107,"\n$ nest g resource users\n\n> ? What transport layer do you use? GraphQL (code first)\n> ? Would you like to generate CRUD entry points? Yes\n> CREATE src/users/users.module.ts (224 bytes)\n> CREATE src/users/users.resolver.spec.ts (525 bytes)\n> CREATE src/users/users.resolver.ts (1109 bytes)\n> CREATE src/users/users.service.spec.ts (453 bytes)\n> CREATE src/users/users.service.ts (625 bytes)\n> CREATE src/users/dto/create-user.input.ts (195 bytes)\n> CREATE src/users/dto/update-user.input.ts (281 bytes)\n> CREATE src/users/entities/user.entity.ts (187 bytes)\n> UPDATE src/app.module.ts (312 bytes)\n"),e.qZA()(),e.TgZ(108,"blockquote",8)(109,"strong"),e._uU(110,"Hint"),e.qZA(),e._uU(111," To avoid generating test files, you can pass the "),e.TgZ(112,"code"),e._uU(113,"--no-spec"),e.qZA(),e._uU(114," flag, as follows: "),e.TgZ(115,"code"),e._uU(116,"nest g resource users --no-spec"),e.qZA()(),e.TgZ(117,"p"),e._uU(118,"We can see below, that not only were all boilerplate mutations and queries created, but everything is all tied together. We're utilizing the "),e.TgZ(119,"code"),e._uU(120,"UsersService"),e.qZA(),e._uU(121,", "),e.TgZ(122,"code"),e._uU(123,"User"),e.qZA(),e._uU(124," Entity, and our DTO's."),e.qZA(),e.TgZ(125,"pre")(126,"code",11),e._uU(127,"\nimport { Resolver, Query, Mutation, Args, Int } from '@nestjs/graphql';\nimport { UsersService } from './users.service';\nimport { User } from './entities/user.entity';\nimport { CreateUserInput } from './dto/create-user.input';\nimport { UpdateUserInput } from './dto/update-user.input';\n\n@Resolver(() => User)\nexport class UsersResolver {\n  constructor(private readonly usersService: UsersService) {}\n\n  @Mutation(() => User)\n  createUser(@Args('createUserInput') createUserInput: CreateUserInput) {\n    return this.usersService.create(createUserInput);\n  }\n\n  @Query(() => [User], { name: 'users' })\n  findAll() {\n    return this.usersService.findAll();\n  }\n\n  @Query(() => User, { name: 'user' })\n  findOne(@Args('id', { type: () => Int }) id: number) {\n    return this.usersService.findOne(id);\n  }\n\n  @Mutation(() => User)\n  updateUser(@Args('updateUserInput') updateUserInput: UpdateUserInput) {\n    return this.usersService.update(updateUserInput.id, updateUserInput);\n  }\n\n  @Mutation(() => User)\n  removeUser(@Args('id', { type: () => Int }) id: number) {\n    return this.usersService.remove(id);\n  }\n}\n"),e.qZA()()())},dependencies:[d.U,g.rH],encapsulation:2,changeDetection:0}));class b extends l.y{}(0,s.Z)(b,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(b)))(o||b)}}()),(0,s.Z)(b,"\u0275cmp",e.Xpm({type:b,selectors:[["app-documentation"]],features:[e.qOj],decls:53,vars:0,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/documentation.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","documentation"],["appAnchor","","id","setup"],[1,"language-bash"],["appAnchor","","id","generation"],["rel","nofollow","target","_blank","href","https://compodoc.app/guides/usage.html"],["rel","nofollow","target","_blank","href","http://localhost:8080"],["src","/assets/documentation-compodoc-1.jpg"],["src","/assets/documentation-compodoc-2.jpg"],["appAnchor","","id","contribute"],["rel","nofollow","target","_blank","href","https://github.com/compodoc/compodoc"]],template:function(n,o){1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"Documentation"),e.qZA(),e.TgZ(7,"p")(8,"strong"),e._uU(9,"Compodoc"),e.qZA(),e._uU(10," is a documentation tool for Angular applications. Since Nest and Angular share similar project and code structures, "),e.TgZ(11,"strong"),e._uU(12,"Compodoc"),e.qZA(),e._uU(13," works with Nest applications as well."),e.qZA(),e.TgZ(14,"h4",6)(15,"span"),e._uU(16,"Setup"),e.qZA()(),e.TgZ(17,"p"),e._uU(18,"Setting up Compodoc inside an existing Nest project is very simple. Start by adding the dev-dependency with the following command in your OS terminal:"),e.qZA(),e.TgZ(19,"pre")(20,"code",7),e._uU(21,"\n$ npm i -D @compodoc/compodoc\n"),e.qZA()(),e.TgZ(22,"h4",8)(23,"span"),e._uU(24,"Generation"),e.qZA()(),e.TgZ(25,"p"),e._uU(26,"Generate project documentation using the following command (npm 6 is required for "),e.TgZ(27,"code"),e._uU(28,"npx"),e.qZA(),e._uU(29," support). See "),e.TgZ(30,"a",9),e._uU(31,"the official documentation"),e.qZA(),e._uU(32," for more options."),e.qZA(),e.TgZ(33,"pre")(34,"code",7),e._uU(35,"\n$ npx @compodoc/compodoc -p tsconfig.json -s\n"),e.qZA()(),e.TgZ(36,"p"),e._uU(37,"Open your browser and navigate to "),e.TgZ(38,"a",10),e._uU(39,"http://localhost:8080"),e.qZA(),e._uU(40,". You should see an initial Nest CLI project:"),e.qZA(),e.TgZ(41,"figure"),e._UZ(42,"img",11),e.qZA(),e.TgZ(43,"figure"),e._UZ(44,"img",12),e.qZA(),e.TgZ(45,"h4",13)(46,"span"),e._uU(47,"Contribute"),e.qZA()(),e.TgZ(48,"p"),e._uU(49,"You can participate and contribute to the Compodoc project "),e.TgZ(50,"a",14),e._uU(51,"here"),e.qZA(),e._uU(52,"."),e.qZA()())},dependencies:[d.U],encapsulation:2,changeDetection:0}));class w extends l.y{}(0,s.Z)(w,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(w)))(o||w)}}()),(0,s.Z)(w,"\u0275cmp",e.Xpm({type:w,selectors:[["app-hot-reload"]],features:[e.qOj],decls:246,vars:4,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/hot-reload.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","hot-reload"],["rel","nofollow","target","_blank","href","https://github.com/webpack/webpack"],[1,"warning"],["id","with-cli"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/cli/overview"],["appAnchor","","id","installation"],[1,"language-bash"],[1,"info"],["appAnchor","","id","configuration"],[1,"language-typescript"],["appAnchor","","id","hot-module-replacement"],[1,"language-json"],["id","without-cli"],["appAnchor","","id","installation-1"],["appAnchor","","id","configuration-1"],["appAnchor","","id","hot-module-replacement-1"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/08-webpack"]],template:function(n,o){1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"Hot Reload"),e.qZA(),e.TgZ(7,"p"),e._uU(8,"The highest impact on your application's bootstrapping process is "),e.TgZ(9,"strong"),e._uU(10,"TypeScript compilation"),e.qZA(),e._uU(11,". Fortunately, with "),e.TgZ(12,"a",6),e._uU(13,"webpack"),e.qZA(),e._uU(14," HMR (Hot-Module Replacement), we don't need to recompile the entire project each time a change occurs. This significantly decreases the amount of time necessary to instantiate your application, and makes iterative development a lot easier."),e.qZA(),e.TgZ(15,"blockquote",7)(16,"strong"),e._uU(17,"Warning"),e.qZA(),e._uU(18," Note that "),e.TgZ(19,"code"),e._uU(20,"webpack"),e.qZA(),e._uU(21," won't automatically copy your assets (e.g. "),e.TgZ(22,"code"),e._uU(23,"graphql"),e.qZA(),e._uU(24," files) to the "),e.TgZ(25,"code"),e._uU(26,"dist"),e.qZA(),e._uU(27," folder. Similarly, "),e.TgZ(28,"code"),e._uU(29,"webpack"),e.qZA(),e._uU(30," is not compatible with glob static paths (e.g., the "),e.TgZ(31,"code"),e._uU(32,"entities"),e.qZA(),e._uU(33," property in "),e.TgZ(34,"code"),e._uU(35,"TypeOrmModule"),e.qZA(),e._uU(36,").\n"),e.qZA(),e.TgZ(37,"h3",8),e._uU(38,"With CLI"),e.qZA(),e.TgZ(39,"p"),e._uU(40,"If you are using the "),e.TgZ(41,"a",9),e._uU(42,"Nest CLI"),e.qZA(),e._uU(43,", the configuration process is pretty straightforward. The CLI wraps "),e.TgZ(44,"code"),e._uU(45,"webpack"),e.qZA(),e._uU(46,", which allows use of the "),e.TgZ(47,"code"),e._uU(48,"HotModuleReplacementPlugin"),e.qZA(),e._uU(49,"."),e.qZA(),e.TgZ(50,"h4",10)(51,"span"),e._uU(52,"Installation"),e.qZA()(),e.TgZ(53,"p"),e._uU(54,"First install the required packages:"),e.qZA(),e.TgZ(55,"pre")(56,"code",11),e._uU(57,"\n$ npm i --save-dev webpack-node-externals run-script-webpack-plugin webpack\n"),e.qZA()(),e.TgZ(58,"blockquote",12)(59,"strong"),e._uU(60,"Hint"),e.qZA(),e._uU(61," If you use "),e.TgZ(62,"strong"),e._uU(63,"Yarn Berry"),e.qZA(),e._uU(64," (not classic Yarn), install the "),e.TgZ(65,"code"),e._uU(66,"webpack-pnp-externals"),e.qZA(),e._uU(67," package instead of the "),e.TgZ(68,"code"),e._uU(69,"webpack-node-externals"),e.qZA(),e._uU(70,".\n"),e.qZA(),e.TgZ(71,"h4",13)(72,"span"),e._uU(73,"Configuration"),e.qZA()(),e.TgZ(74,"p"),e._uU(75,"Once the installation is complete, create a "),e.TgZ(76,"code"),e._uU(77,"webpack-hmr.config.js"),e.qZA(),e._uU(78," file in the root directory of your application."),e.qZA(),e.TgZ(79,"pre")(80,"code",14),e._uU(81,"\nconst nodeExternals = require('webpack-node-externals');\nconst { RunScriptWebpackPlugin } = require('run-script-webpack-plugin');\n\nmodule.exports = function (options, webpack) {\n  return {\n    ...options,\n    entry: ['webpack/hot/poll?100', options.entry],\n    externals: [\n      nodeExternals({\n        allowlist: ['webpack/hot/poll?100'],\n      }),\n    ],\n    plugins: [\n      ...options.plugins,\n      new webpack.HotModuleReplacementPlugin(),\n      new webpack.WatchIgnorePlugin({\n        paths: [/\\.js$/, /\\.d\\.ts$/],\n      }),\n      new RunScriptWebpackPlugin({ name: options.output.filename, autoRestart: false }),\n    ],\n  };\n};\n"),e.qZA()(),e.TgZ(82,"blockquote",12)(83,"strong"),e._uU(84,"Hint"),e.qZA(),e._uU(85," With "),e.TgZ(86,"strong"),e._uU(87,"Yarn Berry"),e.qZA(),e._uU(88," (not classic Yarn), instead of using the "),e.TgZ(89,"code"),e._uU(90,"nodeExternals"),e.qZA(),e._uU(91," in the "),e.TgZ(92,"code"),e._uU(93,"externals"),e.qZA(),e._uU(94," configuration property, use the "),e.TgZ(95,"code"),e._uU(96,"WebpackPnpExternals"),e.qZA(),e._uU(97," from "),e.TgZ(98,"code"),e._uU(99,"webpack-pnp-externals"),e.qZA(),e._uU(100," package: "),e.TgZ(101,"code"),e._uU(102),e.qZA(),e._uU(103,".\n"),e.qZA(),e.TgZ(104,"p"),e._uU(105,"This function takes the original object containing the default webpack configuration as a first argument, and the reference to the underlying "),e.TgZ(106,"code"),e._uU(107,"webpack"),e.qZA(),e._uU(108," package used by the Nest CLI as the second one. Also, it returns a modified webpack configuration with the "),e.TgZ(109,"code"),e._uU(110,"HotModuleReplacementPlugin"),e.qZA(),e._uU(111,", "),e.TgZ(112,"code"),e._uU(113,"WatchIgnorePlugin"),e.qZA(),e._uU(114,", and "),e.TgZ(115,"code"),e._uU(116,"RunScriptWebpackPlugin"),e.qZA(),e._uU(117," plugins."),e.qZA(),e.TgZ(118,"h4",15)(119,"span"),e._uU(120,"Hot-Module Replacement"),e.qZA()(),e.TgZ(121,"p"),e._uU(122,"To enable "),e.TgZ(123,"strong"),e._uU(124,"HMR"),e.qZA(),e._uU(125,", open the application entry file ("),e.TgZ(126,"code"),e._uU(127,"main.ts"),e.qZA(),e._uU(128,") and add the following webpack-related instructions:"),e.qZA(),e.TgZ(129,"pre")(130,"code",14),e._uU(131,"\ndeclare const module: any;\n\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule);\n  await app.listen(3000);\n\n  if (module.hot) {\n    module.hot.accept();\n    module.hot.dispose(() => app.close());\n  }\n}\nbootstrap();\n"),e.qZA()(),e.TgZ(132,"p"),e._uU(133,"To simplify the execution process, add a script to your "),e.TgZ(134,"code"),e._uU(135,"package.json"),e.qZA(),e._uU(136," file."),e.qZA(),e.TgZ(137,"pre")(138,"code",16),e._uU(139,'\n"start:dev": "nest build --webpack --webpackPath webpack-hmr.config.js --watch"\n'),e.qZA()(),e.TgZ(140,"p"),e._uU(141,"Now simply open your command line and run the following command:"),e.qZA(),e.TgZ(142,"pre")(143,"code",11),e._uU(144,"\n$ npm run start:dev\n"),e.qZA()(),e.TgZ(145,"h3",17),e._uU(146,"Without CLI"),e.qZA(),e.TgZ(147,"p"),e._uU(148,"If you are not using the "),e.TgZ(149,"a",9),e._uU(150,"Nest CLI"),e.qZA(),e._uU(151,", the configuration will be slightly more complex (will require more manual steps)."),e.qZA(),e.TgZ(152,"h4",18)(153,"span"),e._uU(154,"Installation"),e.qZA()(),e.TgZ(155,"p"),e._uU(156,"First install the required packages:"),e.qZA(),e.TgZ(157,"pre")(158,"code",11),e._uU(159,"\n$ npm i --save-dev webpack webpack-cli webpack-node-externals ts-loader run-script-webpack-plugin\n"),e.qZA()(),e.TgZ(160,"blockquote",12)(161,"strong"),e._uU(162,"Hint"),e.qZA(),e._uU(163," If you use "),e.TgZ(164,"strong"),e._uU(165,"Yarn Berry"),e.qZA(),e._uU(166," (not classic Yarn), install the "),e.TgZ(167,"code"),e._uU(168,"webpack-pnp-externals"),e.qZA(),e._uU(169," package instead of the "),e.TgZ(170,"code"),e._uU(171,"webpack-node-externals"),e.qZA(),e._uU(172,".\n"),e.qZA(),e.TgZ(173,"h4",19)(174,"span"),e._uU(175,"Configuration"),e.qZA()(),e.TgZ(176,"p"),e._uU(177,"Once the installation is complete, create a "),e.TgZ(178,"code"),e._uU(179,"webpack.config.js"),e.qZA(),e._uU(180," file in the root directory of your application."),e.qZA(),e.TgZ(181,"pre")(182,"code",14),e._uU(183,"\nconst webpack = require('webpack');\nconst path = require('path');\nconst nodeExternals = require('webpack-node-externals');\nconst { RunScriptWebpackPlugin } = require('run-script-webpack-plugin');\n\nmodule.exports = {\n  entry: ['webpack/hot/poll?100', './src/main.ts'],\n  target: 'node',\n  externals: [\n    nodeExternals({\n      allowlist: ['webpack/hot/poll?100'],\n    }),\n  ],\n  module: {\n    rules: [\n      {\n        test: /.tsx?$/,\n        use: 'ts-loader',\n        exclude: /node_modules/,\n      },\n    ],\n  },\n  mode: 'development',\n  resolve: {\n    extensions: ['.tsx', '.ts', '.js'],\n  },\n  plugins: [\n    new webpack.HotModuleReplacementPlugin(),\n    new RunScriptWebpackPlugin({ name: 'server.js', autoRestart: false }),\n  ],\n  output: {\n    path: path.join(__dirname, 'dist'),\n    filename: 'server.js',\n  },\n};\n"),e.qZA()(),e.TgZ(184,"blockquote",12)(185,"strong"),e._uU(186,"Hint"),e.qZA(),e._uU(187," With "),e.TgZ(188,"strong"),e._uU(189,"Yarn Berry"),e.qZA(),e._uU(190," (not classic Yarn), instead of using the "),e.TgZ(191,"code"),e._uU(192,"nodeExternals"),e.qZA(),e._uU(193," in the "),e.TgZ(194,"code"),e._uU(195,"externals"),e.qZA(),e._uU(196," configuration property, use the "),e.TgZ(197,"code"),e._uU(198,"WebpackPnpExternals"),e.qZA(),e._uU(199," from "),e.TgZ(200,"code"),e._uU(201,"webpack-pnp-externals"),e.qZA(),e._uU(202," package: "),e.TgZ(203,"code"),e._uU(204),e.qZA(),e._uU(205,".\n"),e.qZA(),e.TgZ(206,"p"),e._uU(207,"This configuration tells webpack a few essential things about your application: location of the entry file, which directory should be used to hold "),e.TgZ(208,"strong"),e._uU(209,"compiled"),e.qZA(),e._uU(210," files, and what kind of loader we want to use to compile source files. Generally, you should be able to use this file as-is, even if you don't fully understand all of the options."),e.qZA(),e.TgZ(211,"h4",20)(212,"span"),e._uU(213,"Hot-Module Replacement"),e.qZA()(),e.TgZ(214,"p"),e._uU(215,"To enable "),e.TgZ(216,"strong"),e._uU(217,"HMR"),e.qZA(),e._uU(218,", open the application entry file ("),e.TgZ(219,"code"),e._uU(220,"main.ts"),e.qZA(),e._uU(221,") and add the following webpack-related instructions:"),e.qZA(),e.TgZ(222,"pre")(223,"code",14),e._uU(224,"\ndeclare const module: any;\n\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule);\n  await app.listen(3000);\n\n  if (module.hot) {\n    module.hot.accept();\n    module.hot.dispose(() => app.close());\n  }\n}\nbootstrap();\n"),e.qZA()(),e.TgZ(225,"p"),e._uU(226,"To simplify the execution process, add a script to your "),e.TgZ(227,"code"),e._uU(228,"package.json"),e.qZA(),e._uU(229," file."),e.qZA(),e.TgZ(230,"pre")(231,"code",16),e._uU(232,'\n"start:dev": "webpack --config webpack.config.js --watch"\n'),e.qZA()(),e.TgZ(233,"p"),e._uU(234,"Now simply open your command line and run the following command:"),e.qZA(),e.TgZ(235,"pre")(236,"code",11),e._uU(237,"\n$ npm run start:dev\n"),e.qZA()(),e.TgZ(238,"h4",21)(239,"span"),e._uU(240,"Example"),e.qZA()(),e.TgZ(241,"p"),e._uU(242,"A working example is available "),e.TgZ(243,"a",22),e._uU(244,"here"),e.qZA(),e._uU(245,"."),e.qZA()()),2&n&&(e.xp6(102),e.AsE("WebpackPnpExternals(","{"," exclude: ['webpack/hot/poll?100'] ","}",")"),e.xp6(102),e.AsE("WebpackPnpExternals(","{"," exclude: ['webpack/hot/poll?100'] ","}",")"))},dependencies:[d.U],encapsulation:2,changeDetection:0}));class v extends l.y{}(0,s.Z)(v,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(v)))(o||v)}}()),(0,s.Z)(v,"\u0275cmp",e.Xpm({type:v,selectors:[["app-mikroorm"]],features:[e.qOj],decls:347,vars:0,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/mikroorm.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","mikroorm"],["rel","nofollow","target","_blank","href","https://mikro-orm.io/docs"],[1,"info"],["rel","nofollow","target","_blank","href","https://github.com/mikro-orm/nestjs"],["appAnchor","","id","installation"],[1,"language-bash"],["rel","nofollow","target","_blank","href","https://mikro-orm.io/docs/usage-with-sql/"],[1,"language-typescript"],["rel","nofollow","target","_blank","href","https://mikro-orm.io/docs/configuration"],["rel","nofollow","target","_blank","href","https://mikro-orm.io/docs/installation#setting-up-the-commandline-tool"],[1,"language-ts"],["appAnchor","","id","repositories"],["rel","nofollow","target","_blank","href","https://mikro-orm.io/docs/repositories"],["appAnchor","","id","using-custom-repositories"],["appAnchor","","id","load-entities-automatically"],["appAnchor","","id","serialization"],[1,"warning"],["href","/techniques/serialization"],["rel","nofollow","target","_blank","href","https://mikro-orm.io/docs/serializing"],["appAnchor","","id","request-scoped-handlers-in-queues"],["rel","nofollow","target","_blank","href","https://mikro-orm.io/docs/identity-map"],["appAnchor","","id","using-asynclocalstorage-for-request-context"],["appAnchor","","id","testing"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/mikro-orm/nestjs-realworld-example-app"]],template:function(n,o){1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"MikroORM"),e.qZA(),e.TgZ(7,"p"),e._uU(8,"This recipe is here to help users getting started with MikroORM in Nest. MikroORM is the TypeScript ORM for Node.js based on Data Mapper, Unit of Work and Identity Map patterns. It is a great alternative to TypeORM and migration from TypeORM should be fairly easy. The complete documentation on MikroORM can be found "),e.TgZ(9,"a",6),e._uU(10,"here"),e.qZA(),e._uU(11,"."),e.qZA(),e.TgZ(12,"blockquote",7)(13,"strong"),e._uU(14,"info"),e.qZA(),e.TgZ(15,"code"),e._uU(16,"@mikro-orm/nestjs"),e.qZA(),e._uU(17," is a third party package and is not managed by the NestJS core team. Please, report any issues found with the library in the "),e.TgZ(18,"a",8),e._uU(19,"appropriate repository"),e.qZA(),e._uU(20,".\n"),e.qZA(),e.TgZ(21,"h4",9)(22,"span"),e._uU(23,"Installation"),e.qZA()(),e.TgZ(24,"p"),e._uU(25,"Easiest way to integrate MikroORM to Nest is via "),e.TgZ(26,"a",8)(27,"code"),e._uU(28,"@mikro-orm/nestjs"),e.qZA(),e._uU(29," module"),e.qZA(),e._uU(30,".\nSimply install it next to Nest, MikroORM and underlying driver:"),e.qZA(),e.TgZ(31,"pre")(32,"code",10),e._uU(33,"\n$ npm i @mikro-orm/core @mikro-orm/nestjs @mikro-orm/mysql # for mysql/mariadb\n"),e.qZA()(),e.TgZ(34,"p"),e._uU(35,"MikroORM also supports "),e.TgZ(36,"code"),e._uU(37,"postgres"),e.qZA(),e._uU(38,", "),e.TgZ(39,"code"),e._uU(40,"sqlite"),e.qZA(),e._uU(41,", and "),e.TgZ(42,"code"),e._uU(43,"mongo"),e.qZA(),e._uU(44,". See the "),e.TgZ(45,"a",11),e._uU(46,"official docs"),e.qZA(),e._uU(47," for all drivers."),e.qZA(),e.TgZ(48,"p"),e._uU(49,"Once the installation process is completed, we can import the "),e.TgZ(50,"code"),e._uU(51,"MikroOrmModule"),e.qZA(),e._uU(52," into the root "),e.TgZ(53,"code"),e._uU(54,"AppModule"),e.qZA(),e._uU(55,"."),e.qZA(),e.TgZ(56,"pre")(57,"code",12),e._uU(58,"\n@Module({\n  imports: [\n    MikroOrmModule.forRoot({\n      entities: ['./dist/entities'],\n      entitiesTs: ['./src/entities'],\n      dbName: 'my-db-name.sqlite3',\n      type: 'sqlite',\n    }),\n  ],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule {}\n"),e.qZA()(),e.TgZ(59,"p"),e._uU(60,"The "),e.TgZ(61,"code"),e._uU(62,"forRoot()"),e.qZA(),e._uU(63," method accepts the same configuration object as "),e.TgZ(64,"code"),e._uU(65,"init()"),e.qZA(),e._uU(66," from the MikroORM package. Check "),e.TgZ(67,"a",13),e._uU(68,"this page"),e.qZA(),e._uU(69," for the complete configuration documentation."),e.qZA(),e.TgZ(70,"p"),e._uU(71,"Alternatively we can "),e.TgZ(72,"a",14),e._uU(73,"configure the CLI"),e.qZA(),e._uU(74," by creating a configuration file "),e.TgZ(75,"code"),e._uU(76,"mikro-orm.config.ts"),e.qZA(),e._uU(77," and then call the "),e.TgZ(78,"code"),e._uU(79,"forRoot()"),e.qZA(),e._uU(80," without any arguments. This won't work when you use a build tools that use tree shaking."),e.qZA(),e.TgZ(81,"pre")(82,"code",12),e._uU(83,"\n@Module({\n  imports: [\n    MikroOrmModule.forRoot(),\n  ],\n  ...\n})\nexport class AppModule {}\n"),e.qZA()(),e.TgZ(84,"p"),e._uU(85,"Afterward, the "),e.TgZ(86,"code"),e._uU(87,"EntityManager"),e.qZA(),e._uU(88," will be available to inject across entire project (without importing any module elsewhere)."),e.qZA(),e.TgZ(89,"pre")(90,"code",15),e._uU(91,"\nimport { MikroORM } from '@mikro-orm/core';\n// Import EntityManager from your driver package or `@mikro-orm/knex`\nimport { EntityManager } from '@mikro-orm/mysql';\n\n@Injectable()\nexport class MyService {\n  constructor(\n    private readonly orm: MikroORM,\n    private readonly em: EntityManager,\n  ) {}\n}\n"),e.qZA()(),e.TgZ(92,"blockquote",7)(93,"strong"),e._uU(94,"info"),e.qZA(),e._uU(95," Notice that the "),e.TgZ(96,"code"),e._uU(97,"EntityManager"),e.qZA(),e._uU(98," is imported from the "),e.TgZ(99,"code"),e._uU(100,"@mikro-orm/driver"),e.qZA(),e._uU(101," package, where driver is "),e.TgZ(102,"code"),e._uU(103,"mysql"),e.qZA(),e._uU(104,", "),e.TgZ(105,"code"),e._uU(106,"sqlite"),e.qZA(),e._uU(107,", "),e.TgZ(108,"code"),e._uU(109,"postgres"),e.qZA(),e._uU(110," or what driver you are using. In case you have "),e.TgZ(111,"code"),e._uU(112,"@mikro-orm/knex"),e.qZA(),e._uU(113," installed as a dependency, you can also import the "),e.TgZ(114,"code"),e._uU(115,"EntityManager"),e.qZA(),e._uU(116," from there.\n"),e.qZA(),e.TgZ(117,"h4",16)(118,"span"),e._uU(119,"Repositories"),e.qZA()(),e.TgZ(120,"p"),e._uU(121,"MikroORM supports the repository design pattern. For every entity we can create a repository. Read the complete documentation on repositories "),e.TgZ(122,"a",17),e._uU(123,"here"),e.qZA(),e._uU(124,". To define which repositories should be registered in the current scope you can use the "),e.TgZ(125,"code"),e._uU(126,"forFeature()"),e.qZA(),e._uU(127," method. For example, in this way:"),e.qZA(),e.TgZ(128,"blockquote",7)(129,"strong"),e._uU(130,"info"),e.qZA(),e._uU(131," You should "),e.TgZ(132,"strong"),e._uU(133,"not"),e.qZA(),e._uU(134," register your base entities via "),e.TgZ(135,"code"),e._uU(136,"forFeature()"),e.qZA(),e._uU(137,", as there are no\nrepositories for those. On the other hand, base entities need to be part of the list in "),e.TgZ(138,"code"),e._uU(139,"forRoot()"),e.qZA(),e._uU(140," (or in the ORM config in general).\n"),e.qZA(),e.TgZ(141,"pre")(142,"code",12),e._uU(143,"\n// photo.module.ts\n@Module({\n  imports: [MikroOrmModule.forFeature([Photo])],\n  providers: [PhotoService],\n  controllers: [PhotoController],\n})\nexport class PhotoModule {}\n"),e.qZA()(),e.TgZ(144,"p"),e._uU(145,"and import it into the root "),e.TgZ(146,"code"),e._uU(147,"AppModule"),e.qZA(),e._uU(148,":"),e.qZA(),e.TgZ(149,"pre")(150,"code",12),e._uU(151,"\n// app.module.ts\n@Module({\n  imports: [MikroOrmModule.forRoot(...), PhotoModule],\n})\nexport class AppModule {}\n"),e.qZA()(),e.TgZ(152,"p"),e._uU(153,"In this way we can inject the "),e.TgZ(154,"code"),e._uU(155,"PhotoRepository"),e.qZA(),e._uU(156," to the "),e.TgZ(157,"code"),e._uU(158,"PhotoService"),e.qZA(),e._uU(159," using the "),e.TgZ(160,"code"),e._uU(161,"@InjectRepository()"),e.qZA(),e._uU(162," decorator:"),e.qZA(),e.TgZ(163,"pre")(164,"code",12),e._uU(165,"\n@Injectable()\nexport class PhotoService {\n  constructor(\n    @InjectRepository(Photo)\n    private readonly photoRepository: EntityRepository<Photo>,\n  ) {}\n}\n"),e.qZA()(),e.TgZ(166,"h4",18)(167,"span"),e._uU(168,"Using custom repositories"),e.qZA()(),e.TgZ(169,"p"),e._uU(170,"When using custom repositories, we can get around the need for "),e.TgZ(171,"code"),e._uU(172,"@InjectRepository()"),e.qZA(),e._uU(173,"\ndecorator by naming our repositories the same way as "),e.TgZ(174,"code"),e._uU(175,"getRepositoryToken()"),e.qZA(),e._uU(176," method do:"),e.qZA(),e.TgZ(177,"pre")(178,"code",15),e._uU(179,"\nexport const getRepositoryToken = <T>(entity: EntityName<T>) =>\n  `${Utils.className(entity)}Repository`;\n"),e.qZA()(),e.TgZ(180,"p"),e._uU(181,"In other words, as long as we name the repository same was as the entity is called,\nappending "),e.TgZ(182,"code"),e._uU(183,"Repository"),e.qZA(),e._uU(184," suffix, the repository will be registered automatically in\nthe Nest DI container."),e.qZA(),e.TgZ(185,"pre")(186,"code",15),e._uU(187,"\n// `**./author.entity.ts**`\n@Entity()\nexport class Author {\n  // to allow inference in `em.getRepository()`\n  [EntityRepositoryType]?: AuthorRepository;\n}\n\n// `**./author.repository.ts**`\n@Repository(Author)\nexport class AuthorRepository extends EntityRepository<Author> {\n  // your custom methods...\n}\n"),e.qZA()(),e.TgZ(188,"p"),e._uU(189,"As the custom repository name is the same as what "),e.TgZ(190,"code"),e._uU(191,"getRepositoryToken()"),e.qZA(),e._uU(192," would\nreturn, we do not need the "),e.TgZ(193,"code"),e._uU(194,"@InjectRepository()"),e.qZA(),e._uU(195," decorator anymore:"),e.qZA(),e.TgZ(196,"pre")(197,"code",15),e._uU(198,"\n@Injectable()\nexport class MyService {\n  constructor(private readonly repo: AuthorRepository) {}\n}\n"),e.qZA()(),e.TgZ(199,"h4",19)(200,"span"),e._uU(201,"Load entities automatically"),e.qZA()(),e.TgZ(202,"blockquote",7)(203,"strong"),e._uU(204,"info"),e.qZA(),e.TgZ(205,"code"),e._uU(206,"autoLoadEntities"),e.qZA(),e._uU(207," option was added in v4.1.0\n"),e.qZA(),e.TgZ(208,"p"),e._uU(209,"Manually adding entities to the entities array of the connection options can be\ntedious. In addition, referencing entities from the root module breaks application\ndomain boundaries and causes leaking implementation details to other parts of the\napplication. To solve this issue, static glob paths can be used."),e.qZA(),e.TgZ(210,"p"),e._uU(211,"Note, however, that glob paths are not supported by webpack, so if you are building\nyour application within a monorepo, you won't be able to use them. To address this\nissue, an alternative solution is provided. To automatically load entities, set the\n"),e.TgZ(212,"code"),e._uU(213,"autoLoadEntities"),e.qZA(),e._uU(214," property of the configuration object (passed into the "),e.TgZ(215,"code"),e._uU(216,"forRoot()"),e.qZA(),e._uU(217,"\nmethod) to "),e.TgZ(218,"code"),e._uU(219,"true"),e.qZA(),e._uU(220,", as shown below:"),e.qZA(),e.TgZ(221,"pre")(222,"code",15),e._uU(223,"\n@Module({\n  imports: [\n    MikroOrmModule.forRoot({\n      ...\n      autoLoadEntities: true,\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.qZA()(),e.TgZ(224,"p"),e._uU(225,"With that option specified, every entity registered through the "),e.TgZ(226,"code"),e._uU(227,"forFeature()"),e.qZA(),e._uU(228,"\nmethod will be automatically added to the entities array of the configuration\nobject."),e.qZA(),e.TgZ(229,"blockquote",7)(230,"strong"),e._uU(231,"info"),e.qZA(),e._uU(232," Note that entities that aren't registered through the "),e.TgZ(233,"code"),e._uU(234,"forFeature()"),e.qZA(),e._uU(235," method, but\nare only referenced from the entity (via a relationship), won't be included by\nway of the "),e.TgZ(236,"code"),e._uU(237,"autoLoadEntities"),e.qZA(),e._uU(238," setting.\n"),e.qZA(),e.TgZ(239,"blockquote",7)(240,"strong"),e._uU(241,"info"),e.qZA(),e._uU(242," Using "),e.TgZ(243,"code"),e._uU(244,"autoLoadEntities"),e.qZA(),e._uU(245," also has no effect on the MikroORM CLI - for that we\nstill need CLI config with the full list of entities. On the other hand, we can\nuse globs there, as the CLI won't go thru webpack.\n"),e.qZA(),e.TgZ(246,"h4",20)(247,"span"),e._uU(248,"Serialization"),e.qZA()(),e.TgZ(249,"blockquote",21)(250,"strong"),e._uU(251,"Note"),e.qZA(),e._uU(252," MikroORM wraps every single entity relation in a "),e.TgZ(253,"code"),e._uU(254,"Reference<T>"),e.qZA(),e._uU(255," or a "),e.TgZ(256,"code"),e._uU(257,"Collection<T>"),e.qZA(),e._uU(258," object, in order to provide better type-safety. This will make "),e.TgZ(259,"a",22),e._uU(260,"Nest's built-in serializer"),e.qZA(),e._uU(261," blind to any wrapped relations. In other words, if you return MikroORM entities from your HTTP or WebSocket handlers, all of their relations will NOT be serialized.\n"),e.qZA(),e.TgZ(262,"p"),e._uU(263,"Luckily, MikroORM provides a "),e.TgZ(264,"a",23),e._uU(265,"serialization API"),e.qZA(),e._uU(266," which can be used in lieu of "),e.TgZ(267,"code"),e._uU(268,"ClassSerializerInterceptor"),e.qZA(),e._uU(269,"."),e.qZA(),e.TgZ(270,"pre")(271,"code",12),e._uU(272,"\n@Entity()\nexport class Book {\n  @Property({ hidden: true }) // Equivalent of class-transformer's `@Exclude`\n  hiddenField = Date.now();\n\n  @Property({ persist: false }) // Similar to class-transformer's `@Expose()`. Will only exist in memory, and will be serialized.\n  count?: number;\n\n  @ManyToOne({\n    serializer: (value) => value.name,\n    serializedName: 'authorName',\n  }) // Equivalent of class-transformer's `@Transform()`\n  author: Author;\n}\n"),e.qZA()(),e.TgZ(273,"h4",24)(274,"span"),e._uU(275,"Request scoped handlers in queues"),e.qZA()(),e.TgZ(276,"blockquote",7)(277,"strong"),e._uU(278,"info"),e.qZA(),e.TgZ(279,"code"),e._uU(280,"@UseRequestContext()"),e.qZA(),e._uU(281," decorator was added in v4.1.0\n"),e.qZA(),e.TgZ(282,"p"),e._uU(283,"As mentioned in the "),e.TgZ(284,"a",25),e._uU(285,"docs"),e.qZA(),e._uU(286,", we need a clean state for each request. That is handled automatically thanks to the "),e.TgZ(287,"code"),e._uU(288,"RequestContext"),e.qZA(),e._uU(289," helper registered via middleware."),e.qZA(),e.TgZ(290,"p"),e._uU(291,"But middlewares are executed only for regular HTTP request handles, what if we need\na request scoped method outside of that? One example of that is queue handlers or\nscheduled tasks."),e.qZA(),e.TgZ(292,"p"),e._uU(293,"We can use the "),e.TgZ(294,"code"),e._uU(295,"@UseRequestContext()"),e.qZA(),e._uU(296," decorator. It requires you to first inject the\n"),e.TgZ(297,"code"),e._uU(298,"MikroORM"),e.qZA(),e._uU(299," instance to current context, it will be then used to create the context\nfor you. Under the hood, the decorator will register new request context for your\nmethod and execute it inside the context."),e.qZA(),e.TgZ(300,"pre")(301,"code",15),e._uU(302,"\n@Injectable()\nexport class MyService {\n  constructor(private readonly orm: MikroORM) {}\n\n  @UseRequestContext()\n  async doSomething() {\n    // this will be executed in a separate context\n  }\n}\n"),e.qZA()(),e.TgZ(303,"h4",26)(304,"span"),e._uU(305,"Using "),e.TgZ(306,"code"),e._uU(307,"AsyncLocalStorage"),e.qZA(),e._uU(308," for request context"),e.qZA()(),e.TgZ(309,"p"),e._uU(310,"By default, the "),e.TgZ(311,"code"),e._uU(312,"domain"),e.qZA(),e._uU(313," api is used in the "),e.TgZ(314,"code"),e._uU(315,"RequestContext"),e.qZA(),e._uU(316," helper. Since "),e.TgZ(317,"code"),e._uU(318,"@mikro-orm/core@4.0.3"),e.qZA(),e._uU(319,",\nyou can use the new "),e.TgZ(320,"code"),e._uU(321,"AsyncLocalStorage"),e.qZA(),e._uU(322," too, if you are on up to date node version:"),e.qZA(),e.TgZ(323,"pre")(324,"code",12),e._uU(325,"\n// create new (global) storage instance\nconst storage = new AsyncLocalStorage<EntityManager>();\n\n@Module({\n  imports: [\n    MikroOrmModule.forRoot({\n      // ...\n      registerRequestContext: false, // disable automatic middleware\n      context: () => storage.getStore(), // use our AsyncLocalStorage instance\n    }),\n  ],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule {}\n\n// register the request context middleware\nconst app = await NestFactory.create(AppModule, { ... });\nconst orm = app.get(MikroORM);\n\napp.use((req, res, next) => {\n  storage.run(orm.em.fork(true, true), next);\n});\n"),e.qZA()(),e.TgZ(326,"h4",27)(327,"span"),e._uU(328,"Testing"),e.qZA()(),e.TgZ(329,"p"),e._uU(330,"The "),e.TgZ(331,"code"),e._uU(332,"@mikro-orm/nestjs"),e.qZA(),e._uU(333," package exposes "),e.TgZ(334,"code"),e._uU(335,"getRepositoryToken()"),e.qZA(),e._uU(336," function that returns prepared token based on a given entity to allow mocking the repository."),e.qZA(),e.TgZ(337,"pre")(338,"code",12),e._uU(339,"\n@Module({\n  providers: [\n    PhotoService,\n    {\n      provide: getRepositoryToken(Photo),\n      useValue: mockedRepository,\n    },\n  ],\n})\nexport class PhotoModule {}\n"),e.qZA()(),e.TgZ(340,"h4",28)(341,"span"),e._uU(342,"Example"),e.qZA()(),e.TgZ(343,"p"),e._uU(344,"A real world example of NestJS with MikroORM can be found "),e.TgZ(345,"a",29),e._uU(346,"here"),e.qZA()()())},dependencies:[d.U],encapsulation:2,changeDetection:0}));class k extends l.y{}(0,s.Z)(k,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(k)))(o||k)}}()),(0,s.Z)(k,"\u0275cmp",e.Xpm({type:k,selectors:[["app-mongodb"]],features:[e.qOj],decls:234,vars:36,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/mongodb.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","mongodb-mongoose"],[1,""],["routerLink","/techniques/mongodb"],["rel","nofollow","target","_blank","href","https://mongoosejs.com"],["rel","nofollow","target","_blank","href","https://www.mongodb.org/"],["appAnchor","","id","getting-started"],[1,"language-typescript"],["routerLink","/fundamentals/async-components"],[1,"filename"],["appfbe650b10a99f86c5e0fec5063a7d56ea8c294d0",""],[1,"info"],["app8e6e018f2a2898f080b3f8c57a6789188224b157",""],["appAnchor","","id","model-injection"],["rel","nofollow","target","_blank","href","https://mongoosejs.com/docs/guide.html"],["app6a44a62287c867148c5faa9c8ba651da563994c7",""],["appa02bafc52c9b98fb5ecb197ab6e1539bfc728d10",""],[1,"warning"],["app1d889def772406d6d92773cb2e0aeb470a654f57",""],["app5a5f5dc73adddde72618a00fff83c288dd4c7e59",""],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/14-mongoose-base"]],template:function(n,o){if(1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"MongoDB (Mongoose)"),e.qZA(),e.TgZ(7,"blockquote",6)(8,"strong"),e._uU(9,"Warning"),e.qZA(),e._uU(10," In this article, you'll learn how to create a "),e.TgZ(11,"code"),e._uU(12,"DatabaseModule"),e.qZA(),e._uU(13," based on the "),e.TgZ(14,"strong"),e._uU(15,"Mongoose"),e.qZA(),e._uU(16," package from scratch using custom components. As a consequence, this solution contains a lot of overhead that you can omit using ready to use and available out-of-the-box dedicated "),e.TgZ(17,"code"),e._uU(18,"@nestjs/mongoose"),e.qZA(),e._uU(19," package. To learn more, see "),e.TgZ(20,"a",7),e._uU(21,"here"),e.qZA(),e._uU(22,".\n"),e.qZA(),e.TgZ(23,"p")(24,"a",8),e._uU(25,"Mongoose"),e.qZA(),e._uU(26," is the most popular "),e.TgZ(27,"a",9),e._uU(28,"MongoDB"),e.qZA(),e._uU(29," object modeling tool."),e.qZA(),e.TgZ(30,"h4",10)(31,"span"),e._uU(32,"Getting started"),e.qZA()(),e.TgZ(33,"p"),e._uU(34,"To start the adventure with this library we have to install all required dependencies:"),e.qZA(),e.TgZ(35,"pre")(36,"code",11),e._uU(37,"\n$ npm install --save mongoose\n"),e.qZA()(),e.TgZ(38,"p"),e._uU(39,"The first step we need to do is to establish the connection with our database using "),e.TgZ(40,"code"),e._uU(41,"connect()"),e.qZA(),e._uU(42," function. The "),e.TgZ(43,"code"),e._uU(44,"connect()"),e.qZA(),e._uU(45," function returns a "),e.TgZ(46,"code"),e._uU(47,"Promise"),e.qZA(),e._uU(48,", and therefore we have to create an "),e.TgZ(49,"a",12),e._uU(50,"async provider"),e.qZA(),e._uU(51,"."),e.qZA(),e.TgZ(52,"span",13),e._uU(53),e.ALo(54,"extension"),e._UZ(55,"app-tabs",null,14),e.qZA(),e.TgZ(57,"pre")(58,"code",11),e._uU(59,"\nimport * as mongoose from 'mongoose';\n\nexport const databaseProviders = [\n  {\n    provide: 'DATABASE_CONNECTION',\n    useFactory: (): Promise<typeof mongoose> =>\n      mongoose.connect('mongodb://localhost/nest'),\n  },\n];\n"),e.qZA()(),e.TgZ(60,"pre")(61,"code",11),e._uU(62,"\nimport * as mongoose from 'mongoose';\n\nexport const databaseProviders = [\n  {\n    provide: 'DATABASE_CONNECTION',\n    useFactory: () => mongoose.connect('mongodb://localhost/nest'),\n  },\n];\n"),e.qZA()(),e.TgZ(63,"blockquote",15)(64,"strong"),e._uU(65,"Hint"),e.qZA(),e._uU(66," Following best practices, we declared the custom provider in the separated file which has a "),e.TgZ(67,"code"),e._uU(68,"*.providers.ts"),e.qZA(),e._uU(69," suffix.\n"),e.qZA(),e.TgZ(70,"p"),e._uU(71,"Then, we need to export these providers to make them "),e.TgZ(72,"strong"),e._uU(73,"accessible"),e.qZA(),e._uU(74," for the rest part of the application."),e.qZA(),e.TgZ(75,"span",13),e._uU(76),e.ALo(77,"extension"),e._UZ(78,"app-tabs",null,16),e.qZA(),e.TgZ(80,"pre")(81,"code",11),e._uU(82,"\nimport { Module } from '@nestjs/common';\nimport { databaseProviders } from './database.providers';\n\n@Module({\n  providers: [...databaseProviders],\n  exports: [...databaseProviders],\n})\nexport class DatabaseModule {}\n"),e.qZA()(),e.TgZ(83,"p"),e._uU(84,"Now we can inject the "),e.TgZ(85,"code"),e._uU(86,"Connection"),e.qZA(),e._uU(87," object using "),e.TgZ(88,"code"),e._uU(89,"@Inject()"),e.qZA(),e._uU(90," decorator. Each class that would depend on the "),e.TgZ(91,"code"),e._uU(92,"Connection"),e.qZA(),e._uU(93," async provider will wait until a "),e.TgZ(94,"code"),e._uU(95,"Promise"),e.qZA(),e._uU(96," is resolved."),e.qZA(),e.TgZ(97,"h4",17)(98,"span"),e._uU(99,"Model injection"),e.qZA()(),e.TgZ(100,"p"),e._uU(101,"With Mongoose, everything is derived from a "),e.TgZ(102,"a",18),e._uU(103,"Schema"),e.qZA(),e._uU(104,". Let's define the "),e.TgZ(105,"code"),e._uU(106,"CatSchema"),e.qZA(),e._uU(107,":"),e.qZA(),e.TgZ(108,"span",13),e._uU(109),e.ALo(110,"extension"),e._UZ(111,"app-tabs",null,19),e.qZA(),e.TgZ(113,"pre")(114,"code",11),e._uU(115,"\nimport * as mongoose from 'mongoose';\n\nexport const CatSchema = new mongoose.Schema({\n  name: String,\n  age: Number,\n  breed: String,\n});\n"),e.qZA()(),e.TgZ(116,"p"),e._uU(117,"The "),e.TgZ(118,"code"),e._uU(119,"CatsSchema"),e.qZA(),e._uU(120," belongs to the "),e.TgZ(121,"code"),e._uU(122,"cats"),e.qZA(),e._uU(123," directory. This directory represents the "),e.TgZ(124,"code"),e._uU(125,"CatsModule"),e.qZA(),e._uU(126,"."),e.qZA(),e.TgZ(127,"p"),e._uU(128,"Now it's time to create a "),e.TgZ(129,"strong"),e._uU(130,"Model"),e.qZA(),e._uU(131," provider:"),e.qZA(),e.TgZ(132,"span",13),e._uU(133),e.ALo(134,"extension"),e._UZ(135,"app-tabs",null,20),e.qZA(),e.TgZ(137,"pre")(138,"code",11),e._uU(139,"\nimport { Connection } from 'mongoose';\nimport { CatSchema } from './schemas/cat.schema';\n\nexport const catsProviders = [\n  {\n    provide: 'CAT_MODEL',\n    useFactory: (connection: Connection) => connection.model('Cat', CatSchema),\n    inject: ['DATABASE_CONNECTION'],\n  },\n];\n"),e.qZA()(),e.TgZ(140,"pre")(141,"code",11),e._uU(142,"\nimport { CatSchema } from './schemas/cat.schema';\n\nexport const catsProviders = [\n  {\n    provide: 'CAT_MODEL',\n    useFactory: (connection) => connection.model('Cat', CatSchema),\n    inject: ['DATABASE_CONNECTION'],\n  },\n];\n"),e.qZA()(),e.TgZ(143,"blockquote",21)(144,"strong"),e._uU(145,"Warning"),e.qZA(),e._uU(146," In the real-world applications you should avoid "),e.TgZ(147,"strong"),e._uU(148,"magic strings"),e.qZA(),e._uU(149,". Both "),e.TgZ(150,"code"),e._uU(151,"CAT_MODEL"),e.qZA(),e._uU(152," and "),e.TgZ(153,"code"),e._uU(154,"DATABASE_CONNECTION"),e.qZA(),e._uU(155," should be kept in the separated "),e.TgZ(156,"code"),e._uU(157,"constants.ts"),e.qZA(),e._uU(158," file.\n"),e.qZA(),e.TgZ(159,"p"),e._uU(160,"Now we can inject the "),e.TgZ(161,"code"),e._uU(162,"CAT_MODEL"),e.qZA(),e._uU(163," to the "),e.TgZ(164,"code"),e._uU(165,"CatsService"),e.qZA(),e._uU(166," using the "),e.TgZ(167,"code"),e._uU(168,"@Inject()"),e.qZA(),e._uU(169," decorator:"),e.qZA(),e.TgZ(170,"span",13),e._uU(171),e.ALo(172,"extension"),e._UZ(173,"app-tabs",null,22),e.qZA(),e.TgZ(175,"pre")(176,"code",11),e._uU(177,"\nimport { Model } from 'mongoose';\nimport { Injectable, Inject } from '@nestjs/common';\nimport { Cat } from './interfaces/cat.interface';\nimport { CreateCatDto } from './dto/create-cat.dto';\n\n@Injectable()\nexport class CatsService {\n  constructor(\n    @Inject('CAT_MODEL')\n    private catModel: Model<Cat>,\n  ) {}\n\n  async create(createCatDto: CreateCatDto): Promise<Cat> {\n    const createdCat = new this.catModel(createCatDto);\n    return createdCat.save();\n  }\n\n  async findAll(): Promise<Cat[]> {\n    return this.catModel.find().exec();\n  }\n}\n"),e.qZA()(),e.TgZ(178,"pre")(179,"code",11),e._uU(180,"\nimport { Injectable, Dependencies } from '@nestjs/common';\n\n@Injectable()\n@Dependencies('CAT_MODEL')\nexport class CatsService {\n  constructor(catModel) {\n    this.catModel = catModel;\n  }\n\n  async create(createCatDto) {\n    const createdCat = new this.catModel(createCatDto);\n    return createdCat.save();\n  }\n\n  async findAll() {\n    return this.catModel.find().exec();\n  }\n}\n"),e.qZA()(),e.TgZ(181,"p"),e._uU(182,"In the above example we have used the "),e.TgZ(183,"code"),e._uU(184,"Cat"),e.qZA(),e._uU(185," interface. This interface extends the "),e.TgZ(186,"code"),e._uU(187,"Document"),e.qZA(),e._uU(188," from the mongoose package:"),e.qZA(),e.TgZ(189,"pre")(190,"code",11),e._uU(191,"\nimport { Document } from 'mongoose';\n\nexport interface Cat extends Document {\n  readonly name: string;\n  readonly age: number;\n  readonly breed: string;\n}\n"),e.qZA()(),e.TgZ(192,"p"),e._uU(193,"The database connection is "),e.TgZ(194,"strong"),e._uU(195,"asynchronous"),e.qZA(),e._uU(196,", but Nest makes this process completely invisible for the end-user. The "),e.TgZ(197,"code"),e._uU(198,"CatModel"),e.qZA(),e._uU(199," class is waiting for the db connection, and the "),e.TgZ(200,"code"),e._uU(201,"CatsService"),e.qZA(),e._uU(202," is delayed until model is ready to use. The entire application can start when each class is instantiated."),e.qZA(),e.TgZ(203,"p"),e._uU(204,"Here is a final "),e.TgZ(205,"code"),e._uU(206,"CatsModule"),e.qZA(),e._uU(207,":"),e.qZA(),e.TgZ(208,"span",13),e._uU(209),e.ALo(210,"extension"),e._UZ(211,"app-tabs",null,23),e.qZA(),e.TgZ(213,"pre")(214,"code",11),e._uU(215,"\nimport { Module } from '@nestjs/common';\nimport { CatsController } from './cats.controller';\nimport { CatsService } from './cats.service';\nimport { catsProviders } from './cats.providers';\nimport { DatabaseModule } from '../database/database.module';\n\n@Module({\n  imports: [DatabaseModule],\n  controllers: [CatsController],\n  providers: [\n    CatsService,\n    ...catsProviders,\n  ],\n})\nexport class CatsModule {}\n"),e.qZA()(),e.TgZ(216,"blockquote",15)(217,"strong"),e._uU(218,"Hint"),e.qZA(),e._uU(219," Do not forget to import the "),e.TgZ(220,"code"),e._uU(221,"CatsModule"),e.qZA(),e._uU(222," into the root "),e.TgZ(223,"code"),e._uU(224,"AppModule"),e.qZA(),e._uU(225,".\n"),e.qZA(),e.TgZ(226,"h4",24)(227,"span"),e._uU(228,"Example"),e.qZA()(),e.TgZ(229,"p"),e._uU(230,"A working example is available "),e.TgZ(231,"a",25),e._uU(232,"here"),e.qZA(),e._uU(233,"."),e.qZA()()),2&n){const r=e.MAs(56),a=e.MAs(79),u=e.MAs(112),c=e.MAs(136),i=e.MAs(174),p=e.MAs(212);e.xp6(53),e.hij(" ",e.xi3(54,18,"database.providers",r.isJsActive),"\n"),e.xp6(4),e.ekj("hide",r.isJsActive),e.xp6(3),e.ekj("hide",!r.isJsActive),e.xp6(16),e.hij(" ",e.xi3(77,21,"database.module",a.isJsActive),"\n"),e.xp6(33),e.hij(" ",e.xi3(110,24,"schemas/cat.schema",u.isJsActive),"\n"),e.xp6(24),e.hij(" ",e.xi3(134,27,"cats.providers",c.isJsActive),"\n"),e.xp6(4),e.ekj("hide",c.isJsActive),e.xp6(3),e.ekj("hide",!c.isJsActive),e.xp6(31),e.hij(" ",e.xi3(172,30,"cats.service",i.isJsActive),"\n"),e.xp6(4),e.ekj("hide",i.isJsActive),e.xp6(3),e.ekj("hide",!i.isJsActive),e.xp6(31),e.hij(" ",e.xi3(210,33,"cats.module",p.isJsActive),"\n")}},dependencies:[Z.n,d.U,g.rH,m.F],encapsulation:2,changeDetection:0}));class x extends l.y{}(0,s.Z)(x,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(x)))(o||x)}}()),(0,s.Z)(x,"\u0275cmp",e.Xpm({type:x,selectors:[["app-prisma"]],features:[e.qOj],decls:620,vars:0,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/prisma.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","prisma"],["rel","nofollow","target","_blank","href","https://www.prisma.io"],["rel","nofollow","target","_blank","href","https://github.com/prisma/prisma"],["rel","nofollow","target","_blank","href","https://knexjs.org/"],["rel","nofollow","target","_blank","href","https://typeorm.io/"],["rel","nofollow","target","_blank","href","https://sequelize.org/"],["rel","nofollow","target","_blank","href","https://www.prisma.io/docs/reference/database-reference/supported-databases"],["rel","nofollow","target","_blank","href","https://www.prisma.io/docs/concepts/more/comparisons/prisma-and-typeorm#type-safety"],[1,"info"],["rel","nofollow","target","_blank","href","https://www.prisma.io/docs/getting-started/quickstart"],["rel","nofollow","target","_blank","href","https://www.prisma.io/docs/understand-prisma/introduction"],["rel","nofollow","target","_blank","href","https://www.prisma.io/docs/"],["rel","nofollow","target","_blank","href","https://github.com/prisma/prisma-examples/tree/latest/typescript/rest-nestjs"],["rel","nofollow","target","_blank","href","https://github.com/prisma/prisma-examples/tree/latest/typescript/graphql-nestjs"],["rel","nofollow","target","_blank","href","https://github.com/prisma/prisma-examples/"],["appAnchor","","id","getting-started"],["rel","nofollow","target","_blank","href","https://sqlite.org/"],["rel","nofollow","target","_blank","href","https://www.prisma.io/docs/getting-started/setup-prisma/add-to-existing-project-typescript-postgres"],["rel","nofollow","target","_blank","href","https://www.prisma.io/docs/guides/migrate-to-prisma/migrate-from-typeorm"],["appAnchor","","id","create-your-nestjs-project"],[1,"language-bash"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/first-steps"],["appAnchor","","id","set-up-prisma"],["rel","nofollow","target","_blank","href","https://www.prisma.io/docs/reference/tools-and-interfaces/prisma-cli"],["rel","nofollow","target","_blank","href","https://github.com/motdotla/dotenv"],["appAnchor","","id","set-the-database-connection"],[1,"language-groovy"],["rel","nofollow","target","_blank","href","https://www.prisma.io/docs/reference/database-reference/connection-urls"],["rel","nofollow","target","_blank","href","https://dev.to/prisma/how-to-setup-a-free-postgresql-database-on-heroku-1dc1"],["appAnchor","","id","create-two-database-tables-with-prisma-migrate"],["rel","nofollow","target","_blank","href","https://www.prisma.io/docs/concepts/components/prisma-migrate"],[1,"language-sql"],["appAnchor","","id","install-and-generate-prisma-client"],["rel","nofollow","target","_blank","href","https://www.prisma.io/docs/concepts/components/prisma-client/crud"],["appAnchor","","id","use-prisma-client-in-your-nestjs-services"],["rel","nofollow","target","_blank","href","https://www.prisma.io/docs/reference/tools-and-interfaces/prisma-client/crud"],[1,"language-typescript"],["href","recipes/prisma#issues-with-enableshutdownhooks"],["id","implement-your-rest-api-routes-in-the-main-app-controller"],["id","get"],["id","post"],["id","put"],["id","delete"],["appAnchor","","id","issues-with-enableshutdownhooks"],["rel","nofollow","target","_blank","href","https://github.com/prisma/prisma/issues/2917#issuecomment-708340112"],["appAnchor","","id","summary"],["rel","nofollow","target","_blank","href","https://www.prisma.io/nestjs"],["rel","nofollow","target","_blank","href","https://github.com/notiz-dev/nestjs-prisma-starter#instructions"],["rel","nofollow","target","_blank","href","https://www.youtube.com/watch?v=UlVJ340UEuk&ab_channel=Prisma"],["rel","nofollow","target","_blank","href","https://github.com/marcjulian"]],template:function(n,o){1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"Prisma"),e.qZA(),e.TgZ(7,"p")(8,"a",6),e._uU(9,"Prisma"),e.qZA(),e._uU(10," is an "),e.TgZ(11,"a",7),e._uU(12,"open-source"),e.qZA(),e._uU(13," ORM for Node.js and TypeScript. It is used as an "),e.TgZ(14,"strong"),e._uU(15,"alternative"),e.qZA(),e._uU(16," to writing plain SQL, or using another database access tool such as SQL query builders (like "),e.TgZ(17,"a",8),e._uU(18,"knex.js"),e.qZA(),e._uU(19,") or ORMs (like "),e.TgZ(20,"a",9),e._uU(21,"TypeORM"),e.qZA(),e._uU(22," and "),e.TgZ(23,"a",10),e._uU(24,"Sequelize"),e.qZA(),e._uU(25,"). Prisma currently supports PostgreSQL, MySQL, SQL Server, SQLite, MongoDB and CockroachDB ("),e.TgZ(26,"a",11),e._uU(27,"Preview"),e.qZA(),e._uU(28,")."),e.qZA(),e.TgZ(29,"p"),e._uU(30,"While Prisma can be used with plain JavaScript, it embraces TypeScript and provides a level to type-safety that goes beyond the guarantees other ORMs in the TypeScript ecosystem. You can find an in-depth comparison of the type-safety guarantees of Prisma and TypeORM "),e.TgZ(31,"a",12),e._uU(32,"here"),e.qZA(),e._uU(33,"."),e.qZA(),e.TgZ(34,"blockquote",13)(35,"strong"),e._uU(36,"Note"),e.qZA(),e._uU(37," If you want to get a quick overview of how Prisma works, you can follow the "),e.TgZ(38,"a",14),e._uU(39,"Quickstart"),e.qZA(),e._uU(40," or read the "),e.TgZ(41,"a",15),e._uU(42,"Introduction"),e.qZA(),e._uU(43," in the "),e.TgZ(44,"a",16),e._uU(45,"documentation"),e.qZA(),e._uU(46,". There also are ready-to-run examples for "),e.TgZ(47,"a",17),e._uU(48,"REST"),e.qZA(),e._uU(49," and "),e.TgZ(50,"a",18),e._uU(51,"GraphQL"),e.qZA(),e._uU(52," in the "),e.TgZ(53,"a",19)(54,"code"),e._uU(55,"prisma-examples"),e.qZA()(),e._uU(56," repo.\n"),e.qZA(),e.TgZ(57,"h4",20)(58,"span"),e._uU(59,"Getting started"),e.qZA()(),e.TgZ(60,"p"),e._uU(61,"In this recipe, you'll learn how to get started with NestJS and Prisma from scratch. You are going to build a sample NestJS application with a REST API that can read and write data in a database."),e.qZA(),e.TgZ(62,"p"),e._uU(63,"For the purpose of this guide, you'll use a "),e.TgZ(64,"a",21),e._uU(65,"SQLite"),e.qZA(),e._uU(66," database to save the overhead of setting up a database server. Note that you can still follow this guide, even if you're using PostgreSQL or MySQL \u2013 you'll get extra instructions for using these databases at the right places."),e.qZA(),e.TgZ(67,"blockquote",13)(68,"strong"),e._uU(69,"Note"),e.qZA(),e._uU(70," If you already have an existing project and consider migrating to Prisma, you can follow the guide for "),e.TgZ(71,"a",22),e._uU(72,"adding Prisma to an existing project"),e.qZA(),e._uU(73,". If you are migrating from TypeORM, you can read the guide "),e.TgZ(74,"a",23),e._uU(75,"Migrating from TypeORM to Prisma"),e.qZA(),e._uU(76,".\n"),e.qZA(),e.TgZ(77,"h4",24)(78,"span"),e._uU(79,"Create your NestJS project"),e.qZA()(),e.TgZ(80,"p"),e._uU(81,"To get started, install the NestJS CLI and create your app skeleton with the following commands:"),e.qZA(),e.TgZ(82,"pre")(83,"code",25),e._uU(84,"\n$ npm install -g @nestjs/cli\n$ nest new hello-prisma\n"),e.qZA()(),e.TgZ(85,"p"),e._uU(86,"See the "),e.TgZ(87,"a",26),e._uU(88,"First steps"),e.qZA(),e._uU(89," page to learn more about the project files created by this command. Note also that you can now run "),e.TgZ(90,"code"),e._uU(91,"npm start"),e.qZA(),e._uU(92," to start your application. The REST API running at "),e.TgZ(93,"code"),e._uU(94,"http://localhost:3000/"),e.qZA(),e._uU(95," currently serves a single route that's implemented in "),e.TgZ(96,"code"),e._uU(97,"src/app.controller.ts"),e.qZA(),e._uU(98,". Over the course of this guide, you'll implement additional routes to store and retrieve data about "),e.TgZ(99,"em"),e._uU(100,"users"),e.qZA(),e._uU(101," and "),e.TgZ(102,"em"),e._uU(103,"posts"),e.qZA(),e._uU(104,"."),e.qZA(),e.TgZ(105,"h4",27)(106,"span"),e._uU(107,"Set up Prisma"),e.qZA()(),e.TgZ(108,"p"),e._uU(109,"Start by installing the Prisma CLI as a development dependency in your project:"),e.qZA(),e.TgZ(110,"pre")(111,"code",25),e._uU(112,"\n$ cd hello-prisma\n$ npm install prisma --save-dev\n"),e.qZA()(),e.TgZ(113,"p"),e._uU(114,"In the following steps, we'll be utilizing the "),e.TgZ(115,"a",28),e._uU(116,"Prisma CLI"),e.qZA(),e._uU(117,". As a best practice, it's recommended to invoke the CLI locally by prefixing it with "),e.TgZ(118,"code"),e._uU(119,"npx"),e.qZA(),e._uU(120,":"),e.qZA(),e.TgZ(121,"pre")(122,"code",25),e._uU(123,"\n$ npx prisma\n"),e.qZA()(),e.TgZ(124,"details")(125,"summary"),e._uU(126,"Expand if you're using Yarn"),e.qZA(),e.TgZ(127,"p"),e._uU(128,"If you're using Yarn, then you can install the Prisma CLI as follows:"),e.qZA(),e.TgZ(129,"pre")(130,"code",25),e._uU(131,"\n$ yarn add prisma --dev\n"),e.qZA()(),e.TgZ(132,"p"),e._uU(133,"Once installed, you can invoke it by prefixing it with "),e.TgZ(134,"code"),e._uU(135,"yarn"),e.qZA(),e._uU(136,":"),e.qZA(),e.TgZ(137,"pre")(138,"code",25),e._uU(139,"\n$ yarn prisma\n"),e.qZA()()(),e.TgZ(140,"p"),e._uU(141,"Now create your initial Prisma setup using the "),e.TgZ(142,"code"),e._uU(143,"init"),e.qZA(),e._uU(144," command of the Prisma CLI:"),e.qZA(),e.TgZ(145,"pre")(146,"code",25),e._uU(147,"\n$ npx prisma init\n"),e.qZA()(),e.TgZ(148,"p"),e._uU(149,"This command creates a new "),e.TgZ(150,"code"),e._uU(151,"prisma"),e.qZA(),e._uU(152," directory with the following contents:"),e.qZA(),e.TgZ(153,"ul")(154,"li")(155,"code"),e._uU(156,"schema.prisma"),e.qZA(),e._uU(157,": Specifies your database connection and contains the database schema"),e.qZA(),e.TgZ(158,"li")(159,"code"),e._uU(160,".env"),e.qZA(),e._uU(161,": A "),e.TgZ(162,"a",29),e._uU(163,"dotenv"),e.qZA(),e._uU(164," file, typically used to store your database credentials in a group of environment variables"),e.qZA()(),e.TgZ(165,"h4",30)(166,"span"),e._uU(167,"Set the database connection"),e.qZA()(),e.TgZ(168,"p"),e._uU(169,"Your database connection is configured in the "),e.TgZ(170,"code"),e._uU(171,"datasource"),e.qZA(),e._uU(172," block in your "),e.TgZ(173,"code"),e._uU(174,"schema.prisma"),e.qZA(),e._uU(175," file. By default it's set to "),e.TgZ(176,"code"),e._uU(177,"postgresql"),e.qZA(),e._uU(178,", but since you're using a SQLite database in this guide you need to adjust the "),e.TgZ(179,"code"),e._uU(180,"provider"),e.qZA(),e._uU(181," field of the "),e.TgZ(182,"code"),e._uU(183,"datasource"),e.qZA(),e._uU(184," block to "),e.TgZ(185,"code"),e._uU(186,"sqlite"),e.qZA(),e._uU(187,":"),e.qZA(),e.TgZ(188,"pre")(189,"code",31),e._uU(190,'\ndatasource db {\n  provider = "sqlite"\n  url      = env("DATABASE_URL")\n}\n\ngenerator client {\n  provider = "prisma-client-js"\n}\n'),e.qZA()(),e.TgZ(191,"p"),e._uU(192,"Now, open up "),e.TgZ(193,"code"),e._uU(194,".env"),e.qZA(),e._uU(195," and adjust the "),e.TgZ(196,"code"),e._uU(197,"DATABASE_URL"),e.qZA(),e._uU(198," environment variable to look as follows:"),e.qZA(),e.TgZ(199,"pre")(200,"code",25),e._uU(201,'\nDATABASE_URL="file:./dev.db"\n'),e.qZA()(),e.TgZ(202,"p"),e._uU(203,"SQLite databases are simple files; no server is required to use a SQLite database. So instead of configuring a connection URL with a "),e.TgZ(204,"em"),e._uU(205,"host"),e.qZA(),e._uU(206," and "),e.TgZ(207,"em"),e._uU(208,"port"),e.qZA(),e._uU(209,", you can just point it to a local file which in this case is called "),e.TgZ(210,"code"),e._uU(211,"dev.db"),e.qZA(),e._uU(212,". This file will be created in the next step."),e.qZA(),e.TgZ(213,"details")(214,"summary"),e._uU(215,"Expand if you're using PostgreSQL or MySQL"),e.qZA(),e.TgZ(216,"p"),e._uU(217,"With PostgreSQL and MySQL, you need to configure the connection URL to point to the "),e.TgZ(218,"em"),e._uU(219,"database server"),e.qZA(),e._uU(220,". You can learn more about the required connection URL format "),e.TgZ(221,"a",32),e._uU(222,"here"),e.qZA(),e._uU(223,"."),e.qZA(),e.TgZ(224,"p")(225,"strong"),e._uU(226,"PostgreSQL"),e.qZA()(),e.TgZ(227,"p"),e._uU(228,"If you're using PostgreSQL, you have to adjust the "),e.TgZ(229,"code"),e._uU(230,"schema.prisma"),e.qZA(),e._uU(231," and "),e.TgZ(232,"code"),e._uU(233,".env"),e.qZA(),e._uU(234," files as follows:"),e.qZA(),e.TgZ(235,"p")(236,"strong")(237,"code"),e._uU(238,"schema.prisma"),e.qZA()()(),e.TgZ(239,"pre")(240,"code",31),e._uU(241,'\ndatasource db {\n  provider = "postgresql"\n  url      = env("DATABASE_URL")\n}\n\ngenerator client {\n  provider = "prisma-client-js"\n}\n'),e.qZA()(),e.TgZ(242,"p")(243,"strong")(244,"code"),e._uU(245,".env"),e.qZA()()(),e.TgZ(246,"pre")(247,"code",25),e._uU(248,'\nDATABASE_URL="postgresql://USER:PASSWORD@HOST:PORT/DATABASE?schema=SCHEMA"\n'),e.qZA()(),e.TgZ(249,"p"),e._uU(250,"Replace the placeholders spelled in all uppercase letters with your database credentials. Note that if you're unsure what to provide for the "),e.TgZ(251,"code"),e._uU(252,"SCHEMA"),e.qZA(),e._uU(253," placeholder, it's most likely the default value "),e.TgZ(254,"code"),e._uU(255,"public"),e.qZA(),e._uU(256,":"),e.qZA(),e.TgZ(257,"pre")(258,"code",25),e._uU(259,'\nDATABASE_URL="postgresql://USER:PASSWORD@HOST:PORT/DATABASE?schema=public"\n'),e.qZA()(),e.TgZ(260,"p"),e._uU(261,"If you want to learn how to set up a PostgreSQL database, you can follow this guide on "),e.TgZ(262,"a",33),e._uU(263,"setting up a free PostgreSQL database on Heroku"),e.qZA(),e._uU(264,"."),e.qZA(),e.TgZ(265,"p")(266,"strong"),e._uU(267,"MySQL"),e.qZA()(),e.TgZ(268,"p"),e._uU(269,"If you're using MySQL, you have to adjust the "),e.TgZ(270,"code"),e._uU(271,"schema.prisma"),e.qZA(),e._uU(272," and "),e.TgZ(273,"code"),e._uU(274,".env"),e.qZA(),e._uU(275," files as follows:"),e.qZA(),e.TgZ(276,"p")(277,"strong")(278,"code"),e._uU(279,"schema.prisma"),e.qZA()()(),e.TgZ(280,"pre")(281,"code",31),e._uU(282,'\ndatasource db {\n  provider = "mysql"\n  url      = env("DATABASE_URL")\n}\n\ngenerator client {\n  provider = "prisma-client-js"\n}\n'),e.qZA()(),e.TgZ(283,"p")(284,"strong")(285,"code"),e._uU(286,".env"),e.qZA()()(),e.TgZ(287,"pre")(288,"code",25),e._uU(289,'\nDATABASE_URL="mysql://USER:PASSWORD@HOST:PORT/DATABASE"\n'),e.qZA()(),e.TgZ(290,"p"),e._uU(291,"Replace the placeholders spelled in all uppercase letters with your database credentials."),e.qZA()(),e.TgZ(292,"h4",34)(293,"span"),e._uU(294,"Create two database tables with Prisma Migrate"),e.qZA()(),e.TgZ(295,"p"),e._uU(296,"In this section, you'll create two new tables in your database using "),e.TgZ(297,"a",35),e._uU(298,"Prisma Migrate"),e.qZA(),e._uU(299,". Prisma Migrate generates SQL migration files for your declarative data model definition in the Prisma schema. These migration files are fully customizable so that you can configure any additional features of the underlying database or include additional commands, e.g. for seeding."),e.qZA(),e.TgZ(300,"p"),e._uU(301,"Add the following two models to your "),e.TgZ(302,"code"),e._uU(303,"schema.prisma"),e.qZA(),e._uU(304," file:"),e.qZA(),e.TgZ(305,"pre")(306,"code",31),e._uU(307,"\nmodel User {\n  id    Int     @default(autoincrement()) @id\n  email String  @unique\n  name  String?\n  posts Post[]\n}\n\nmodel Post {\n  id        Int      @default(autoincrement()) @id\n  title     String\n  content   String?\n  published Boolean? @default(false)\n  author    User?    @relation(fields: [authorId], references: [id])\n  authorId  Int?\n}\n"),e.qZA()(),e.TgZ(308,"p"),e._uU(309,"With your Prisma models in place, you can generate your SQL migration files and run them against the database. Run the following commands in your terminal:"),e.qZA(),e.TgZ(310,"pre")(311,"code",25),e._uU(312,"\n$ npx prisma migrate dev --name init\n"),e.qZA()(),e.TgZ(313,"p"),e._uU(314,"This "),e.TgZ(315,"code"),e._uU(316,"prisma migrate dev"),e.qZA(),e._uU(317," command generates SQL files and directly runs them against the database. In this case, the following migration files was created in the existing "),e.TgZ(318,"code"),e._uU(319,"prisma"),e.qZA(),e._uU(320," directory:"),e.qZA(),e.TgZ(321,"pre")(322,"code",25),e._uU(323,"\n$ tree prisma\nprisma\n\u251c\u2500\u2500 dev.db\n\u251c\u2500\u2500 migrations\n\u2502   \u2514\u2500\u2500 20201207100915_init\n\u2502       \u2514\u2500\u2500 migration.sql\n\u2514\u2500\u2500 schema.prisma\n"),e.qZA()(),e.TgZ(324,"details")(325,"summary"),e._uU(326,"Expand to view the generated SQL statements"),e.qZA(),e.TgZ(327,"p"),e._uU(328,"The following tables were created in your SQLite database:"),e.qZA(),e.TgZ(329,"pre")(330,"code",36),e._uU(331,'\n-- CreateTable\nCREATE TABLE "User" (\n    "id" INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,\n    "email" TEXT NOT NULL,\n    "name" TEXT\n);\n\n-- CreateTable\nCREATE TABLE "Post" (\n    "id" INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,\n    "title" TEXT NOT NULL,\n    "content" TEXT,\n    "published" BOOLEAN DEFAULT false,\n    "authorId" INTEGER,\n\n    FOREIGN KEY ("authorId") REFERENCES "User"("id") ON DELETE SET NULL ON UPDATE CASCADE\n);\n\n-- CreateIndex\nCREATE UNIQUE INDEX "User.email_unique" ON "User"("email");\n'),e.qZA()()(),e.TgZ(332,"h4",37)(333,"span"),e._uU(334,"Install and generate Prisma Client"),e.qZA()(),e.TgZ(335,"p"),e._uU(336,"Prisma Client is a type-safe database client that's "),e.TgZ(337,"em"),e._uU(338,"generated"),e.qZA(),e._uU(339," from your Prisma model definition. Because of this approach, Prisma Client can expose "),e.TgZ(340,"a",38),e._uU(341,"CRUD"),e.qZA(),e._uU(342," operations that are "),e.TgZ(343,"em"),e._uU(344,"tailored"),e.qZA(),e._uU(345," specifically to your models."),e.qZA(),e.TgZ(346,"p"),e._uU(347,"To install Prisma Client in your project, run the following command in your terminal:"),e.qZA(),e.TgZ(348,"pre")(349,"code",25),e._uU(350,"\n$ npm install @prisma/client\n"),e.qZA()(),e.TgZ(351,"p"),e._uU(352,"Note that during installation, Prisma automatically invokes the "),e.TgZ(353,"code"),e._uU(354,"prisma generate"),e.qZA(),e._uU(355," command for you. In the future, you need to run this command after "),e.TgZ(356,"em"),e._uU(357,"every"),e.qZA(),e._uU(358," change to your Prisma models to update your generated Prisma Client."),e.qZA(),e.TgZ(359,"blockquote",13)(360,"strong"),e._uU(361,"Note"),e.qZA(),e._uU(362," The "),e.TgZ(363,"code"),e._uU(364,"prisma generate"),e.qZA(),e._uU(365," command reads your Prisma schema and updates the generated Prisma Client library inside "),e.TgZ(366,"code"),e._uU(367,"node_modules/@prisma/client"),e.qZA(),e._uU(368,".\n"),e.qZA(),e.TgZ(369,"h4",39)(370,"span"),e._uU(371,"Use Prisma Client in your NestJS services"),e.qZA()(),e.TgZ(372,"p"),e._uU(373,"You're now able to send database queries with Prisma Client. If you want to learn more about building queries with Prisma Client, check out the "),e.TgZ(374,"a",40),e._uU(375,"API documentation"),e.qZA(),e._uU(376,"."),e.qZA(),e.TgZ(377,"p"),e._uU(378,"When setting up your NestJS application, you'll want to abstract away the Prisma Client API for database queries within a service. To get started, you can create a new "),e.TgZ(379,"code"),e._uU(380,"PrismaService"),e.qZA(),e._uU(381," that takes care of instantiating "),e.TgZ(382,"code"),e._uU(383,"PrismaClient"),e.qZA(),e._uU(384," and connecting to your database."),e.qZA(),e.TgZ(385,"p"),e._uU(386,"Inside the "),e.TgZ(387,"code"),e._uU(388,"src"),e.qZA(),e._uU(389," directory, create a new file called "),e.TgZ(390,"code"),e._uU(391,"prisma.service.ts"),e.qZA(),e._uU(392," and add the following code to it:"),e.qZA(),e.TgZ(393,"pre")(394,"code",41),e._uU(395,"\nimport { INestApplication, Injectable, OnModuleInit } from '@nestjs/common';\nimport { PrismaClient } from '@prisma/client';\n\n@Injectable()\nexport class PrismaService extends PrismaClient implements OnModuleInit {\n  async onModuleInit() {\n    await this.$connect();\n  }\n\n  async enableShutdownHooks(app: INestApplication) {\n    this.$on('beforeExit', async () => {\n      await app.close();\n    });\n  }\n}\n"),e.qZA()(),e.TgZ(396,"blockquote",13)(397,"strong"),e._uU(398,"Note"),e.qZA(),e._uU(399," The "),e.TgZ(400,"code"),e._uU(401,"onModuleInit"),e.qZA(),e._uU(402," is optional \u2014 if you leave it out, Prisma will connect lazily on its first call to the database. We don't bother with "),e.TgZ(403,"code"),e._uU(404,"onModuleDestroy"),e.qZA(),e._uU(405,", since Prisma has its own shutdown hooks where it will destroy the connection. For more info on "),e.TgZ(406,"code"),e._uU(407,"enableShutdownHooks"),e.qZA(),e._uU(408,", please see "),e.TgZ(409,"a",42),e._uU(410,"Issues with "),e.TgZ(411,"code"),e._uU(412,"enableShutdownHooks"),e.qZA()()(),e.TgZ(413,"p"),e._uU(414,"Next, you can write services that you can use to make database calls for the "),e.TgZ(415,"code"),e._uU(416,"User"),e.qZA(),e._uU(417," and "),e.TgZ(418,"code"),e._uU(419,"Post"),e.qZA(),e._uU(420," models from your Prisma schema."),e.qZA(),e.TgZ(421,"p"),e._uU(422,"Still inside the "),e.TgZ(423,"code"),e._uU(424,"src"),e.qZA(),e._uU(425," directory, create a new file called "),e.TgZ(426,"code"),e._uU(427,"user.service.ts"),e.qZA(),e._uU(428," and add the following code to it:"),e.qZA(),e.TgZ(429,"pre")(430,"code",41),e._uU(431,"\nimport { Injectable } from '@nestjs/common';\nimport { PrismaService } from './prisma.service';\nimport { User, Prisma } from '@prisma/client';\n\n@Injectable()\nexport class UserService {\n  constructor(private prisma: PrismaService) {}\n\n  async user(\n    userWhereUniqueInput: Prisma.UserWhereUniqueInput,\n  ): Promise<User | null> {\n    return this.prisma.user.findUnique({\n      where: userWhereUniqueInput,\n    });\n  }\n\n  async users(params: {\n    skip?: number;\n    take?: number;\n    cursor?: Prisma.UserWhereUniqueInput;\n    where?: Prisma.UserWhereInput;\n    orderBy?: Prisma.UserOrderByWithRelationInput;\n  }): Promise<User[]> {\n    const { skip, take, cursor, where, orderBy } = params;\n    return this.prisma.user.findMany({\n      skip,\n      take,\n      cursor,\n      where,\n      orderBy,\n    });\n  }\n\n  async createUser(data: Prisma.UserCreateInput): Promise<User> {\n    return this.prisma.user.create({\n      data,\n    });\n  }\n\n  async updateUser(params: {\n    where: Prisma.UserWhereUniqueInput;\n    data: Prisma.UserUpdateInput;\n  }): Promise<User> {\n    const { where, data } = params;\n    return this.prisma.user.update({\n      data,\n      where,\n    });\n  }\n\n  async deleteUser(where: Prisma.UserWhereUniqueInput): Promise<User> {\n    return this.prisma.user.delete({\n      where,\n    });\n  }\n}\n"),e.qZA()(),e.TgZ(432,"p"),e._uU(433,"Notice how you're using Prisma Client's generated types to ensure that the methods that are exposed by your service are properly typed. You therefore save the boilerplate of typing your models and creating additional interface or DTO files."),e.qZA(),e.TgZ(434,"p"),e._uU(435,"Now do the same for the "),e.TgZ(436,"code"),e._uU(437,"Post"),e.qZA(),e._uU(438," model."),e.qZA(),e.TgZ(439,"p"),e._uU(440,"Still inside the "),e.TgZ(441,"code"),e._uU(442,"src"),e.qZA(),e._uU(443," directory, create a new file called "),e.TgZ(444,"code"),e._uU(445,"post.service.ts"),e.qZA(),e._uU(446," and add the following code to it:"),e.qZA(),e.TgZ(447,"pre")(448,"code",41),e._uU(449,"\nimport { Injectable } from '@nestjs/common';\nimport { PrismaService } from './prisma.service';\nimport { Post, Prisma } from '@prisma/client';\n\n@Injectable()\nexport class PostService {\n  constructor(private prisma: PrismaService) {}\n\n  async post(\n    postWhereUniqueInput: Prisma.PostWhereUniqueInput,\n  ): Promise<Post | null> {\n    return this.prisma.post.findUnique({\n      where: postWhereUniqueInput,\n    });\n  }\n\n  async posts(params: {\n    skip?: number;\n    take?: number;\n    cursor?: Prisma.PostWhereUniqueInput;\n    where?: Prisma.PostWhereInput;\n    orderBy?: Prisma.PostOrderByWithRelationInput;\n  }): Promise<Post[]> {\n    const { skip, take, cursor, where, orderBy } = params;\n    return this.prisma.post.findMany({\n      skip,\n      take,\n      cursor,\n      where,\n      orderBy,\n    });\n  }\n\n  async createPost(data: Prisma.PostCreateInput): Promise<Post> {\n    return this.prisma.post.create({\n      data,\n    });\n  }\n\n  async updatePost(params: {\n    where: Prisma.PostWhereUniqueInput;\n    data: Prisma.PostUpdateInput;\n  }): Promise<Post> {\n    const { data, where } = params;\n    return this.prisma.post.update({\n      data,\n      where,\n    });\n  }\n\n  async deletePost(where: Prisma.PostWhereUniqueInput): Promise<Post> {\n    return this.prisma.post.delete({\n      where,\n    });\n  }\n}\n"),e.qZA()(),e.TgZ(450,"p"),e._uU(451,"Your "),e.TgZ(452,"code"),e._uU(453,"UserService"),e.qZA(),e._uU(454," and "),e.TgZ(455,"code"),e._uU(456,"PostService"),e.qZA(),e._uU(457," currently wrap the CRUD queries that are available in Prisma Client. In a real world application, the service would also be the place to add business logic to your application. For example, you could have a method called "),e.TgZ(458,"code"),e._uU(459,"updatePassword"),e.qZA(),e._uU(460," inside the "),e.TgZ(461,"code"),e._uU(462,"UserService"),e.qZA(),e._uU(463," that would be responsible for updating the password of a user."),e.qZA(),e.TgZ(464,"h5",43),e._uU(465,"Implement your REST API routes in the main app controller"),e.qZA(),e.TgZ(466,"p"),e._uU(467,"Finally, you'll use the services you created in the previous sections to implement the different routes of your app. For the purpose of this guide, you'll put all your routes into the already existing "),e.TgZ(468,"code"),e._uU(469,"AppController"),e.qZA(),e._uU(470," class."),e.qZA(),e.TgZ(471,"p"),e._uU(472,"Replace the contents of the "),e.TgZ(473,"code"),e._uU(474,"app.controller.ts"),e.qZA(),e._uU(475," file with the following code:"),e.qZA(),e.TgZ(476,"pre")(477,"code",41),e._uU(478,"\nimport {\n  Controller,\n  Get,\n  Param,\n  Post,\n  Body,\n  Put,\n  Delete,\n} from '@nestjs/common';\nimport { UserService } from './user.service';\nimport { PostService } from './post.service';\nimport { User as UserModel, Post as PostModel } from '@prisma/client';\n\n@Controller()\nexport class AppController {\n  constructor(\n    private readonly userService: UserService,\n    private readonly postService: PostService,\n  ) {}\n\n  @Get('post/:id')\n  async getPostById(@Param('id') id: string): Promise<PostModel> {\n    return this.postService.post({ id: Number(id) });\n  }\n\n  @Get('feed')\n  async getPublishedPosts(): Promise<PostModel[]> {\n    return this.postService.posts({\n      where: { published: true },\n    });\n  }\n\n  @Get('filtered-posts/:searchString')\n  async getFilteredPosts(\n    @Param('searchString') searchString: string,\n  ): Promise<PostModel[]> {\n    return this.postService.posts({\n      where: {\n        OR: [\n          {\n            title: { contains: searchString },\n          },\n          {\n            content: { contains: searchString },\n          },\n        ],\n      },\n    });\n  }\n\n  @Post('post')\n  async createDraft(\n    @Body() postData: { title: string; content?: string; authorEmail: string },\n  ): Promise<PostModel> {\n    const { title, content, authorEmail } = postData;\n    return this.postService.createPost({\n      title,\n      content,\n      author: {\n        connect: { email: authorEmail },\n      },\n    });\n  }\n\n  @Post('user')\n  async signupUser(\n    @Body() userData: { name?: string; email: string },\n  ): Promise<UserModel> {\n    return this.userService.createUser(userData);\n  }\n\n  @Put('publish/:id')\n  async publishPost(@Param('id') id: string): Promise<PostModel> {\n    return this.postService.updatePost({\n      where: { id: Number(id) },\n      data: { published: true },\n    });\n  }\n\n  @Delete('post/:id')\n  async deletePost(@Param('id') id: string): Promise<PostModel> {\n    return this.postService.deletePost({ id: Number(id) });\n  }\n}\n"),e.qZA()(),e.TgZ(479,"p"),e._uU(480,"This controller implements the following routes:"),e.qZA(),e.TgZ(481,"h6",44)(482,"code"),e._uU(483,"GET"),e.qZA()(),e.TgZ(484,"ul")(485,"li")(486,"code"),e._uU(487,"/post/:id"),e.qZA(),e._uU(488,": Fetch a single post by its "),e.TgZ(489,"code"),e._uU(490,"id"),e.qZA()(),e.TgZ(491,"li")(492,"code"),e._uU(493,"/feed"),e.qZA(),e._uU(494,": Fetch all "),e.TgZ(495,"em"),e._uU(496,"published"),e.qZA(),e._uU(497," posts"),e.qZA(),e.TgZ(498,"li")(499,"code"),e._uU(500,"/filter-posts/:searchString"),e.qZA(),e._uU(501,": Filter posts by "),e.TgZ(502,"code"),e._uU(503,"title"),e.qZA(),e._uU(504," or "),e.TgZ(505,"code"),e._uU(506,"content"),e.qZA()()(),e.TgZ(507,"h6",45)(508,"code"),e._uU(509,"POST"),e.qZA()(),e.TgZ(510,"ul")(511,"li")(512,"code"),e._uU(513,"/post"),e.qZA(),e._uU(514,": Create a new post"),e.TgZ(515,"ul")(516,"li"),e._uU(517,"Body:"),e.TgZ(518,"ul")(519,"li")(520,"code"),e._uU(521,"title: String"),e.qZA(),e._uU(522," (required): The title of the post"),e.qZA(),e.TgZ(523,"li")(524,"code"),e._uU(525,"content: String"),e.qZA(),e._uU(526," (optional): The content of the post"),e.qZA(),e.TgZ(527,"li")(528,"code"),e._uU(529,"authorEmail: String"),e.qZA(),e._uU(530," (required): The email of the user that creates the post"),e.qZA()()()()(),e.TgZ(531,"li")(532,"code"),e._uU(533,"/user"),e.qZA(),e._uU(534,": Create a new user"),e.TgZ(535,"ul")(536,"li"),e._uU(537,"Body:"),e.TgZ(538,"ul")(539,"li")(540,"code"),e._uU(541,"email: String"),e.qZA(),e._uU(542," (required): The email address of the user"),e.qZA(),e.TgZ(543,"li")(544,"code"),e._uU(545,"name: String"),e.qZA(),e._uU(546," (optional): The name of the user"),e.qZA()()()()()(),e.TgZ(547,"h6",46)(548,"code"),e._uU(549,"PUT"),e.qZA()(),e.TgZ(550,"ul")(551,"li")(552,"code"),e._uU(553,"/publish/:id"),e.qZA(),e._uU(554,": Publish a post by its "),e.TgZ(555,"code"),e._uU(556,"id"),e.qZA()()(),e.TgZ(557,"h6",47)(558,"code"),e._uU(559,"DELETE"),e.qZA()(),e.TgZ(560,"ul")(561,"li")(562,"code"),e._uU(563,"/post/:id"),e.qZA(),e._uU(564,": Delete a post by its "),e.TgZ(565,"code"),e._uU(566,"id"),e.qZA()()(),e.TgZ(567,"h4",48)(568,"span"),e._uU(569,"Issues with "),e.TgZ(570,"code"),e._uU(571,"enableShutdownHooks"),e.qZA()()(),e.TgZ(572,"p"),e._uU(573,"Prisma interferes with NestJS "),e.TgZ(574,"code"),e._uU(575,"enableShutdownHooks"),e.qZA(),e._uU(576,". Prisma listens for shutdown signals and will call "),e.TgZ(577,"code"),e._uU(578,"process.exit()"),e.qZA(),e._uU(579," before your application shutdown hooks fire. To deal with this, you would need to add a listener for Prisma "),e.TgZ(580,"code"),e._uU(581,"beforeExit"),e.qZA(),e._uU(582," event."),e.qZA(),e.TgZ(583,"pre")(584,"code",41),e._uU(585,"\n// main.ts\n...\nimport { PrismaService } from './services/prisma/prisma.service';\n...\nasync function bootstrap() {\n  ...\n  const prismaService = app.get(PrismaService);\n  await prismaService.enableShutdownHooks(app)\n  ...\n}\nbootstrap()\n"),e.qZA()(),e.TgZ(586,"p"),e._uU(587,"You can "),e.TgZ(588,"a",49),e._uU(589,"read more"),e.qZA(),e._uU(590," about Prisma handling of shutdown signal, and "),e.TgZ(591,"code"),e._uU(592,"beforeExit"),e.qZA(),e._uU(593," event."),e.qZA(),e.TgZ(594,"h4",50)(595,"span"),e._uU(596,"Summary"),e.qZA()(),e.TgZ(597,"p"),e._uU(598,"In this recipe, you learned how to use Prisma along with NestJS to implement a REST API. The controller that implements the routes of the API is calling a "),e.TgZ(599,"code"),e._uU(600,"PrismaService"),e.qZA(),e._uU(601," which in turn uses Prisma Client to send queries to a database to fulfill the data needs of incoming requests."),e.qZA(),e.TgZ(602,"p"),e._uU(603,"If you want to learn more about using NestJS with Prisma, be sure to check out the following resources:"),e.qZA(),e.TgZ(604,"ul")(605,"li")(606,"a",51),e._uU(607,"NestJS & Prisma"),e.qZA()(),e.TgZ(608,"li")(609,"a",19),e._uU(610,"Ready-to-run example projects for REST & GraphQL"),e.qZA()(),e.TgZ(611,"li")(612,"a",52),e._uU(613,"Production-ready starter kit"),e.qZA()(),e.TgZ(614,"li")(615,"a",53),e._uU(616,"Video: Accessing Databases using NestJS with Prisma (5min)"),e.qZA(),e._uU(617," by "),e.TgZ(618,"a",54),e._uU(619,"Marc Stammerjohann"),e.qZA()()()())},dependencies:[d.U],encapsulation:2,changeDetection:0}));class S extends l.y{}(0,s.Z)(S,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(S)))(o||S)}}()),(0,s.Z)(S,"\u0275cmp",e.Xpm({type:S,selectors:[["app-repl"]],features:[e.qOj],decls:193,vars:8,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/repl.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","read-eval-print-loop-repl"],["appAnchor","","id","usage"],[1,"filename"],["app45e6f463a925740b39afa1a98486558c8e21db6b",""],[1,"language-typescript"],[1,"language-bash"],[1,"info"],["rel","nofollow","target","_blank","href","https://nodejs.org/api/repl.html"],["src","/assets/repl.gif","alt","REPL example"],["appAnchor","","id","native-functions"],[1,"language-text"],["rel","nofollow","target","_blank","href","https://www.typescriptlang.org/docs/handbook/2/functions.html#function-type-expressions"],["appAnchor","","id","watch-mode"]],template:function(n,o){if(1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"Read-Eval-Print-Loop (REPL)"),e.qZA(),e.TgZ(7,"p"),e._uU(8,"REPL is a simple interactive environment that takes single user inputs, executes them, and returns the result to the user.\nThe REPL feature lets you inspect your dependency graph and call methods on your providers (and controllers) directly from your terminal."),e.qZA(),e.TgZ(9,"h4",6)(10,"span"),e._uU(11,"Usage"),e.qZA()(),e.TgZ(12,"p"),e._uU(13,"To run your NestJS application in REPL mode, create a new "),e.TgZ(14,"code"),e._uU(15,"repl.ts"),e.qZA(),e._uU(16," file (alongside the existing "),e.TgZ(17,"code"),e._uU(18,"main.ts"),e.qZA(),e._uU(19," file) and add the following code inside:"),e.qZA(),e.TgZ(20,"span",7),e._uU(21),e.ALo(22,"extension"),e._UZ(23,"app-tabs",null,8),e.qZA(),e.TgZ(25,"pre")(26,"code",9),e._uU(27,"\nimport { repl } from '@nestjs/core';\nimport { AppModule } from './app.module';\n\nasync function bootstrap() {\n  await repl(AppModule);\n}\nbootstrap();\n"),e.qZA()(),e.TgZ(28,"pre")(29,"code",9),e._uU(30,"\nimport { repl } from '@nestjs/core';\nimport { AppModule } from './app.module';\n\nasync function bootstrap() {\n  await repl(AppModule);\n}\nbootstrap();\n"),e.qZA()(),e.TgZ(31,"p"),e._uU(32,"Now in your terminal, start the REPL with the following command:"),e.qZA(),e.TgZ(33,"pre")(34,"code",10),e._uU(35,"\n$ npm run start -- --entryFile repl\n"),e.qZA()(),e.TgZ(36,"blockquote",11)(37,"strong"),e._uU(38,"Hint"),e.qZA(),e.TgZ(39,"code"),e._uU(40,"repl"),e.qZA(),e._uU(41," returns a "),e.TgZ(42,"a",12),e._uU(43,"Node.js REPL server"),e.qZA(),e._uU(44," object.\n"),e.qZA(),e.TgZ(45,"p"),e._uU(46,"Once it's up and running, you should see the following message in your console:"),e.qZA(),e.TgZ(47,"pre")(48,"code",10),e._uU(49,"\nLOG [NestFactory] Starting Nest application...\nLOG [InstanceLoader] AppModule dependencies initialized\nLOG REPL initialized\n"),e.qZA()(),e.TgZ(50,"p"),e._uU(51,"And now you can start interacting with your dependencies graph. For instance, you can retrieve an "),e.TgZ(52,"code"),e._uU(53,"AppService"),e.qZA(),e._uU(54," (we are using the starter project as an example here) and call the "),e.TgZ(55,"code"),e._uU(56,"getHello()"),e.qZA(),e._uU(57," method:"),e.qZA(),e.TgZ(58,"pre")(59,"code",9),e._uU(60,"\n> get(AppService).getHello()\n'Hello World!'\n"),e.qZA()(),e.TgZ(61,"p"),e._uU(62,"You can execute any JavaScript code from within your terminal, for example, assign an instance of the "),e.TgZ(63,"code"),e._uU(64,"AppController"),e.qZA(),e._uU(65," to a local variable, and use "),e.TgZ(66,"code"),e._uU(67,"await"),e.qZA(),e._uU(68," to call an asynchronous method:"),e.qZA(),e.TgZ(69,"pre")(70,"code",9),e._uU(71,"\n> appController = get(AppController)\nAppController { appService: AppService {} }\n> await appController.getHello()\n'Hello World!'\n"),e.qZA()(),e.TgZ(72,"p"),e._uU(73,"To display all public methods available on a given provider or controller, use the "),e.TgZ(74,"code"),e._uU(75,"methods()"),e.qZA(),e._uU(76," function, as follows:"),e.qZA(),e.TgZ(77,"pre")(78,"code",9),e._uU(79,"\n> methods(AppController)\n\nMethods:\n \u25fb getHello\n"),e.qZA()(),e.TgZ(80,"p"),e._uU(81,"To print all registered modules as a list together with their controllers and providers, use "),e.TgZ(82,"code"),e._uU(83,"debug()"),e.qZA(),e._uU(84,"."),e.qZA(),e.TgZ(85,"pre")(86,"code",9),e._uU(87,"\n> debug()\n\nAppModule:\n - controllers:\n  \u25fb AppController\n - providers:\n  \u25fb AppService\n"),e.qZA()(),e.TgZ(88,"p"),e._uU(89,"Quick demo:"),e.qZA(),e.TgZ(90,"figure"),e._UZ(91,"img",13),e.qZA(),e.TgZ(92,"p"),e._uU(93,"You can find more information about the existing, predefined native methods in the section below."),e.qZA(),e.TgZ(94,"h4",14)(95,"span"),e._uU(96,"Native functions"),e.qZA()(),e.TgZ(97,"p"),e._uU(98,"The built-in NestJS REPL comes with a few native functions that are globally available when you start REPL. You can call "),e.TgZ(99,"code"),e._uU(100,"help()"),e.qZA(),e._uU(101," to list them out."),e.qZA(),e.TgZ(102,"p"),e._uU(103,"If you don't recall what's the signature (ie: expected parameters and a return type) of a function, you can call "),e.TgZ(104,"code"),e._uU(105,"<function_name>.help"),e.qZA(),e._uU(106,".\nFor instance:"),e.qZA(),e.TgZ(107,"pre")(108,"code",15),e._uU(109,"\n> $.help\nRetrieves an instance of either injectable or controller, otherwise, throws exception.\nInterface: $(token: InjectionToken) => any\n"),e.qZA()(),e.TgZ(110,"blockquote",11)(111,"strong"),e._uU(112,"Hint"),e.qZA(),e._uU(113," Those function interfaces are written in "),e.TgZ(114,"a",16),e._uU(115,"TypeScript function type expression syntax"),e.qZA(),e._uU(116,".\n"),e.qZA(),e.TgZ(117,"table")(118,"thead")(119,"tr")(120,"th"),e._uU(121,"Function"),e.qZA(),e.TgZ(122,"th"),e._uU(123,"Description"),e.qZA(),e.TgZ(124,"th"),e._uU(125,"Signature"),e.qZA()()(),e.TgZ(126,"tbody")(127,"tr")(128,"td")(129,"code"),e._uU(130,"debug"),e.qZA()(),e.TgZ(131,"td"),e._uU(132,"Print all registered modules as a list together with their controllers and providers."),e.qZA(),e.TgZ(133,"td")(134,"code"),e._uU(135,"debug(moduleCls?: ClassRef | string) => void"),e.qZA()()(),e.TgZ(136,"tr")(137,"td")(138,"code"),e._uU(139,"get"),e.qZA(),e._uU(140," or "),e.TgZ(141,"code"),e._uU(142,"$"),e.qZA()(),e.TgZ(143,"td"),e._uU(144,"Retrieves an instance of either injectable or controller, otherwise, throws exception."),e.qZA(),e.TgZ(145,"td")(146,"code"),e._uU(147,"get(token: InjectionToken) => any"),e.qZA()()(),e.TgZ(148,"tr")(149,"td")(150,"code"),e._uU(151,"methods"),e.qZA()(),e.TgZ(152,"td"),e._uU(153,"Display all public methods available on a given provider or controller."),e.qZA(),e.TgZ(154,"td")(155,"code"),e._uU(156,"methods(token: ClassRef | string) => void"),e.qZA()()(),e.TgZ(157,"tr")(158,"td")(159,"code"),e._uU(160,"resolve"),e.qZA()(),e.TgZ(161,"td"),e._uU(162,"Resolves transient or request-scoped instance of either injectable or controller, otherwise, throws exception."),e.qZA(),e.TgZ(163,"td")(164,"code"),e._uU(165,"resolve(token: InjectionToken, contextId: any) => Promise<any>"),e.qZA()()(),e.TgZ(166,"tr")(167,"td")(168,"code"),e._uU(169,"select"),e.qZA()(),e.TgZ(170,"td"),e._uU(171,"Allows navigating through the modules tree, for example, to pull out a specific instance from the selected module."),e.qZA(),e.TgZ(172,"td")(173,"code"),e._uU(174,"select(token: DynamicModule | ClassRef) => INestApplicationContext"),e.qZA()()()()(),e.TgZ(175,"h4",17)(176,"span"),e._uU(177,"Watch mode"),e.qZA()(),e.TgZ(178,"p"),e._uU(179,"During development it is useful to run REPL in a watch mode to reflect all the code changes automatically:"),e.qZA(),e.TgZ(180,"pre")(181,"code",10),e._uU(182,"\n$ npm run start -- --watch --entryFile repl\n"),e.qZA()(),e.TgZ(183,"p"),e._uU(184,"This has one flaw, the REPL's command history is discarded after each reload which might be cumbersome.\nFortunately, there is a very simple solution. Modify your "),e.TgZ(185,"code"),e._uU(186,"bootstrap"),e.qZA(),e._uU(187," function like this:"),e.qZA(),e.TgZ(188,"pre")(189,"code",9),e._uU(190,'\nasync function bootstrap() {\n  const replServer = await repl(AppModule);\n  replServer.setupHistory(".nestjs_repl_history", (err) => {\n    if (err) {\n      console.error(err);\n    }\n  });\n}\n'),e.qZA()(),e.TgZ(191,"p"),e._uU(192,"Now the history is preserved between the runs/reloads."),e.qZA()()),2&n){const r=e.MAs(24);e.xp6(21),e.hij(" ",e.xi3(22,5,"repl",r.isJsActive),"\n"),e.xp6(4),e.ekj("hide",r.isJsActive),e.xp6(3),e.ekj("hide",!r.isJsActive)}},dependencies:[Z.n,d.U,m.F],encapsulation:2,changeDetection:0}));class j extends l.y{}(0,s.Z)(j,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(j)))(o||j)}}()),(0,s.Z)(j,"\u0275cmp",e.Xpm({type:j,selectors:[["app-serve-static"]],features:[e.qOj],decls:80,vars:0,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/serve-static.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","serve-static"],["rel","nofollow","target","_blank","href","https://www.npmjs.com/package/@nestjs/serve-static"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","bootstrap"],[1,"language-typescript"],["appAnchor","","id","configuration"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/serve-static"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/serve-static/blob/master/lib/interfaces/serve-static-options.interface.ts"],[1,"warning"],["appAnchor","","id","example"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/24-serve-static"]],template:function(n,o){1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"Serve Static"),e.qZA(),e.TgZ(7,"p"),e._uU(8,"In order to serve static content like a Single Page Application (SPA) we can use the "),e.TgZ(9,"code"),e._uU(10,"ServeStaticModule"),e.qZA(),e._uU(11," from the "),e.TgZ(12,"a",6)(13,"code"),e._uU(14,"@nestjs/serve-static"),e.qZA()(),e._uU(15," package."),e.qZA(),e.TgZ(16,"h4",7)(17,"span"),e._uU(18,"Installation"),e.qZA()(),e.TgZ(19,"p"),e._uU(20,"First we need to install the required package:"),e.qZA(),e.TgZ(21,"pre")(22,"code",8),e._uU(23,"\n$ npm install --save @nestjs/serve-static\n"),e.qZA()(),e.TgZ(24,"h4",9)(25,"span"),e._uU(26,"Bootstrap"),e.qZA()(),e.TgZ(27,"p"),e._uU(28,"Once the installation process is done, we can import the "),e.TgZ(29,"code"),e._uU(30,"ServeStaticModule"),e.qZA(),e._uU(31," into the root "),e.TgZ(32,"code"),e._uU(33,"AppModule"),e.qZA(),e._uU(34," and configure it by passing in a configuration object to the "),e.TgZ(35,"code"),e._uU(36,"forRoot()"),e.qZA(),e._uU(37," method."),e.qZA(),e.TgZ(38,"pre")(39,"code",10),e._uU(40,"\nimport { Module } from '@nestjs/common';\nimport { AppController } from './app.controller';\nimport { AppService } from './app.service';\nimport { ServeStaticModule } from '@nestjs/serve-static';\nimport { join } from 'path';\n\n@Module({\n  imports: [\n    ServeStaticModule.forRoot({\n      rootPath: join(__dirname, '..', 'client'),\n    }),\n  ],\n  controllers: [AppController],\n  providers: [AppService],\n})\nexport class AppModule {}\n"),e.qZA()(),e.TgZ(41,"p"),e._uU(42,"With this in place, build the static website and place its content in the location specified by the "),e.TgZ(43,"code"),e._uU(44,"rootPath"),e.qZA(),e._uU(45," property."),e.qZA(),e.TgZ(46,"h4",11)(47,"span"),e._uU(48,"Configuration"),e.qZA()(),e.TgZ(49,"p")(50,"a",12),e._uU(51,"ServeStaticModule"),e.qZA(),e._uU(52," can be configured with a variety of options to customize its behavior.\nYou can set the path to render your static app, specify excluded paths, enable or disable setting Cache-Control response header, etc. See the full list of options "),e.TgZ(53,"a",13),e._uU(54,"here"),e.qZA(),e._uU(55,"."),e.qZA(),e.TgZ(56,"blockquote",14)(57,"strong"),e._uU(58,"Notice"),e.qZA(),e._uU(59," The default "),e.TgZ(60,"code"),e._uU(61,"renderPath"),e.qZA(),e._uU(62," of the Static App is "),e.TgZ(63,"code"),e._uU(64,"*"),e.qZA(),e._uU(65,' (all paths), and the module will send "index.html" files in response.\nIt lets you create Client-Side routing for your SPA. Paths, specified in your controllers will fallback to the server.\nYou can change this behavior setting '),e.TgZ(66,"code"),e._uU(67,"serveRoot"),e.qZA(),e._uU(68,", "),e.TgZ(69,"code"),e._uU(70,"renderPath"),e.qZA(),e._uU(71," combining them with other options.\n"),e.qZA(),e.TgZ(72,"h4",15)(73,"span"),e._uU(74,"Example"),e.qZA()(),e.TgZ(75,"p"),e._uU(76,"A working example is available "),e.TgZ(77,"a",16),e._uU(78,"here"),e.qZA(),e._uU(79,"."),e.qZA()())},dependencies:[d.U],encapsulation:2,changeDetection:0}));class C extends l.y{}(0,s.Z)(C,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(C)))(o||C)}}()),(0,s.Z)(C,"\u0275cmp",e.Xpm({type:C,selectors:[["app-sql-sequelize"]],features:[e.qOj],decls:203,vars:20,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/sql-sequelize.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","sql-sequelize"],["id","this-chapter-applies-only-to-typescript"],[1,""],["href","/techniques/database#sequelize-integration"],["rel","nofollow","target","_blank","href","https://github.com/sequelize/sequelize"],["rel","nofollow","target","_blank","href","https://github.com/RobinBuschmann/sequelize-typescript"],["appAnchor","","id","getting-started"],[1,"language-bash"],[1,"filename"],["app0caf8c342b44f7a7589b8b9d64272cf2e88628d6",""],[1,"language-typescript"],[1,"info"],["appAnchor","","id","model-injection"],["app757bcd39f2e16b7405c116c93bba06668cda92c7",""],["appcacc36d9a5ab5163d0c5b68c2c82ab7e48e37fe2",""],[1,"warning"],["appdf596cdb48680c8d6d7499a63b1ada0471c5422a",""],["appc9365268b0af11445f9f7cb040419cfa965a1fab",""]],template:function(n,o){if(1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"SQL (Sequelize)"),e.qZA(),e.TgZ(7,"h5",6),e._uU(8,"This chapter applies only to TypeScript"),e.qZA(),e.TgZ(9,"blockquote",7)(10,"strong"),e._uU(11,"Warning"),e.qZA(),e._uU(12," In this article, you'll learn how to create a "),e.TgZ(13,"code"),e._uU(14,"DatabaseModule"),e.qZA(),e._uU(15," based on the "),e.TgZ(16,"strong"),e._uU(17,"Sequelize"),e.qZA(),e._uU(18," package from scratch using custom components. As a consequence, this technique contains a lot of overhead that you can avoid by using the dedicated, out-of-the-box "),e.TgZ(19,"code"),e._uU(20,"@nestjs/sequelize"),e.qZA(),e._uU(21," package. To learn more, see "),e.TgZ(22,"a",8),e._uU(23,"here"),e.qZA(),e._uU(24,".\n"),e.qZA(),e.TgZ(25,"p")(26,"a",9),e._uU(27,"Sequelize"),e.qZA(),e._uU(28," is a popular Object Relational Mapper (ORM) written in a vanilla JavaScript, but there is a "),e.TgZ(29,"a",10),e._uU(30,"sequelize-typescript"),e.qZA(),e._uU(31," TypeScript wrapper which provides a set of decorators and other extras for the base sequelize."),e.qZA(),e.TgZ(32,"h4",11)(33,"span"),e._uU(34,"Getting started"),e.qZA()(),e.TgZ(35,"p"),e._uU(36,"To start the adventure with this library we have to install the following dependencies:"),e.qZA(),e.TgZ(37,"pre")(38,"code",12),e._uU(39,"\n$ npm install --save sequelize sequelize-typescript mysql2\n$ npm install --save-dev @types/sequelize\n"),e.qZA()(),e.TgZ(40,"p"),e._uU(41,"The first step we need to do is create a "),e.TgZ(42,"strong"),e._uU(43,"Sequelize"),e.qZA(),e._uU(44," instance with an options object passed into the constructor. Also, we need to add all models (the alternative is to use "),e.TgZ(45,"code"),e._uU(46,"modelPaths"),e.qZA(),e._uU(47," property) and "),e.TgZ(48,"code"),e._uU(49,"sync()"),e.qZA(),e._uU(50," our database tables."),e.qZA(),e.TgZ(51,"span",13),e._uU(52),e.ALo(53,"extension"),e._UZ(54,"app-tabs",null,14),e.qZA(),e.TgZ(56,"pre")(57,"code",15),e._uU(58,"\nimport { Sequelize } from 'sequelize-typescript';\nimport { Cat } from '../cats/cat.entity';\n\nexport const databaseProviders = [\n  {\n    provide: 'SEQUELIZE',\n    useFactory: async () => {\n      const sequelize = new Sequelize({\n        dialect: 'mysql',\n        host: 'localhost',\n        port: 3306,\n        username: 'root',\n        password: 'password',\n        database: 'nest',\n      });\n      sequelize.addModels([Cat]);\n      await sequelize.sync();\n      return sequelize;\n    },\n  },\n];\n"),e.qZA()(),e.TgZ(59,"blockquote",16)(60,"strong"),e._uU(61,"Hint"),e.qZA(),e._uU(62," Following best practices, we declared the custom provider in the separated file which has a "),e.TgZ(63,"code"),e._uU(64,"*.providers.ts"),e.qZA(),e._uU(65," suffix.\n"),e.qZA(),e.TgZ(66,"p"),e._uU(67,"Then, we need to export these providers to make them "),e.TgZ(68,"strong"),e._uU(69,"accessible"),e.qZA(),e._uU(70," for the rest part of the application."),e.qZA(),e.TgZ(71,"pre")(72,"code",15),e._uU(73,"\nimport { Module } from '@nestjs/common';\nimport { databaseProviders } from './database.providers';\n\n@Module({\n  providers: [...databaseProviders],\n  exports: [...databaseProviders],\n})\nexport class DatabaseModule {}\n"),e.qZA()(),e.TgZ(74,"p"),e._uU(75,"Now we can inject the "),e.TgZ(76,"code"),e._uU(77,"Sequelize"),e.qZA(),e._uU(78," object using "),e.TgZ(79,"code"),e._uU(80,"@Inject()"),e.qZA(),e._uU(81," decorator. Each class that would depend on the "),e.TgZ(82,"code"),e._uU(83,"Sequelize"),e.qZA(),e._uU(84," async provider will wait until a "),e.TgZ(85,"code"),e._uU(86,"Promise"),e.qZA(),e._uU(87," is resolved."),e.qZA(),e.TgZ(88,"h4",17)(89,"span"),e._uU(90,"Model injection"),e.qZA()(),e.TgZ(91,"p"),e._uU(92,"In "),e.TgZ(93,"a",9),e._uU(94,"Sequelize"),e.qZA(),e._uU(95," the "),e.TgZ(96,"strong"),e._uU(97,"Model"),e.qZA(),e._uU(98," defines a table in the database. Instances of this class represent a database row. Firstly, we need at least one entity:"),e.qZA(),e.TgZ(99,"span",13),e._uU(100),e.ALo(101,"extension"),e._UZ(102,"app-tabs",null,18),e.qZA(),e.TgZ(104,"pre")(105,"code",15),e._uU(106,"\nimport { Table, Column, Model } from 'sequelize-typescript';\n\n@Table\nexport class Cat extends Model {\n  @Column\n  name: string;\n\n  @Column\n  age: number;\n\n  @Column\n  breed: string;\n}\n"),e.qZA()(),e.TgZ(107,"p"),e._uU(108,"The "),e.TgZ(109,"code"),e._uU(110,"Cat"),e.qZA(),e._uU(111," entity belongs to the "),e.TgZ(112,"code"),e._uU(113,"cats"),e.qZA(),e._uU(114," directory. This directory represents the "),e.TgZ(115,"code"),e._uU(116,"CatsModule"),e.qZA(),e._uU(117,". Now it's time to create a "),e.TgZ(118,"strong"),e._uU(119,"Repository"),e.qZA(),e._uU(120," provider:"),e.qZA(),e.TgZ(121,"span",13),e._uU(122),e.ALo(123,"extension"),e._UZ(124,"app-tabs",null,19),e.qZA(),e.TgZ(126,"pre")(127,"code",15),e._uU(128,"\nimport { Cat } from './cat.entity';\n\nexport const catsProviders = [\n  {\n    provide: 'CATS_REPOSITORY',\n    useValue: Cat,\n  },\n];\n"),e.qZA()(),e.TgZ(129,"blockquote",20)(130,"strong"),e._uU(131,"Warning"),e.qZA(),e._uU(132," In the real-world applications you should avoid "),e.TgZ(133,"strong"),e._uU(134,"magic strings"),e.qZA(),e._uU(135,". Both "),e.TgZ(136,"code"),e._uU(137,"CATS_REPOSITORY"),e.qZA(),e._uU(138," and "),e.TgZ(139,"code"),e._uU(140,"SEQUELIZE"),e.qZA(),e._uU(141," should be kept in the separated "),e.TgZ(142,"code"),e._uU(143,"constants.ts"),e.qZA(),e._uU(144," file.\n"),e.qZA(),e.TgZ(145,"p"),e._uU(146,"In Sequelize, we use static methods to manipulate the data, and thus we created an "),e.TgZ(147,"strong"),e._uU(148,"alias"),e.qZA(),e._uU(149," here."),e.qZA(),e.TgZ(150,"p"),e._uU(151,"Now we can inject the "),e.TgZ(152,"code"),e._uU(153,"CATS_REPOSITORY"),e.qZA(),e._uU(154," to the "),e.TgZ(155,"code"),e._uU(156,"CatsService"),e.qZA(),e._uU(157," using the "),e.TgZ(158,"code"),e._uU(159,"@Inject()"),e.qZA(),e._uU(160," decorator:"),e.qZA(),e.TgZ(161,"span",13),e._uU(162),e.ALo(163,"extension"),e._UZ(164,"app-tabs",null,21),e.qZA(),e.TgZ(166,"pre")(167,"code",15),e._uU(168,"\nimport { Injectable, Inject } from '@nestjs/common';\nimport { CreateCatDto } from './dto/create-cat.dto';\nimport { Cat } from './cat.entity';\n\n@Injectable()\nexport class CatsService {\n  constructor(\n    @Inject('CATS_REPOSITORY')\n    private catsRepository: typeof Cat\n  ) {}\n\n  async findAll(): Promise<Cat[]> {\n    return this.catsRepository.findAll<Cat>();\n  }\n}\n"),e.qZA()(),e.TgZ(169,"p"),e._uU(170,"The database connection is "),e.TgZ(171,"strong"),e._uU(172,"asynchronous"),e.qZA(),e._uU(173,", but Nest makes this process completely invisible for the end-user. The "),e.TgZ(174,"code"),e._uU(175,"CATS_REPOSITORY"),e.qZA(),e._uU(176," provider is waiting for the db connection, and the "),e.TgZ(177,"code"),e._uU(178,"CatsService"),e.qZA(),e._uU(179," is delayed until repository is ready to use. The entire application can start when each class is instantiated."),e.qZA(),e.TgZ(180,"p"),e._uU(181,"Here is a final "),e.TgZ(182,"code"),e._uU(183,"CatsModule"),e.qZA(),e._uU(184,":"),e.qZA(),e.TgZ(185,"span",13),e._uU(186),e.ALo(187,"extension"),e._UZ(188,"app-tabs",null,22),e.qZA(),e.TgZ(190,"pre")(191,"code",15),e._uU(192,"\nimport { Module } from '@nestjs/common';\nimport { CatsController } from './cats.controller';\nimport { CatsService } from './cats.service';\nimport { catsProviders } from './cats.providers';\nimport { DatabaseModule } from '../database/database.module';\n\n@Module({\n  imports: [DatabaseModule],\n  controllers: [CatsController],\n  providers: [\n    CatsService,\n    ...catsProviders,\n  ],\n})\nexport class CatsModule {}\n"),e.qZA()(),e.TgZ(193,"blockquote",16)(194,"strong"),e._uU(195,"Hint"),e.qZA(),e._uU(196," Do not forget to import the "),e.TgZ(197,"code"),e._uU(198,"CatsModule"),e.qZA(),e._uU(199," into the root "),e.TgZ(200,"code"),e._uU(201,"AppModule"),e.qZA(),e._uU(202,".\n"),e.qZA()()),2&n){const r=e.MAs(55),a=e.MAs(103),u=e.MAs(125),c=e.MAs(165),i=e.MAs(189);e.xp6(52),e.hij(" ",e.xi3(53,5,"database.providers",r.isJsActive),"\n"),e.xp6(48),e.hij(" ",e.xi3(101,8,"cat.entity",a.isJsActive),"\n"),e.xp6(22),e.hij(" ",e.xi3(123,11,"cats.providers",u.isJsActive),"\n"),e.xp6(40),e.hij(" ",e.xi3(163,14,"cats.service",c.isJsActive),"\n"),e.xp6(24),e.hij(" ",e.xi3(187,17,"cats.module",i.isJsActive),"\n")}},dependencies:[Z.n,d.U,m.F],encapsulation:2,changeDetection:0}));class I extends l.y{}(0,s.Z)(I,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(I)))(o||I)}}()),(0,s.Z)(I,"\u0275cmp",e.Xpm({type:I,selectors:[["app-sql-typeorm"]],features:[e.qOj],decls:215,vars:24,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/sql-typeorm.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","sql-typeorm"],["id","this-chapter-applies-only-to-typescript"],[1,""],["routerLink","/techniques/sql"],["rel","nofollow","target","_blank","href","https://github.com/typeorm/typeorm"],["appAnchor","","id","getting-started"],[1,"language-bash"],["routerLink","/fundamentals/async-components"],[1,"filename"],["appdc294205b82a2fc611238fd2394d0db6d856ee42",""],[1,"language-typescript"],[1,"warning"],[1,"info"],["appa4b6200ecfc38ce9b18045c871bb46a60aa5dfdf",""],["appAnchor","","id","repository-pattern"],["appec9a9c43614c5b2e2fad9cb572e62366d29ec980",""],["appd4fe4896904cd83afd072d5fb505366b2ffb5f6a",""],["appa04a3fe5404daf0a584d96b1bad5c7e548e11dd3",""],["app67268bf1c086f0fcbe34b55543a5ab92126ad73a",""]],template:function(n,o){if(1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"SQL (TypeORM)"),e.qZA(),e.TgZ(7,"h5",6),e._uU(8,"This chapter applies only to TypeScript"),e.qZA(),e.TgZ(9,"blockquote",7)(10,"strong"),e._uU(11,"Warning"),e.qZA(),e._uU(12," In this article, you'll learn how to create a "),e.TgZ(13,"code"),e._uU(14,"DatabaseModule"),e.qZA(),e._uU(15," based on the "),e.TgZ(16,"strong"),e._uU(17,"TypeORM"),e.qZA(),e._uU(18," package from scratch using custom providers mechanism. As a consequence, this solution contains a lot of overhead that you can omit using ready to use and available out-of-the-box dedicated "),e.TgZ(19,"code"),e._uU(20,"@nestjs/typeorm"),e.qZA(),e._uU(21," package. To learn more, see "),e.TgZ(22,"a",8),e._uU(23,"here"),e.qZA(),e._uU(24,".\n"),e.qZA(),e.TgZ(25,"p")(26,"a",9),e._uU(27,"TypeORM"),e.qZA(),e._uU(28," is definitely the most mature Object Relational Mapper (ORM) available in the node.js world. Since it's written in TypeScript, it works pretty well with the Nest framework."),e.qZA(),e.TgZ(29,"h4",10)(30,"span"),e._uU(31,"Getting started"),e.qZA()(),e.TgZ(32,"p"),e._uU(33,"To start the adventure with this library we have to install all required dependencies:"),e.qZA(),e.TgZ(34,"pre")(35,"code",11),e._uU(36,"\n$ npm install --save typeorm mysql2\n"),e.qZA()(),e.TgZ(37,"p"),e._uU(38,"The first step we need to do is to establish the connection with our database using "),e.TgZ(39,"code"),e._uU(40,"new DataSource().initialize()"),e.qZA(),e._uU(41," class imported from the "),e.TgZ(42,"code"),e._uU(43,"typeorm"),e.qZA(),e._uU(44," package. The "),e.TgZ(45,"code"),e._uU(46,"initialize()"),e.qZA(),e._uU(47," function returns a "),e.TgZ(48,"code"),e._uU(49,"Promise"),e.qZA(),e._uU(50,", and therefore we have to create an "),e.TgZ(51,"a",12),e._uU(52,"async provider"),e.qZA(),e._uU(53,"."),e.qZA(),e.TgZ(54,"span",13),e._uU(55),e.ALo(56,"extension"),e._UZ(57,"app-tabs",null,14),e.qZA(),e.TgZ(59,"pre")(60,"code",15),e._uU(61,"\nimport { DataSource } from 'typeorm';\n\nexport const databaseProviders = [\n  {\n    provide: 'DATA_SOURCE',\n    useFactory: async () => {\n      const dataSource = new DataSource({\n        type: 'mysql',\n        host: 'localhost',\n        port: 3306,\n        username: 'root',\n        password: 'root',\n        database: 'test',\n        entities: [\n            __dirname + '/../**/*.entity{.ts,.js}',\n        ],\n        synchronize: true,\n      });\n\n      return dataSource.initialize();\n    },\n  },\n];\n"),e.qZA()(),e.TgZ(62,"blockquote",16)(63,"strong"),e._uU(64,"Warning"),e.qZA(),e._uU(65," Setting "),e.TgZ(66,"code"),e._uU(67,"synchronize: true"),e.qZA(),e._uU(68," shouldn't be used in production - otherwise you can lose production data.\n"),e.qZA(),e.TgZ(69,"blockquote",17)(70,"strong"),e._uU(71,"Hint"),e.qZA(),e._uU(72," Following best practices, we declared the custom provider in the separated file which has a "),e.TgZ(73,"code"),e._uU(74,"*.providers.ts"),e.qZA(),e._uU(75," suffix.\n"),e.qZA(),e.TgZ(76,"p"),e._uU(77,"Then, we need to export these providers to make them "),e.TgZ(78,"strong"),e._uU(79,"accessible"),e.qZA(),e._uU(80," for the rest of the application."),e.qZA(),e.TgZ(81,"span",13),e._uU(82),e.ALo(83,"extension"),e._UZ(84,"app-tabs",null,18),e.qZA(),e.TgZ(86,"pre")(87,"code",15),e._uU(88,"\nimport { Module } from '@nestjs/common';\nimport { databaseProviders } from './database.providers';\n\n@Module({\n  providers: [...databaseProviders],\n  exports: [...databaseProviders],\n})\nexport class DatabaseModule {}\n"),e.qZA()(),e.TgZ(89,"p"),e._uU(90,"Now we can inject the "),e.TgZ(91,"code"),e._uU(92,"DATA_SOURCE"),e.qZA(),e._uU(93," object using "),e.TgZ(94,"code"),e._uU(95,"@Inject()"),e.qZA(),e._uU(96," decorator. Each class that would depend on the "),e.TgZ(97,"code"),e._uU(98,"DATA_SOURCE"),e.qZA(),e._uU(99," async provider will wait until a "),e.TgZ(100,"code"),e._uU(101,"Promise"),e.qZA(),e._uU(102," is resolved."),e.qZA(),e.TgZ(103,"h4",19)(104,"span"),e._uU(105,"Repository pattern"),e.qZA()(),e.TgZ(106,"p"),e._uU(107,"The "),e.TgZ(108,"a",9),e._uU(109,"TypeORM"),e.qZA(),e._uU(110," supports the repository design pattern, thus each entity has its own Repository. These repositories can be obtained from the database connection."),e.qZA(),e.TgZ(111,"p"),e._uU(112,"But firstly, we need at least one entity. We are going to reuse the "),e.TgZ(113,"code"),e._uU(114,"Photo"),e.qZA(),e._uU(115," entity from the official documentation."),e.qZA(),e.TgZ(116,"span",13),e._uU(117),e.ALo(118,"extension"),e._UZ(119,"app-tabs",null,20),e.qZA(),e.TgZ(121,"pre")(122,"code",15),e._uU(123,"\nimport { Entity, Column, PrimaryGeneratedColumn } from 'typeorm';\n\n@Entity()\nexport class Photo {\n  @PrimaryGeneratedColumn()\n  id: number;\n\n  @Column({ length: 500 })\n  name: string;\n\n  @Column('text')\n  description: string;\n\n  @Column()\n  filename: string;\n\n  @Column('int')\n  views: number;\n\n  @Column()\n  isPublished: boolean;\n}\n"),e.qZA()(),e.TgZ(124,"p"),e._uU(125,"The "),e.TgZ(126,"code"),e._uU(127,"Photo"),e.qZA(),e._uU(128," entity belongs to the "),e.TgZ(129,"code"),e._uU(130,"photo"),e.qZA(),e._uU(131," directory. This directory represents the "),e.TgZ(132,"code"),e._uU(133,"PhotoModule"),e.qZA(),e._uU(134,". Now, let's create a "),e.TgZ(135,"strong"),e._uU(136,"Repository"),e.qZA(),e._uU(137," provider:"),e.qZA(),e.TgZ(138,"span",13),e._uU(139),e.ALo(140,"extension"),e._UZ(141,"app-tabs",null,21),e.qZA(),e.TgZ(143,"pre")(144,"code",15),e._uU(145,"\nimport { DataSource } from 'typeorm';\nimport { Photo } from './photo.entity';\n\nexport const photoProviders = [\n  {\n    provide: 'PHOTO_REPOSITORY',\n    useFactory: (dataSource: DataSource) => dataSource.getRepository(Photo),\n    inject: ['DATA_SOURCE'],\n  },\n];\n"),e.qZA()(),e.TgZ(146,"blockquote",16)(147,"strong"),e._uU(148,"Warning"),e.qZA(),e._uU(149," In the real-world applications you should avoid "),e.TgZ(150,"strong"),e._uU(151,"magic strings"),e.qZA(),e._uU(152,". Both "),e.TgZ(153,"code"),e._uU(154,"PHOTO_REPOSITORY"),e.qZA(),e._uU(155," and "),e.TgZ(156,"code"),e._uU(157,"DATA_SOURCE"),e.qZA(),e._uU(158," should be kept in the separated "),e.TgZ(159,"code"),e._uU(160,"constants.ts"),e.qZA(),e._uU(161," file.\n"),e.qZA(),e.TgZ(162,"p"),e._uU(163,"Now we can inject the "),e.TgZ(164,"code"),e._uU(165,"Repository<Photo>"),e.qZA(),e._uU(166," to the "),e.TgZ(167,"code"),e._uU(168,"PhotoService"),e.qZA(),e._uU(169," using the "),e.TgZ(170,"code"),e._uU(171,"@Inject()"),e.qZA(),e._uU(172," decorator:"),e.qZA(),e.TgZ(173,"span",13),e._uU(174),e.ALo(175,"extension"),e._UZ(176,"app-tabs",null,22),e.qZA(),e.TgZ(178,"pre")(179,"code",15),e._uU(180,"\nimport { Injectable, Inject } from '@nestjs/common';\nimport { Repository } from 'typeorm';\nimport { Photo } from './photo.entity';\n\n@Injectable()\nexport class PhotoService {\n  constructor(\n    @Inject('PHOTO_REPOSITORY')\n    private photoRepository: Repository<Photo>,\n  ) {}\n\n  async findAll(): Promise<Photo[]> {\n    return this.photoRepository.find();\n  }\n}\n"),e.qZA()(),e.TgZ(181,"p"),e._uU(182,"The database connection is "),e.TgZ(183,"strong"),e._uU(184,"asynchronous"),e.qZA(),e._uU(185,", but Nest makes this process completely invisible for the end-user. The "),e.TgZ(186,"code"),e._uU(187,"PhotoRepository"),e.qZA(),e._uU(188," is waiting for the db connection, and the "),e.TgZ(189,"code"),e._uU(190,"PhotoService"),e.qZA(),e._uU(191," is delayed until repository is ready to use. The entire application can start when each class is instantiated."),e.qZA(),e.TgZ(192,"p"),e._uU(193,"Here is a final "),e.TgZ(194,"code"),e._uU(195,"PhotoModule"),e.qZA(),e._uU(196,":"),e.qZA(),e.TgZ(197,"span",13),e._uU(198),e.ALo(199,"extension"),e._UZ(200,"app-tabs",null,23),e.qZA(),e.TgZ(202,"pre")(203,"code",15),e._uU(204,"\nimport { Module } from '@nestjs/common';\nimport { DatabaseModule } from '../database/database.module';\nimport { photoProviders } from './photo.providers';\nimport { PhotoService } from './photo.service';\n\n@Module({\n  imports: [DatabaseModule],\n  providers: [\n    ...photoProviders,\n    PhotoService,\n  ],\n})\nexport class PhotoModule {}\n"),e.qZA()(),e.TgZ(205,"blockquote",17)(206,"strong"),e._uU(207,"Hint"),e.qZA(),e._uU(208," Do not forget to import the "),e.TgZ(209,"code"),e._uU(210,"PhotoModule"),e.qZA(),e._uU(211," into the root "),e.TgZ(212,"code"),e._uU(213,"AppModule"),e.qZA(),e._uU(214,".\n"),e.qZA()()),2&n){const r=e.MAs(58),a=e.MAs(85),u=e.MAs(120),c=e.MAs(142),i=e.MAs(177),p=e.MAs(201);e.xp6(55),e.hij(" ",e.xi3(56,6,"database.providers",r.isJsActive),"\n"),e.xp6(27),e.hij(" ",e.xi3(83,9,"database.module",a.isJsActive),"\n"),e.xp6(35),e.hij(" ",e.xi3(118,12,"photo.entity",u.isJsActive),"\n"),e.xp6(22),e.hij(" ",e.xi3(140,15,"photo.providers",c.isJsActive),"\n"),e.xp6(35),e.hij(" ",e.xi3(175,18,"photo.service",i.isJsActive),"\n"),e.xp6(24),e.hij(" ",e.xi3(199,21,"photo.module",p.isJsActive),"\n")}},dependencies:[Z.n,d.U,g.rH,m.F],encapsulation:2,changeDetection:0}));class M extends l.y{}(0,s.Z)(M,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(M)))(o||M)}}()),(0,s.Z)(M,"\u0275cmp",e.Xpm({type:M,selectors:[["app-terminus"]],features:[e.qOj],decls:613,vars:96,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/terminus.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","healthchecks-terminus"],["appAnchor","","id","getting-started"],[1,"language-bash"],["appAnchor","","id","setting-up-a-healthcheck"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/terminus"],[1,"info"],["routerLink","cli/overview"],[1,"filename"],["app6cad06d42c66732118314ff8776bf23cbf9b3224",""],[1,"language-typescript"],["routerLink","/controllers"],["href","fundamentals/lifecycle-events#application-shutdown"],["appAnchor","","id","http-healthcheck"],["appdba40c2f1b45a2dcb6924f0a1daedaa661c8ae8d",""],["app88faa5455b52792e60760c760c498b4088f8e901",""],[1,"language-json"],["id","check-for-specific-http-response-codes"],["app50b7ea3c22c4bb057e6adc37f65c36d57c0b1d51",""],["appAnchor","","id","typeorm-health-indicator"],["routerLink","/techniques/sql"],["appcd7f002d83cc64c6cf47aec2a07a727176122cfa",""],["href","techniques/database#multiple-databases"],["app31843e22cc079baa52fc8b31b2b1dd3739d6d37b",""],["appAnchor","","id","disk-health-indicator"],["app8ce931e186808963e574176b4facf142e578fcc4",""],["app466d91d032da18f625a39b36544eadebd4f89f6f",""],["appAnchor","","id","memory-health-indicator"],["appf9c5a426264afb92e5f95fe9a3d427995aa6fe6b",""],["app3457b374003e86888a1e876d7e74b43ec982eb24",""],["appAnchor","","id","custom-health-indicator"],["app2cd3247865bfd6b5c9f77b55f50438b83cf85c44",""],["app2d2ef5a85ccbf001f7e8b80cee48338236a8992e",""],["app54691230c2a0a7b2b9dd6d1e625a34a4073d9996",""],["appAnchor","","id","logging"],["href","/techniques/logger#injecting-a-custom-logger"],["appab7f88b8e7edbe57d6c54deff38eb0b57f8bbc7e",""],["appebcd8807889e2144c5776665b8bb295dbe8d23d1",""],["appc0d4040452d67c23d0f6308e4cabe8a81cd48210",""],["align","left"],["src","/assets/Terminus_Error_Log_Json.png"],["src","/assets/Terminus_Error_Log_Pretty.png"],["app0549a920aa9df9615c2fdaf6f5cdcf6bef62e78b",""],["appAnchor","","id","more-examples"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/terminus/tree/master/sample"]],template:function(n,o){if(1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"Healthchecks (Terminus)"),e.qZA(),e.TgZ(7,"p"),e._uU(8,"Terminus integration provides you with "),e.TgZ(9,"strong"),e._uU(10,"readiness/liveness"),e.qZA(),e._uU(11," health checks. Healthchecks are crucial when it comes to complex\nbackend setups. In a nutshell, a health check in the realm of web development usually consists of a special address, for example, "),e.TgZ(12,"code"),e._uU(13,"https://my-website.com/health/readiness"),e.qZA(),e._uU(14,".\nA service or a component of your infrastructure (e.g., Kubernetes) checks this address continuously. Depending on the HTTP status code returned from a "),e.TgZ(15,"code"),e._uU(16,"GET"),e.qZA(),e._uU(17,' request to this address the service will take action when it receives an "unhealthy" response.\nSince the definition of "healthy" or "unhealthy" varies with the type of service you provide, the '),e.TgZ(18,"strong"),e._uU(19,"Terminus"),e.qZA(),e._uU(20," integration supports you with a\nset of "),e.TgZ(21,"strong"),e._uU(22,"health indicators"),e.qZA(),e._uU(23,"."),e.qZA(),e.TgZ(24,"p"),e._uU(25,"As an example, if your web server uses MongoDB to store its data, it would be vital information whether MongoDB is still up and running.\nIn that case, you can make use of the "),e.TgZ(26,"code"),e._uU(27,"MongooseHealthIndicator"),e.qZA(),e._uU(28,". If configured correctly - more on that later - your health check address will return\na healthy or unhealthy HTTP status code, depending on whether MongoDB is running."),e.qZA(),e.TgZ(29,"h4",6)(30,"span"),e._uU(31,"Getting started"),e.qZA()(),e.TgZ(32,"p"),e._uU(33,"To get started with "),e.TgZ(34,"code"),e._uU(35,"@nestjs/terminus"),e.qZA(),e._uU(36," we need to install the required dependency."),e.qZA(),e.TgZ(37,"pre")(38,"code",7),e._uU(39,"\n$ npm install --save @nestjs/terminus\n"),e.qZA()(),e.TgZ(40,"h4",8)(41,"span"),e._uU(42,"Setting up a Healthcheck"),e.qZA()(),e.TgZ(43,"p"),e._uU(44,"A health check represents a summary of "),e.TgZ(45,"strong"),e._uU(46,"health indicators"),e.qZA(),e._uU(47,". A health indicator executes a check of a service, whether it is in a healthy or unhealthy state. A health check is positive if all the assigned health indicators are up and running. Because a lot of applications will need similar health indicators, "),e.TgZ(48,"a",9)(49,"code"),e._uU(50,"@nestjs/terminus"),e.qZA()(),e._uU(51," provides a set of predefined indicators, such as:"),e.qZA(),e.TgZ(52,"ul")(53,"li")(54,"code"),e._uU(55,"HttpHealthIndicator"),e.qZA()(),e.TgZ(56,"li")(57,"code"),e._uU(58,"TypeOrmHealthIndicator"),e.qZA()(),e.TgZ(59,"li")(60,"code"),e._uU(61,"MongooseHealthIndicator"),e.qZA()(),e.TgZ(62,"li")(63,"code"),e._uU(64,"SequelizeHealthIndicator"),e.qZA()(),e.TgZ(65,"li")(66,"code"),e._uU(67,"MikroOrmHealthIndicator"),e.qZA()(),e.TgZ(68,"li")(69,"code"),e._uU(70,"MicroserviceHealthIndicator"),e.qZA()(),e.TgZ(71,"li")(72,"code"),e._uU(73,"GRPCHealthIndicator"),e.qZA()(),e.TgZ(74,"li")(75,"code"),e._uU(76,"MemoryHealthIndicator"),e.qZA()(),e.TgZ(77,"li")(78,"code"),e._uU(79,"DiskHealthIndicator"),e.qZA()()(),e.TgZ(80,"p"),e._uU(81,"To get started with our first health check, let's create the "),e.TgZ(82,"code"),e._uU(83,"HealthModule"),e.qZA(),e._uU(84," and import the "),e.TgZ(85,"code"),e._uU(86,"TerminusModule"),e.qZA(),e._uU(87," into it in its imports array."),e.qZA(),e.TgZ(88,"blockquote",10)(89,"strong"),e._uU(90,"Hint"),e.qZA(),e._uU(91," To create the module using the "),e.TgZ(92,"a",11),e._uU(93,"Nest CLI"),e.qZA(),e._uU(94,", simply execute the "),e.TgZ(95,"code"),e._uU(96,"$ nest g module health"),e.qZA(),e._uU(97," command.\n"),e.qZA(),e.TgZ(98,"span",12),e._uU(99),e.ALo(100,"extension"),e._UZ(101,"app-tabs",null,13),e.qZA(),e.TgZ(103,"pre")(104,"code",14),e._uU(105,"\nimport { Module } from '@nestjs/common';\nimport { TerminusModule } from '@nestjs/terminus';\n\n@Module({\n  imports: [TerminusModule]\n})\nexport class HealthModule {}\n"),e.qZA()(),e.TgZ(106,"p"),e._uU(107,"Our healthcheck(s) can be executed using a "),e.TgZ(108,"a",15),e._uU(109,"controller"),e.qZA(),e._uU(110,", which can be easily set up using the "),e.TgZ(111,"a",11),e._uU(112,"Nest CLI"),e.qZA(),e._uU(113,"."),e.qZA(),e.TgZ(114,"pre")(115,"code",7),e._uU(116,"\n$ nest g controller health\n"),e.qZA()(),e.TgZ(117,"blockquote",10)(118,"strong"),e._uU(119,"Info"),e.qZA(),e._uU(120," It is highly recommended to enable shutdown hooks in your application. Terminus integration makes use of this lifecycle event if enabled. Read more about shutdown hooks "),e.TgZ(121,"a",16),e._uU(122,"here"),e.qZA(),e._uU(123,".\n"),e.qZA(),e.TgZ(124,"h4",17)(125,"span"),e._uU(126,"HTTP Healthcheck"),e.qZA()(),e.TgZ(127,"p"),e._uU(128,"Once we have installed "),e.TgZ(129,"code"),e._uU(130,"@nestjs/terminus"),e.qZA(),e._uU(131,", imported our "),e.TgZ(132,"code"),e._uU(133,"TerminusModule"),e.qZA(),e._uU(134," and created a new controller, we are ready to create a health check."),e.qZA(),e.TgZ(135,"p"),e._uU(136,"The "),e.TgZ(137,"code"),e._uU(138,"HTTPHealthIndicator"),e.qZA(),e._uU(139," requires the "),e.TgZ(140,"code"),e._uU(141,"@nestjs/axios"),e.qZA(),e._uU(142," package so make sure to have it installed:"),e.qZA(),e.TgZ(143,"pre")(144,"code",7),e._uU(145,"\n$ npm i --save @nestjs/axios axios\n"),e.qZA()(),e.TgZ(146,"p"),e._uU(147,"Now we can setup our "),e.TgZ(148,"code"),e._uU(149,"HealthController"),e.qZA(),e._uU(150,":"),e.qZA(),e.TgZ(151,"span",12),e._uU(152),e.ALo(153,"extension"),e._UZ(154,"app-tabs",null,18),e.qZA(),e.TgZ(156,"pre")(157,"code",14),e._uU(158,"\nimport { Controller, Get } from '@nestjs/common';\nimport { HealthCheckService, HttpHealthIndicator, HealthCheck } from '@nestjs/terminus';\n\n@Controller('health')\nexport class HealthController {\n  constructor(\n    private health: HealthCheckService,\n    private http: HttpHealthIndicator,\n  ) {}\n\n  @Get()\n  @HealthCheck()\n  check() {\n    return this.health.check([\n      () => this.http.pingCheck('nestjs-docs', 'https://docs.nestjs.com'),\n    ]);\n  }\n}\n"),e.qZA()(),e.TgZ(159,"pre")(160,"code",14),e._uU(161,"\nimport { Controller, Get } from '@nestjs/common';\nimport { HealthCheckService, HttpHealthIndicator, HealthCheck } from '@nestjs/terminus';\n\n@Controller('health')\n@Dependencies(HealthCheckService, HttpHealthIndicator)\nexport class HealthController {\n  constructor(\n    private health,\n    private http,\n  ) { }\n\n  @Get()\n  @HealthCheck()\n  healthCheck() {\n    return this.health.check([\n      () => this.http.pingCheck('nestjs-docs', 'https://docs.nestjs.com'),\n    ])\n  }\n}\n"),e.qZA()(),e.TgZ(162,"span",12),e._uU(163),e.ALo(164,"extension"),e._UZ(165,"app-tabs",null,19),e.qZA(),e.TgZ(167,"pre")(168,"code",14),e._uU(169,"\nimport { Module } from '@nestjs/common';\nimport { TerminusModule } from '@nestjs/terminus';\nimport { HttpModule } from '@nestjs/axios';\nimport { HealthController } from './health.controller';\n\n@Module({\n  imports: [TerminusModule, HttpModule],\n  controllers: [HealthController],\n})\nexport class HealthModule {}\n"),e.qZA()(),e.TgZ(170,"pre")(171,"code",14),e._uU(172,"\nimport { Module } from '@nestjs/common';\nimport { TerminusModule } from '@nestjs/terminus';\nimport { HttpModule } from '@nestjs/axios';\nimport { HealthController } from './health.controller';\n\n@Module({\n  imports: [TerminusModule, HttpModule],\n  controllers: [HealthController],\n})\nexport class HealthModule {}\n"),e.qZA()(),e.TgZ(173,"p"),e._uU(174,"Our health check will now send a "),e.TgZ(175,"em"),e._uU(176,"GET"),e.qZA(),e._uU(177,"-request to the "),e.TgZ(178,"code"),e._uU(179,"https://docs.nestjs.com"),e.qZA(),e._uU(180," address. If\nwe get a healthy response from that address, our route at "),e.TgZ(181,"code"),e._uU(182,"http://localhost:3000/health"),e.qZA(),e._uU(183," will return\nthe following object with a 200 status code."),e.qZA(),e.TgZ(184,"pre")(185,"code",20),e._uU(186,'\n{\n  "status": "ok",\n  "info": {\n    "nestjs-docs": {\n      "status": "up"\n    }\n  },\n  "error": {},\n  "details": {\n    "nestjs-docs": {\n      "status": "up"\n    }\n  }\n}\n'),e.qZA()(),e.TgZ(187,"p"),e._uU(188,"The interface of this response object can be accessed from the "),e.TgZ(189,"code"),e._uU(190,"@nestjs/terminus"),e.qZA(),e._uU(191," package with the "),e.TgZ(192,"code"),e._uU(193,"HealthCheckResult"),e.qZA(),e._uU(194," interface."),e.qZA(),e.TgZ(195,"table"),e._UZ(196,"thead"),e.TgZ(197,"tbody")(198,"tr")(199,"td")(200,"code"),e._uU(201,"status"),e.qZA()(),e.TgZ(202,"td"),e._uU(203,"If any health indicator failed the status will be "),e.TgZ(204,"code"),e._uU(205,"'error'"),e.qZA(),e._uU(206,". If the NestJS app is shutting down but still accepting HTTP requests, the health check will have the "),e.TgZ(207,"code"),e._uU(208,"'shutting_down'"),e.qZA(),e._uU(209," status."),e.qZA(),e.TgZ(210,"td")(211,"code"),e._uU(212,"'error' | 'ok' | 'shutting_down'"),e.qZA()()(),e.TgZ(213,"tr")(214,"td")(215,"code"),e._uU(216,"info"),e.qZA()(),e.TgZ(217,"td"),e._uU(218,"Object containing information of each health indicator which is of status "),e.TgZ(219,"code"),e._uU(220,"'up'"),e.qZA(),e._uU(221,', or in other words "healthy".'),e.qZA(),e.TgZ(222,"td")(223,"code"),e._uU(224,"object"),e.qZA()()(),e.TgZ(225,"tr")(226,"td")(227,"code"),e._uU(228,"error"),e.qZA()(),e.TgZ(229,"td"),e._uU(230,"Object containing information of each health indicator which is of status "),e.TgZ(231,"code"),e._uU(232,"'down'"),e.qZA(),e._uU(233,', or in other words "unhealthy".'),e.qZA(),e.TgZ(234,"td")(235,"code"),e._uU(236,"object"),e.qZA()()(),e.TgZ(237,"tr")(238,"td")(239,"code"),e._uU(240,"details"),e.qZA()(),e.TgZ(241,"td"),e._uU(242,"Object containing all information of each health indicator"),e.qZA(),e.TgZ(243,"td")(244,"code"),e._uU(245,"object"),e.qZA()()()()(),e.TgZ(246,"h5",21),e._uU(247,"Check for specific HTTP response codes"),e.qZA(),e.TgZ(248,"p"),e._uU(249,"In certain cases, you might want to check for specific criteria and validate the response. As an example, let's assume\n"),e.TgZ(250,"code"),e._uU(251,"https://my-external-service.com"),e.qZA(),e._uU(252," returns a response code "),e.TgZ(253,"code"),e._uU(254,"204"),e.qZA(),e._uU(255,". With "),e.TgZ(256,"code"),e._uU(257,"HttpHealthIndicator.responseCheck"),e.qZA(),e._uU(258," you can\ncheck for that response code specifically and determine all other codes as unhealthy."),e.qZA(),e.TgZ(259,"p"),e._uU(260,"In case any other response code other than "),e.TgZ(261,"code"),e._uU(262,"204"),e.qZA(),e._uU(263," gets returned, the following example would be unhealthy. The third parameter\nrequires you to provide a function (sync or async) which returns a boolean whether the response is considered\nhealthy ("),e.TgZ(264,"code"),e._uU(265,"true"),e.qZA(),e._uU(266,") or unhealthy ("),e.TgZ(267,"code"),e._uU(268,"false"),e.qZA(),e._uU(269,")."),e.qZA(),e.TgZ(270,"span",12),e._uU(271),e.ALo(272,"extension"),e._UZ(273,"app-tabs",null,22),e.qZA(),e.TgZ(275,"pre")(276,"code",14),e._uU(277,"\n// Within the `HealthController`-class\n\n@Get()\n@HealthCheck()\ncheck() {\n  return this.health.check([\n    () =>\n      this.http.responseCheck(\n        'my-external-service',\n        'https://my-external-service.com',\n        (res) => res.status === 204,\n      ),\n  ]);\n}\n"),e.qZA()(),e.TgZ(278,"h4",23)(279,"span"),e._uU(280,"TypeOrm health indicator"),e.qZA()(),e.TgZ(281,"p"),e._uU(282,"Terminus offers the capability to add database checks to your health check. In order to get started with this health indicator, you\nshould check out the "),e.TgZ(283,"a",24),e._uU(284,"Database chapter"),e.qZA(),e._uU(285," and make sure your database connection within your application is established."),e.qZA(),e.TgZ(286,"blockquote",10)(287,"strong"),e._uU(288,"Hint"),e.qZA(),e._uU(289," Behind the scenes the "),e.TgZ(290,"code"),e._uU(291,"TypeOrmHealthIndicator"),e.qZA(),e._uU(292," simply executes a "),e.TgZ(293,"code"),e._uU(294,"SELECT 1"),e.qZA(),e._uU(295,"-SQL command which is often used to verify whether the database still alive. In case you are using an Oracle database it uses "),e.TgZ(296,"code"),e._uU(297,"SELECT 1 FROM DUAL"),e.qZA(),e._uU(298,".\n"),e.qZA(),e.TgZ(299,"span",12),e._uU(300),e.ALo(301,"extension"),e._UZ(302,"app-tabs",null,25),e.qZA(),e.TgZ(304,"pre")(305,"code",14),e._uU(306,"\n@Controller('health')\nexport class HealthController {\n  constructor(\n    private health: HealthCheckService,\n    private db: TypeOrmHealthIndicator,\n  ) {}\n\n  @Get()\n  @HealthCheck()\n  check() {\n    return this.health.check([\n      () => this.db.pingCheck('database'),\n    ]);\n  }\n}\n"),e.qZA()(),e.TgZ(307,"pre")(308,"code",14),e._uU(309,"\n@Controller('health')\n@Dependencies(HealthCheckService, TypeOrmHealthIndicator)\nexport class HealthController {\n  constructor(\n    private health,\n    private db,\n  ) { }\n\n  @Get()\n  @HealthCheck()\n  healthCheck() {\n    return this.health.check([\n      () => this.db.pingCheck('database'),\n    ])\n  }\n}\n"),e.qZA()(),e.TgZ(310,"p"),e._uU(311,"If your database is reachable, you should now see the following JSON-result when requesting "),e.TgZ(312,"code"),e._uU(313,"http://localhost:3000"),e.qZA(),e._uU(314," with a "),e.TgZ(315,"code"),e._uU(316,"GET"),e.qZA(),e._uU(317," request:"),e.qZA(),e.TgZ(318,"pre")(319,"code",20),e._uU(320,'\n{\n  "status": "ok",\n  "info": {\n    "database": {\n      "status": "up"\n    }\n  },\n  "error": {},\n  "details": {\n    "database": {\n      "status": "up"\n    }\n  }\n}\n'),e.qZA()(),e.TgZ(321,"p"),e._uU(322,"In case your app uses "),e.TgZ(323,"a",26),e._uU(324,"multiple databases"),e.qZA(),e._uU(325,", you need to inject each\nconnection into your "),e.TgZ(326,"code"),e._uU(327,"HealthController"),e.qZA(),e._uU(328,". Then, you can simply pass the connection reference to the "),e.TgZ(329,"code"),e._uU(330,"TypeOrmHealthIndicator"),e.qZA(),e._uU(331,"."),e.qZA(),e.TgZ(332,"span",12),e._uU(333),e.ALo(334,"extension"),e._UZ(335,"app-tabs",null,27),e.qZA(),e.TgZ(337,"pre")(338,"code",14),e._uU(339,"\n@Controller('health')\nexport class HealthController {\n  constructor(\n    private health: HealthCheckService,\n    private db: TypeOrmHealthIndicator,\n    @InjectConnection('albumsConnection')\n    private albumsConnection: Connection,\n    @InjectConnection()\n    private defaultConnection: Connection,\n  ) {}\n\n  @Get()\n  @HealthCheck()\n  check() {\n    return this.health.check([\n      () => this.db.pingCheck('albums-database', { connection: this.albumsConnection }),\n      () => this.db.pingCheck('database', { connection: this.defaultConnection }),\n    ]);\n  }\n}\n"),e.qZA()(),e.TgZ(340,"h4",28)(341,"span"),e._uU(342,"Disk health indicator"),e.qZA()(),e.TgZ(343,"p"),e._uU(344,"With the "),e.TgZ(345,"code"),e._uU(346,"DiskHealthIndicator"),e.qZA(),e._uU(347," we can check how much storage is in use. To get started, make sure to inject the "),e.TgZ(348,"code"),e._uU(349,"DiskHealthIndicator"),e.qZA(),e._uU(350,"\ninto your "),e.TgZ(351,"code"),e._uU(352,"HealthController"),e.qZA(),e._uU(353,". The following example checks the storage used of the path "),e.TgZ(354,"code"),e._uU(355,"/"),e.qZA(),e._uU(356," (or on Windows you can use "),e.TgZ(357,"code"),e._uU(358,"C:\\\\"),e.qZA(),e._uU(359,").\nIf that exceeds more than 50% of the total storage space it would response with an unhealthy Health Check."),e.qZA(),e.TgZ(360,"span",12),e._uU(361),e.ALo(362,"extension"),e._UZ(363,"app-tabs",null,29),e.qZA(),e.TgZ(365,"pre")(366,"code",14),e._uU(367,"\n@Controller('health')\nexport class HealthController {\n  constructor(\n    private readonly health: HealthCheckService,\n    private readonly disk: DiskHealthIndicator,\n  ) {}\n\n  @Get()\n  @HealthCheck()\n  check() {\n    return this.health.check([\n      () => this.disk.checkStorage('storage', { path: '/', thresholdPercent: 0.5 }),\n    ]);\n  }\n}\n"),e.qZA()(),e.TgZ(368,"pre")(369,"code",14),e._uU(370,"\n@Controller('health')\n@Dependencies(HealthCheckService, DiskHealthIndicator)\nexport class HealthController {\n  constructor(health, disk) {}\n\n  @Get()\n  @HealthCheck()\n  healthCheck() {\n    return this.health.check([\n      () => this.disk.checkStorage('storage', { path: '/', thresholdPercent: 0.5 }),\n    ])\n  }\n}\n"),e.qZA()(),e.TgZ(371,"p"),e._uU(372,"With the "),e.TgZ(373,"code"),e._uU(374,"DiskHealthIndicator.checkStorage"),e.qZA(),e._uU(375," function you also have the possibility to check for a fixed amount of space.\nThe following example would be unhealthy in case the path "),e.TgZ(376,"code"),e._uU(377,"/my-app/"),e.qZA(),e._uU(378," would exceed 250GB."),e.qZA(),e.TgZ(379,"span",12),e._uU(380),e.ALo(381,"extension"),e._UZ(382,"app-tabs",null,30),e.qZA(),e.TgZ(384,"pre")(385,"code",14),e._uU(386,"\n// Within the `HealthController`-class\n\n@Get()\n@HealthCheck()\ncheck() {\n  return this.health.check([\n    () => this.disk.checkStorage('storage', {  path: '/', threshold: 250 * 1024 * 1024 * 1024, })\n  ]);\n}\n"),e.qZA()(),e.TgZ(387,"h4",31)(388,"span"),e._uU(389,"Memory health indicator"),e.qZA()(),e.TgZ(390,"p"),e._uU(391,"To make sure your process does not exceed a certain memory limit the "),e.TgZ(392,"code"),e._uU(393,"MemoryHealthIndicator"),e.qZA(),e._uU(394," can be used. The following example can be used to check the heap of your process."),e.qZA(),e.TgZ(395,"blockquote",10)(396,"strong"),e._uU(397,"Hint"),e.qZA(),e._uU(398," Heap is the portion of memory where dynamically allocated memory resides (i.e. memory allocated via malloc). Memory allocated from the heap will remain allocated until one of the following occurs:\n"),e.TgZ(399,"ul")(400,"li"),e._uU(401,"The memory is "),e.TgZ(402,"em"),e._uU(403,"free"),e.qZA(),e._uU(404,"'d"),e.qZA(),e.TgZ(405,"li"),e._uU(406,"The program terminates"),e.qZA()()(),e.TgZ(407,"span",12),e._uU(408),e.ALo(409,"extension"),e._UZ(410,"app-tabs",null,32),e.qZA(),e.TgZ(412,"pre")(413,"code",14),e._uU(414,"\n@Controller('health')\nexport class HealthController {\n  constructor(\n    private health: HealthCheckService,\n    private memory: MemoryHealthIndicator,\n  ) {}\n\n  @Get()\n  @HealthCheck()\n  check() {\n    return this.health.check([\n      () => this.memory.checkHeap('memory_heap', 150 * 1024 * 1024),\n    ]);\n  }\n}\n"),e.qZA()(),e.TgZ(415,"pre")(416,"code",14),e._uU(417,"\n@Controller('health')\n@Dependencies(HealthCheckService, MemoryHealthIndicator)\nexport class HealthController {\n  constructor(health, memory) {}\n\n  @Get()\n  @HealthCheck()\n  healthCheck() {\n    return this.health.check([\n      () => this.memory.checkHeap('memory_heap', 150 * 1024 * 1024),\n    ])\n  }\n}\n"),e.qZA()(),e.TgZ(418,"p"),e._uU(419,"It is also possible to verify the memory RSS of your process with "),e.TgZ(420,"code"),e._uU(421,"MemoryHealthIndicator.checkRSS"),e.qZA(),e._uU(422,". This example\nwould return an unhealthy response code in case your process does have more than 150MB allocated."),e.qZA(),e.TgZ(423,"blockquote",10)(424,"strong"),e._uU(425,"Hint"),e.qZA(),e._uU(426," RSS is the Resident Set Size and is used to show how much memory is allocated to that process and is in RAM.\nIt does not include memory that is swapped out. It does include memory from shared libraries as long as the pages from\nthose libraries are actually in memory. It does include all stack and heap memory.\n"),e.qZA(),e.TgZ(427,"span",12),e._uU(428),e.ALo(429,"extension"),e._UZ(430,"app-tabs",null,33),e.qZA(),e.TgZ(432,"pre")(433,"code",14),e._uU(434,"\n// Within the `HealthController`-class\n\n@Get()\n@HealthCheck()\ncheck() {\n  return this.health.check([\n    () => this.memory.checkRSS('memory_rss', 150 * 1024 * 1024),\n  ]);\n}\n"),e.qZA()(),e.TgZ(435,"h4",34)(436,"span"),e._uU(437,"Custom health indicator"),e.qZA()(),e.TgZ(438,"p"),e._uU(439,"In some cases, the predefined health indicators provided by "),e.TgZ(440,"code"),e._uU(441,"@nestjs/terminus"),e.qZA(),e._uU(442," do not cover all of your health check requirements. In that case, you can set up a custom health indicator according to your needs."),e.qZA(),e.TgZ(443,"p"),e._uU(444,"Let's get started by creating a service that will represent our custom indicator. To get a basic understanding of how an indicator is structured, we will create an example "),e.TgZ(445,"code"),e._uU(446,"DogHealthIndicator"),e.qZA(),e._uU(447,". This service should have the state "),e.TgZ(448,"code"),e._uU(449,"'up'"),e.qZA(),e._uU(450," if every "),e.TgZ(451,"code"),e._uU(452,"Dog"),e.qZA(),e._uU(453," object has the type "),e.TgZ(454,"code"),e._uU(455,"'goodboy'"),e.qZA(),e._uU(456,". If that condition is not satisfied then it should throw an error."),e.qZA(),e.TgZ(457,"span",12),e._uU(458),e.ALo(459,"extension"),e._UZ(460,"app-tabs",null,35),e.qZA(),e.TgZ(462,"pre")(463,"code",14),e._uU(464,"\nimport { Injectable } from '@nestjs/common';\nimport { HealthIndicator, HealthIndicatorResult, HealthCheckError } from '@nestjs/terminus';\n\nexport interface Dog {\n  name: string;\n  type: string;\n}\n\n@Injectable()\nexport class DogHealthIndicator extends HealthIndicator {\n  private dogs: Dog[] = [\n    { name: 'Fido', type: 'goodboy' },\n    { name: 'Rex', type: 'badboy' },\n  ];\n\n  async isHealthy(key: string): Promise<HealthIndicatorResult> {\n    const badboys = this.dogs.filter(dog => dog.type === 'badboy');\n    const isHealthy = badboys.length === 0;\n    const result = this.getStatus(key, isHealthy, { badboys: badboys.length });\n\n    if (isHealthy) {\n      return result;\n    }\n    throw new HealthCheckError('Dogcheck failed', result);\n  }\n}\n"),e.qZA()(),e.TgZ(465,"pre")(466,"code",14),e._uU(467,"\nimport { Injectable } from '@nestjs/common';\nimport { HealthCheckError } from '@godaddy/terminus';\n\n@Injectable()\nexport class DogHealthIndicator extends HealthIndicator {\n  dogs = [\n    { name: 'Fido', type: 'goodboy' },\n    { name: 'Rex', type: 'badboy' },\n  ];\n\n  async isHealthy(key) {\n    const badboys = this.dogs.filter(dog => dog.type === 'badboy');\n    const isHealthy = badboys.length === 0;\n    const result = this.getStatus(key, isHealthy, { badboys: badboys.length });\n\n    if (isHealthy) {\n      return result;\n    }\n    throw new HealthCheckError('Dogcheck failed', result);\n  }\n}\n"),e.qZA()(),e.TgZ(468,"p"),e._uU(469,"The next thing we need to do is register the health indicator as a provider."),e.qZA(),e.TgZ(470,"span",12),e._uU(471),e.ALo(472,"extension"),e._UZ(473,"app-tabs",null,36),e.qZA(),e.TgZ(475,"pre")(476,"code",14),e._uU(477,"\nimport { Module } from '@nestjs/common';\nimport { TerminusModule } from '@nestjs/terminus';\nimport { DogHealthIndicator } from './dog.health';\n\n@Module({\n  controllers: [HealthController],\n  imports: [TerminusModule],\n  providers: [DogHealthIndicator]\n})\nexport class HealthModule { }\n"),e.qZA()(),e.TgZ(478,"blockquote",10)(479,"strong"),e._uU(480,"Hint"),e.qZA(),e._uU(481," In a real-world application the "),e.TgZ(482,"code"),e._uU(483,"DogHealthIndicator"),e.qZA(),e._uU(484," should be provided in a separate module, for example, "),e.TgZ(485,"code"),e._uU(486,"DogModule"),e.qZA(),e._uU(487,", which then will be imported by the "),e.TgZ(488,"code"),e._uU(489,"HealthModule"),e.qZA(),e._uU(490,".\n"),e.qZA(),e.TgZ(491,"p"),e._uU(492,"The last required step is to add the now available health indicator in the required health check endpoint. For that, we go back to our "),e.TgZ(493,"code"),e._uU(494,"HealthController"),e.qZA(),e._uU(495," and add it to our "),e.TgZ(496,"code"),e._uU(497,"check"),e.qZA(),e._uU(498," function."),e.qZA(),e.TgZ(499,"span",12),e._uU(500),e.ALo(501,"extension"),e._UZ(502,"app-tabs",null,37),e.qZA(),e.TgZ(504,"pre")(505,"code",14),e._uU(506,"\nimport { HealthCheckService, HealthCheck } from '@nestjs/terminus';\nimport { Injectable, Get } from '@nestjs/common';\nimport { DogHealthIndicator } from './dog.health';\n\n@Injectable()\nexport class HealthController {\n  constructor(\n    private health: HealthCheckService,\n    private dogHealthIndicator: DogHealthIndicator\n  ) {}\n\n  @Get()\n  @HealthCheck()\n  healthCheck() {\n    return this.health.check([\n      () => this.dogHealthIndicator.isHealthy('dog'),\n    ])\n  }\n}\n"),e.qZA()(),e.TgZ(507,"pre")(508,"code",14),e._uU(509,"\nimport { HealthCheckService, HealthCheck } from '@nestjs/terminus';\nimport { Injectable, Get } from '@nestjs/common';\nimport { DogHealthIndicator } from './dog.health';\n\n@Injectable()\n@Dependencies(HealthCheckService, DogHealthIndicator)\nexport class HealthController {\n  constructor(\n    private health,\n    private dogHealthIndicator\n  ) {}\n\n  @Get()\n  @HealthCheck()\n  healthCheck() {\n    return this.health.check([\n      () => this.dogHealthIndicator.isHealthy('dog'),\n    ])\n  }\n}\n"),e.qZA()(),e.TgZ(510,"h4",38)(511,"span"),e._uU(512,"Logging"),e.qZA()(),e.TgZ(513,"p"),e._uU(514,"Terminus only logs error messages, for instance when a Healthcheck has failed. With the "),e.TgZ(515,"code"),e._uU(516,"TerminusModule.forRoot()"),e.qZA(),e._uU(517," method you have more control over how errors are being logged\nas well as completely take over the logging itself."),e.qZA(),e.TgZ(518,"p"),e._uU(519,"In this section, we are going to walk you through how you create a custom logger "),e.TgZ(520,"code"),e._uU(521,"TerminusLogger"),e.qZA(),e._uU(522,". This logger extends the built-in logger.\nTherefore you can pick and choose which part of the logger you would like to overwrite"),e.qZA(),e.TgZ(523,"blockquote",10)(524,"strong"),e._uU(525,"Info"),e.qZA(),e._uU(526," If you want to learn more about custom loggers in NestJS, "),e.TgZ(527,"a",39),e._uU(528,"read more here"),e.qZA(),e._uU(529,".\n"),e.qZA(),e.TgZ(530,"span",12),e._uU(531),e.ALo(532,"extension"),e._UZ(533,"app-tabs",null,40),e.qZA(),e.TgZ(535,"pre")(536,"code",14),e._uU(537,"\nimport { Injectable, Scope, ConsoleLogger } from '@nestjs/common';\n\n@Injectable({ scope: Scope.TRANSIENT })\nexport class TerminusLogger extends ConsoleLogger {\n  error(message: any, stack?: string, context?: string): void;\n  error(message: any, ...optionalParams: any[]): void;\n  error(\n    message: unknown,\n    stack?: unknown,\n    context?: unknown,\n    ...rest: unknown[]\n  ): void {\n    // Overwrite here how error messages should be logged\n  }\n}\n"),e.qZA()(),e.TgZ(538,"p"),e._uU(539,"Once you have created your custom logger, all you need to do is simply pass it into the "),e.TgZ(540,"code"),e._uU(541,"TerminusModule.forRoot()"),e.qZA(),e._uU(542," as such."),e.qZA(),e.TgZ(543,"span",12),e._uU(544),e.ALo(545,"extension"),e._UZ(546,"app-tabs",null,41),e.qZA(),e.TgZ(548,"pre")(549,"code",14),e._uU(550,"\n@Module({\nimports: [\n  TerminusModule.forRoot({\n    logger: TerminusLogger,\n  }),\n],\n})\nexport class HealthModule {}\n"),e.qZA()(),e.TgZ(551,"p"),e._uU(552,"To completely suppress any log messages coming from Terminus, including error messages, configure Terminus as such."),e.qZA(),e.TgZ(553,"span",12),e._uU(554),e.ALo(555,"extension"),e._UZ(556,"app-tabs",null,42),e.qZA(),e.TgZ(558,"pre")(559,"code",14),e._uU(560,"\n@Module({\nimports: [\n  TerminusModule.forRoot({\n    logger: false,\n  }),\n],\n})\nexport class HealthModule {}\n"),e.qZA()(),e.TgZ(561,"p"),e._uU(562,"Terminus allows you to configure how Healthcheck errors should be displayed in your logs."),e.qZA(),e.TgZ(563,"table")(564,"thead")(565,"tr")(566,"th",43),e._uU(567,"Error Log Style"),e.qZA(),e.TgZ(568,"th",43),e._uU(569,"Description"),e.qZA(),e.TgZ(570,"th",43),e._uU(571,"Example"),e.qZA()()(),e.TgZ(572,"tbody")(573,"tr")(574,"td",43)(575,"code"),e._uU(576,"json"),e.qZA(),e._uU(577," (default)"),e.qZA(),e.TgZ(578,"td",43),e._uU(579,"Prints a summary of the health check result in case of an error as JSON object"),e.qZA(),e.TgZ(580,"td",43)(581,"figure"),e._UZ(582,"img",44),e.qZA()()(),e.TgZ(583,"tr")(584,"td",43)(585,"code"),e._uU(586,"pretty"),e.qZA()(),e.TgZ(587,"td",43),e._uU(588,"Prints a summary of the health check result in case of an error within formatted boxes and highlights successful/erroneous results"),e.qZA(),e.TgZ(589,"td",43)(590,"figure"),e._UZ(591,"img",45),e.qZA()()()()(),e.TgZ(592,"p"),e._uU(593,"You can change the log style using the "),e.TgZ(594,"code"),e._uU(595,"errorLogStyle"),e.qZA(),e._uU(596," configuration option as in the following snippet."),e.qZA(),e.TgZ(597,"span",12),e._uU(598),e.ALo(599,"extension"),e._UZ(600,"app-tabs",null,46),e.qZA(),e.TgZ(602,"pre")(603,"code",14),e._uU(604,"\n@Module({\n  imports: [\n    TerminusModule.forRoot({\n      errorLogStyle: 'pretty',\n    }),\n  ]\n})\nexport class HealthModule {}\n"),e.qZA()(),e.TgZ(605,"h4",47)(606,"span"),e._uU(607,"More examples"),e.qZA()(),e.TgZ(608,"p"),e._uU(609,"More working examples are available "),e.TgZ(610,"a",48),e._uU(611,"here"),e.qZA(),e._uU(612,"."),e.qZA()()),2&n){const r=e.MAs(102),a=e.MAs(155),u=e.MAs(166),c=e.MAs(274),i=e.MAs(303),p=e.MAs(336),U=e.MAs(364),A=e.MAs(383),_=e.MAs(411),D=e.MAs(431),T=e.MAs(461),N=e.MAs(474),q=e.MAs(503),W=e.MAs(534),F=e.MAs(547),G=e.MAs(557),K=e.MAs(601);e.xp6(99),e.hij(" ",e.xi3(100,45,"health.module",r.isJsActive),"\n"),e.xp6(53),e.hij(" ",e.xi3(153,48,"health.controller",a.isJsActive),"\n"),e.xp6(4),e.ekj("hide",a.isJsActive),e.xp6(3),e.ekj("hide",!a.isJsActive),e.xp6(4),e.hij(" ",e.xi3(164,51,"health.module",u.isJsActive),"\n"),e.xp6(4),e.ekj("hide",u.isJsActive),e.xp6(3),e.ekj("hide",!u.isJsActive),e.xp6(101),e.hij(" ",e.xi3(272,54,"health.controller",c.isJsActive),"\n"),e.xp6(29),e.hij(" ",e.xi3(301,57,"health.controller",i.isJsActive),"\n"),e.xp6(4),e.ekj("hide",i.isJsActive),e.xp6(3),e.ekj("hide",!i.isJsActive),e.xp6(26),e.hij(" ",e.xi3(334,60,"health.controller",p.isJsActive),"\n"),e.xp6(28),e.hij(" ",e.xi3(362,63,"health.controller",U.isJsActive),"\n"),e.xp6(4),e.ekj("hide",U.isJsActive),e.xp6(3),e.ekj("hide",!U.isJsActive),e.xp6(12),e.hij(" ",e.xi3(381,66,"health.controller",A.isJsActive),"\n"),e.xp6(28),e.hij(" ",e.xi3(409,69,"health.controller",_.isJsActive),"\n"),e.xp6(4),e.ekj("hide",_.isJsActive),e.xp6(3),e.ekj("hide",!_.isJsActive),e.xp6(13),e.hij(" ",e.xi3(429,72,"health.controller",D.isJsActive),"\n"),e.xp6(30),e.hij(" ",e.xi3(459,75,"dog.health",T.isJsActive),"\n"),e.xp6(4),e.ekj("hide",T.isJsActive),e.xp6(3),e.ekj("hide",!T.isJsActive),e.xp6(6),e.hij(" ",e.xi3(472,78,"health.module",N.isJsActive),"\n"),e.xp6(29),e.hij(" ",e.xi3(501,81,"health.controller",q.isJsActive),"\n"),e.xp6(4),e.ekj("hide",q.isJsActive),e.xp6(3),e.ekj("hide",!q.isJsActive),e.xp6(24),e.hij(" ",e.xi3(532,84,"terminus-logger.service",W.isJsActive),"\n"),e.xp6(13),e.hij(" ",e.xi3(545,87,"health.module",F.isJsActive),"\n"),e.xp6(10),e.hij(" ",e.xi3(555,90,"health.module",G.isJsActive),"\n"),e.xp6(44),e.hij(" ",e.xi3(599,93,"health.module",K.isJsActive),"\n")}},dependencies:[Z.n,d.U,g.rH,m.F],encapsulation:2,changeDetection:0}));class P extends l.y{}(0,s.Z)(P,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(P)))(o||P)}}()),(0,s.Z)(P,"\u0275cmp",e.Xpm({type:P,selectors:[["app-router-module"]],features:[e.qOj],decls:84,vars:0,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/router-module.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","router-module"],[1,"info"],["href","/controllers#routing"],["routerLink","/faq/global-prefix"],["routerLink","/techniques/versioning"],[1,"language-typescript"]],template:function(n,o){1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"Router module"),e.qZA(),e.TgZ(7,"blockquote",6)(8,"strong"),e._uU(9,"Hint"),e.qZA(),e._uU(10," This chapter is only relevant to HTTP-based applications.\n"),e.qZA(),e.TgZ(11,"p"),e._uU(12,"In an HTTP application (for example, REST API), the route path for a handler is determined by concatenating the (optional) prefix declared for the controller (inside the "),e.TgZ(13,"code"),e._uU(14,"@Controller"),e.qZA(),e._uU(15," decorator),\nand any path specified in the method's decorator (e.g, "),e.TgZ(16,"code"),e._uU(17,"@Get('users')"),e.qZA(),e._uU(18,"). You can learn more about that in "),e.TgZ(19,"a",7),e._uU(20,"this section"),e.qZA(),e._uU(21,". Additionally,\nyou can define a "),e.TgZ(22,"a",8),e._uU(23,"global prefix"),e.qZA(),e._uU(24," for all routes registered in your application, or enable "),e.TgZ(25,"a",9),e._uU(26,"versioning"),e.qZA(),e._uU(27,"."),e.qZA(),e.TgZ(28,"p"),e._uU(29,'Also, there are edge-cases when defining a prefix at a module-level (and so for all controllers registered inside that module) may come in handy.\nFor example, imagine a REST application that exposes several different endpoints being used by a specific portion of your application called "Dashboard".\nIn such a case, instead of repeating the '),e.TgZ(30,"code"),e._uU(31,"/dashboard"),e.qZA(),e._uU(32," prefix within each controller, you could use a utility "),e.TgZ(33,"code"),e._uU(34,"RouterModule"),e.qZA(),e._uU(35," module, as follows:"),e.qZA(),e.TgZ(36,"pre")(37,"code",10),e._uU(38,"\n@Module({\n  imports: [\n    DashboardModule,\n    RouterModule.register([\n      {\n        path: 'dashboard',\n        module: DashboardModule,\n      },\n    ]),\n  ],\n})\nexport class AppModule {}\n"),e.qZA()(),e.TgZ(39,"blockquote",6)(40,"strong"),e._uU(41,"Hint"),e.qZA(),e._uU(42," The "),e.TgZ(43,"code"),e._uU(44,"RouterModule"),e.qZA(),e._uU(45," class is exported from the "),e.TgZ(46,"code"),e._uU(47,"@nestjs/core"),e.qZA(),e._uU(48," package.\n"),e.qZA(),e.TgZ(49,"p"),e._uU(50,"In addition, you can define hierarchical structures. This means each module can have "),e.TgZ(51,"code"),e._uU(52,"children"),e.qZA(),e._uU(53," modules.\nThe children modules will inherit their parent's prefix. In the following example, we'll register the "),e.TgZ(54,"code"),e._uU(55,"AdminModule"),e.qZA(),e._uU(56," as a parent module of "),e.TgZ(57,"code"),e._uU(58,"DashboardModule"),e.qZA(),e._uU(59," and "),e.TgZ(60,"code"),e._uU(61,"MetricsModule"),e.qZA(),e._uU(62,"."),e.qZA(),e.TgZ(63,"pre")(64,"code",10),e._uU(65,"\n@Module({\n  imports: [\n    AdminModule,\n    DashboardModule,\n    MetricsModule,\n    RouterModule.register([\n      {\n        path: 'admin',\n        module: AdminModule,\n        children: [\n          {\n            path: 'dashboard',\n            module: DashboardModule,\n          },\n          {\n            path: 'metrics',\n            module: MetricsModule,\n          },\n        ],\n      },\n    ])\n  ],\n});\n"),e.qZA()(),e.TgZ(66,"blockquote",6)(67,"strong"),e._uU(68,"Hint"),e.qZA(),e._uU(69," This feature should be used very carefully, as overusing it can make code difficult to maintain over time.\n"),e.qZA(),e.TgZ(70,"p"),e._uU(71,"In the example above, any controller registered inside the "),e.TgZ(72,"code"),e._uU(73,"DashboardModule"),e.qZA(),e._uU(74," will have an extra "),e.TgZ(75,"code"),e._uU(76,"/admin/dashboard"),e.qZA(),e._uU(77," prefix (as the module concatenates paths from top to bottom - recursively - parent to children).\nLikewise, each controller defined inside the "),e.TgZ(78,"code"),e._uU(79,"MetricsModule"),e.qZA(),e._uU(80," will have an additional module-level prefix "),e.TgZ(81,"code"),e._uU(82,"/admin/metrics"),e.qZA(),e._uU(83,"."),e.qZA()())},dependencies:[g.rH],encapsulation:2,changeDetection:0}));class R extends l.y{}(0,s.Z)(R,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(R)))(o||R)}}()),(0,s.Z)(R,"\u0275cmp",e.Xpm({type:R,selectors:[["app-nest-commander"]],features:[e.qOj],decls:217,vars:0,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/nest-commander.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","nest-commander"],["routerLink","/standalone-applications"],["rel","nofollow","target","_blank","href","https://jmcdo29.github.io/nest-commander"],[1,"info"],["rel","nofollow","target","_blank","href","https://github.com/jmcdo29/nest-commander/issues/new/choose"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","a-command-file"],["rel","nofollow","target","_blank","href","https://www.typescriptlang.org/docs/handbook/decorators.html"],["appAnchor","","id","running-the-command"],[1,"language-ts"],["appAnchor","","id","testing"],["appAnchor","","id","putting-it-all-together"],["appAnchor","","id","more-information"]],template:function(n,o){1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"Nest Commander"),e.qZA(),e.TgZ(7,"p"),e._uU(8,"Expanding on the "),e.TgZ(9,"a",6),e._uU(10,"standalone application"),e.qZA(),e._uU(11," docs there's also the "),e.TgZ(12,"a",7),e._uU(13,"nest-commander"),e.qZA(),e._uU(14," package for writing command line applications in a structure similar to your typical Nest application."),e.qZA(),e.TgZ(15,"blockquote",8)(16,"strong"),e._uU(17,"info"),e.qZA(),e.TgZ(18,"code"),e._uU(19,"nest-commander"),e.qZA(),e._uU(20," is a third party package and is not managed by the entirety of the NestJS core team. Please, report any issues found with the library in the "),e.TgZ(21,"a",9),e._uU(22,"appropriate repository"),e.qZA()(),e.TgZ(23,"h4",10)(24,"span"),e._uU(25,"Installation"),e.qZA()(),e.TgZ(26,"p"),e._uU(27,"Just like any other package, you've got to install it before you can use it."),e.qZA(),e.TgZ(28,"pre")(29,"code",11),e._uU(30,"\n$ npm i nest-commander\n"),e.qZA()(),e.TgZ(31,"h4",12)(32,"span"),e._uU(33,"A Command file"),e.qZA()(),e.TgZ(34,"p")(35,"code"),e._uU(36,"nest-commander"),e.qZA(),e._uU(37," makes it easy to write new command-line applications with "),e.TgZ(38,"a",13),e._uU(39,"decorators"),e.qZA(),e._uU(40," via the "),e.TgZ(41,"code"),e._uU(42,"@Command()"),e.qZA(),e._uU(43," decorator for classes and the "),e.TgZ(44,"code"),e._uU(45,"@Option()"),e.qZA(),e._uU(46," decorator for methods of that class. Every command file should implement the "),e.TgZ(47,"code"),e._uU(48,"CommandRunner"),e.qZA(),e._uU(49," abstract class and should be decorated with a "),e.TgZ(50,"code"),e._uU(51,"@Command()"),e.qZA(),e._uU(52," decorator."),e.qZA(),e.TgZ(53,"p"),e._uU(54,"Every command is seen as an "),e.TgZ(55,"code"),e._uU(56,"@Injectable()"),e.qZA(),e._uU(57," by Nest, so your normal Dependency Injection still works as you would expect it to. The only thing to take note of is the abstract class "),e.TgZ(58,"code"),e._uU(59,"CommandRunner"),e.qZA(),e._uU(60,", which should be implemented by each command. The "),e.TgZ(61,"code"),e._uU(62,"CommandRunner"),e.qZA(),e._uU(63," abstract class ensures that all commands have a "),e.TgZ(64,"code"),e._uU(65,"run"),e.qZA(),e._uU(66," method that returns a "),e.TgZ(67,"code"),e._uU(68,"Promise<void>"),e.qZA(),e._uU(69," and takes in the parameters "),e.TgZ(70,"code"),e._uU(71,"string[], Record<string, any>"),e.qZA(),e._uU(72,". The "),e.TgZ(73,"code"),e._uU(74,"run"),e.qZA(),e._uU(75," command is where you can kick all of your logic off from, it will take in whatever parameters did not match option flags and pass them in as an array, just in case you are really meaning to work with multiple parameters. As for the options, the "),e.TgZ(76,"code"),e._uU(77,"Record<string, any>"),e.qZA(),e._uU(78,", the names of these properties match the "),e.TgZ(79,"code"),e._uU(80,"name"),e.qZA(),e._uU(81," property given to the "),e.TgZ(82,"code"),e._uU(83,"@Option()"),e.qZA(),e._uU(84," decorators, while their value matches the return of the option handler. If you'd like better type safety, you are welcome to create an interface for your options as well."),e.qZA(),e.TgZ(85,"h4",14)(86,"span"),e._uU(87,"Running the Command"),e.qZA()(),e.TgZ(88,"p"),e._uU(89,"Similar to how in a NestJS application we can use the "),e.TgZ(90,"code"),e._uU(91,"NestFactory"),e.qZA(),e._uU(92," to create a server for us, and run it using "),e.TgZ(93,"code"),e._uU(94,"listen"),e.qZA(),e._uU(95,", the "),e.TgZ(96,"code"),e._uU(97,"nest-commander"),e.qZA(),e._uU(98," package exposes a simple to use API to run your server. Import the "),e.TgZ(99,"code"),e._uU(100,"CommandFactory"),e.qZA(),e._uU(101," and use the "),e.TgZ(102,"code"),e._uU(103,"static"),e.qZA(),e._uU(104," method "),e.TgZ(105,"code"),e._uU(106,"run"),e.qZA(),e._uU(107," and pass in the root module of your application. This would probably look like below"),e.qZA(),e.TgZ(108,"pre")(109,"code",15),e._uU(110,"\nimport { CommandFactory } from 'nest-commander';\nimport { AppModule } from './app.module';\n\nasync function bootstrap() {\n  await CommandFactory.run(AppModule);\n}\n\nbootstrap();\n"),e.qZA()(),e.TgZ(111,"p"),e._uU(112,"By default, Nest's logger is disabled when using the "),e.TgZ(113,"code"),e._uU(114,"CommandFactory"),e.qZA(),e._uU(115,". It's possible to provide it though, as the second argument to the "),e.TgZ(116,"code"),e._uU(117,"run"),e.qZA(),e._uU(118," function. You can either provide a custom NestJS logger, or an array of log levels you want to keep - it might be useful to at least provide "),e.TgZ(119,"code"),e._uU(120,"['error']"),e.qZA(),e._uU(121," here, if you only want to print out Nest's error logs."),e.qZA(),e.TgZ(122,"pre")(123,"code",15),e._uU(124,"\nimport { CommandFactory } from 'nest-commander';\nimport { AppModule } from './app.module';\nimport { LogService } './log.service';\n\nasync function bootstrap() {\n  await CommandFactory.run(AppModule, new LogService());\n\n  // or, if you only want to print Nest's warnings and errors\n  await CommandFactory.run(AppModule, ['warn', 'error']);\n}\n\nbootstrap();\n"),e.qZA()(),e.TgZ(125,"p"),e._uU(126,"And that's it. Under the hood, "),e.TgZ(127,"code"),e._uU(128,"CommandFactory"),e.qZA(),e._uU(129," will worry about calling "),e.TgZ(130,"code"),e._uU(131,"NestFactory"),e.qZA(),e._uU(132," for you and calling "),e.TgZ(133,"code"),e._uU(134,"app.close()"),e.qZA(),e._uU(135," when necessary, so you shouldn't need to worry about memory leaks there. If you need to add in some error handling, there's always "),e.TgZ(136,"code"),e._uU(137,"try/catch"),e.qZA(),e._uU(138," wrapping the "),e.TgZ(139,"code"),e._uU(140,"run"),e.qZA(),e._uU(141," command, or you can chain on some "),e.TgZ(142,"code"),e._uU(143,".catch()"),e.qZA(),e._uU(144," method to the "),e.TgZ(145,"code"),e._uU(146,"bootstrap()"),e.qZA(),e._uU(147," call."),e.qZA(),e.TgZ(148,"h4",16)(149,"span"),e._uU(150,"Testing"),e.qZA()(),e.TgZ(151,"p"),e._uU(152,"So what's the use of writing a super awesome command line script if you can't test it super easily, right? Fortunately, "),e.TgZ(153,"code"),e._uU(154,"nest-commander"),e.qZA(),e._uU(155," has some utilities you can make use of that fits in perfectly with the NestJS ecosystem, it'll feel right at home to any Nestlings out there. Instead of using the "),e.TgZ(156,"code"),e._uU(157,"CommandFactory"),e.qZA(),e._uU(158," for building the command in test mode, you can use "),e.TgZ(159,"code"),e._uU(160,"CommandTestFactory"),e.qZA(),e._uU(161," and pass in your metadata, very similarly to how "),e.TgZ(162,"code"),e._uU(163,"Test.createTestingModule"),e.qZA(),e._uU(164," from "),e.TgZ(165,"code"),e._uU(166,"@nestjs/testing"),e.qZA(),e._uU(167," works. In fact, it uses this package under the hood. You're also still able to chain on the "),e.TgZ(168,"code"),e._uU(169,"overrideProvider"),e.qZA(),e._uU(170," methods before calling "),e.TgZ(171,"code"),e._uU(172,"compile()"),e.qZA(),e._uU(173," so you can swap out DI pieces right in the test."),e.qZA(),e.TgZ(174,"h4",17)(175,"span"),e._uU(176,"Putting it all together"),e.qZA()(),e.TgZ(177,"p"),e._uU(178,"The following class would equate to having a CLI command that can take in the subcommand "),e.TgZ(179,"code"),e._uU(180,"basic"),e.qZA(),e._uU(181," or be called directly, with "),e.TgZ(182,"code"),e._uU(183,"-n"),e.qZA(),e._uU(184,", "),e.TgZ(185,"code"),e._uU(186,"-s"),e.qZA(),e._uU(187,", and "),e.TgZ(188,"code"),e._uU(189,"-b"),e.qZA(),e._uU(190," (along with their long flags) all being supported and with custom parsers for each option. The "),e.TgZ(191,"code"),e._uU(192,"--help"),e.qZA(),e._uU(193," flag is also supported, as is customary with commander."),e.qZA(),e.TgZ(194,"pre")(195,"code",15),e._uU(196,"\nimport { Command, CommandRunner, Option } from 'nest-commander';\nimport { LogService } from './log.service';\n\ninterface BasicCommandOptions {\n  string?: string;\n  boolean?: boolean;\n  number?: number;\n}\n\n@Command({ name: 'basic', description: 'A parameter parse' })\nexport class BasicCommand extends CommandRunner {\n  constructor(private readonly logService: LogService) {\n    super()\n  }\n\n  async run(\n    passedParam: string[],\n    options?: BasicCommandOptions,\n  ): Promise<void> {\n    if (options?.boolean !== undefined && options?.boolean !== null) {\n      this.runWithBoolean(passedParam, options.boolean);\n    } else if (options?.number) {\n      this.runWithNumber(passedParam, options.number);\n    } else if (options?.string) {\n      this.runWithString(passedParam, options.string);\n    } else {\n      this.runWithNone(passedParam);\n    }\n  }\n\n  @Option({\n    flags: '-n, --number [number]',\n    description: 'A basic number parser',\n  })\n  parseNumber(val: string): number {\n    return Number(val);\n  }\n\n  @Option({\n    flags: '-s, --string [string]',\n    description: 'A string return',\n  })\n  parseString(val: string): string {\n    return val;\n  }\n\n  @Option({\n    flags: '-b, --boolean [boolean]',\n    description: 'A boolean parser',\n  })\n  parseBoolean(val: string): boolean {\n    return JSON.parse(val);\n  }\n\n  runWithString(param: string[], option: string): void {\n    this.logService.log({ param, string: option });\n  }\n\n  runWithNumber(param: string[], option: number): void {\n    this.logService.log({ param, number: option });\n  }\n\n  runWithBoolean(param: string[], option: boolean): void {\n    this.logService.log({ param, boolean: option });\n  }\n\n  runWithNone(param: string[]): void {\n    this.logService.log({ param });\n  }\n}\n"),e.qZA()(),e.TgZ(197,"p"),e._uU(198,"Make sure the command class is added to a module"),e.qZA(),e.TgZ(199,"pre")(200,"code",15),e._uU(201,"\n@Module({\n  providers: [LogService, BasicCommand],\n})\nexport class AppModule {}\n"),e.qZA()(),e.TgZ(202,"p"),e._uU(203,"And now to be able to run the CLI in your main.ts you can do the following"),e.qZA(),e.TgZ(204,"pre")(205,"code",15),e._uU(206,"\nasync function bootstrap() {\n  await CommandFactory.run(AppModule);\n}\n\nbootstrap();\n"),e.qZA()(),e.TgZ(207,"p"),e._uU(208,"And just like that, you've got a command line application."),e.qZA(),e.TgZ(209,"h4",18)(210,"span"),e._uU(211,"More Information"),e.qZA()(),e.TgZ(212,"p"),e._uU(213,"Visit the "),e.TgZ(214,"a",7),e._uU(215,"nest-commander docs site"),e.qZA(),e._uU(216," for more information, examples, and API documentation."),e.qZA()())},dependencies:[d.U,g.rH],encapsulation:2,changeDetection:0}));class E extends l.y{}(0,s.Z)(E,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(E)))(o||E)}}()),(0,s.Z)(E,"\u0275cmp",e.Xpm({type:E,selectors:[["app-async-local-storage"]],features:[e.qOj],decls:267,vars:32,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/async-local-storage.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","async-local-storage"],["rel","nofollow","target","_blank","href","https://nodejs.org/api/async_context.html#async_context_class_asynclocalstorage"],["appAnchor","","id","custom-implementation"],[1,"info"],["href","recipes/async-local-storage#nestjs-cls"],[1,"filename"],["app0b478424a72365afbf1093d1763f19558fb3a148",""],[1,"language-ts"],["start","2"],["appd37b2871c2553848a5c4a4857285361def59b104",""],[1,"language-typescript"],["start","3"],["app49ad428b642d4fa821f3baba1417e88cf5cbe70c",""],["start","4"],[1,"warning"],["rel","nofollow","target","_blank","href","https://en.wikipedia.org/wiki/God_object"],["id","nestjs-cls"],["rel","nofollow","target","_blank","href","https://github.com/Papooch/nestjs-cls"],["rel","nofollow","target","_blank","href","https://www.npmjs.com/package/nestjs-cls#proxy-providers"],["rel","nofollow","target","_blank","href","https://github.com/Papooch/nestjs-cls/issues"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","usage"],["href","#custom-implementation"],["appeb33fd01f26e63dd7b3372120053ff219102b229",""],["app310f17c91ad44b25bc26814a2ad75e3cfaf16207",""],["appAnchor","","id","testing"],["appAnchor","","id","more-information"]],template:function(n,o){if(1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"Async Local Storage"),e.qZA(),e.TgZ(7,"p")(8,"code"),e._uU(9,"AsyncLocalStorage"),e.qZA(),e._uU(10," is a "),e.TgZ(11,"a",6),e._uU(12,"Node.js API"),e.qZA(),e._uU(13," (based on the "),e.TgZ(14,"code"),e._uU(15,"async_hooks"),e.qZA(),e._uU(16," API) that provides an alternative way of propagating local state through the application without the need to explicitly pass it as a function parameter. It is similar to a thread-local storage in other languages."),e.qZA(),e.TgZ(17,"p"),e._uU(18,"The main idea of Async Local Storage is that we can "),e.TgZ(19,"em"),e._uU(20,"wrap"),e.qZA(),e._uU(21," some function call with the "),e.TgZ(22,"code"),e._uU(23,"AsyncLocalStorage#run"),e.qZA(),e._uU(24," call. All code that is invoked within the wrapped call gets access to the same "),e.TgZ(25,"code"),e._uU(26,"store"),e.qZA(),e._uU(27,", which will be unique to each call chain."),e.qZA(),e.TgZ(28,"p"),e._uU(29,"In the context of NestJS, that means if we can find a place within the request's lifecycle where we can wrap the rest of the request's code, we will be able to access and modify state visible only to that request, which may serve as an alternative to REQUEST-scoped providers and some of their limitations."),e.qZA(),e.TgZ(30,"p"),e._uU(31,"Alternatively, we can use ALS to propagate context for only a part of the system (for example the "),e.TgZ(32,"em"),e._uU(33,"transaction"),e.qZA(),e._uU(34," object) without passing it around explicitly across services, which can increase isolation and encapsulation."),e.qZA(),e.TgZ(35,"h4",7)(36,"span"),e._uU(37,"Custom implementation"),e.qZA()(),e.TgZ(38,"p"),e._uU(39,"NestJS itself does not provide any built-in abstraction for "),e.TgZ(40,"code"),e._uU(41,"AsyncLocalStorage"),e.qZA(),e._uU(42,", so let's walk through how we could implement it ourselves for the simplest HTTP case to get a better understanding of the whole concept:"),e.qZA(),e.TgZ(43,"blockquote",8)(44,"strong"),e._uU(45,"info"),e.qZA(),e._uU(46," For a ready-made "),e.TgZ(47,"a",9),e._uU(48,"dedicated package"),e.qZA(),e._uU(49,", continue reading below.\n"),e.qZA(),e.TgZ(50,"ol")(51,"li"),e._uU(52,"First, create a new instance of the "),e.TgZ(53,"code"),e._uU(54,"AsyncLocalStorage"),e.qZA(),e._uU(55," in some shared source file. Since we're using NestJS, let's also turn it into a module with a custom provider."),e.qZA()(),e.TgZ(56,"span",10),e._uU(57),e.ALo(58,"extension"),e._UZ(59,"app-tabs",null,11),e.qZA(),e.TgZ(61,"pre")(62,"code",12),e._uU(63,"\n@Module({\n  providers: [\n    {\n      provide: AsyncLocalStorage,\n      useValue: new AsyncLocalStorage(),\n    },\n  ],\n  exports: [AsyncLocalStorage],\n})\nexport class AlsModule {}\n"),e.qZA()(),e.TgZ(64,"blockquote",8)(65,"strong"),e._uU(66,"Hint"),e.qZA(),e.TgZ(67,"code"),e._uU(68,"AsyncLocalStorage"),e.qZA(),e._uU(69," is imported from "),e.TgZ(70,"code"),e._uU(71,"async_hooks"),e.qZA(),e._uU(72,".\n"),e.qZA(),e.TgZ(73,"ol",13)(74,"li"),e._uU(75,"We're only concerned with HTTP, so let's use a middleware to wrap the "),e.TgZ(76,"code"),e._uU(77,"next"),e.qZA(),e._uU(78," function with "),e.TgZ(79,"code"),e._uU(80,"AsyncLocalStorage#run"),e.qZA(),e._uU(81,". Since a middleware is the first thing that the request hits, this will make the "),e.TgZ(82,"code"),e._uU(83,"store"),e.qZA(),e._uU(84," available in all enhancers and the rest of the system."),e.qZA()(),e.TgZ(85,"span",10),e._uU(86),e.ALo(87,"extension"),e._UZ(88,"app-tabs",null,14),e.qZA(),e.TgZ(90,"pre")(91,"code",15),e._uU(92,"\n@Module({\n  imports: [AlsModule]\n  providers: [CatService],\n  controllers: [CatController],\n})\nexport class AppModule implements NestModule {\n  constructor(\n    // inject the AsyncLocalStorage in the module constructor,\n    private readonly als: AsyncLocalStorage\n  ) {}\n\n  configure(consumer: MiddlewareConsumer) {\n    // bind the middleware,\n    consumer\n      .apply((req, res, next) => {\n        // populate the store with some default values\n        // based on the request,\n        const store = {\n          userId: req.headers['x-user-id'],\n        };\n        // and pass the \"next\" function as callback\n        // to the \"als.run\" method together with the store.\n        als.run(store, () => next());\n      })\n      // and register it for all routes (in case of Fastify use '(.*)')\n      .forRoutes('*');\n  }\n}\n"),e.qZA()(),e.TgZ(93,"pre")(94,"code",15),e._uU(95,"\n@Module({\n  imports: [AlsModule]\n  providers: [CatService],\n  controllers: [CatController],\n})\n@Dependencies(AsyncLocalStorage)\nexport class AppModule {\n  constructor(als) {\n    // inject the AsyncLocalStorage in the module constructor,\n    this.als = als\n  }\n\n  configure(consumer) {\n    // bind the middleware,\n    consumer\n      .apply((req, res, next) => {\n        // populate the store with some default values\n        // based on the request,\n        const store = {\n          userId: req.headers['x-user-id'],\n        };\n        // and pass the \"next\" function as callback\n        // to the \"als.run\" method together with the store.\n        als.run(store, () => next());\n      })\n      // and register it for all routes (in case of Fastify use '(.*)')\n      .forRoutes('*');\n  }\n}\n"),e.qZA()(),e.TgZ(96,"ol",16)(97,"li"),e._uU(98,"Now, anywhere within the lifecycle of a request, we can access the local store instance."),e.qZA()(),e.TgZ(99,"span",10),e._uU(100),e.ALo(101,"extension"),e._UZ(102,"app-tabs",null,17),e.qZA(),e.TgZ(104,"pre")(105,"code",15),e._uU(106,'\n@Injectable()\nexport class CatService {\n  constructor(\n    // We can inject the provided ALS instance.\n    private readonly als: AsyncLocalStorage,\n    private readonly catRepository: CatRepository,\n  ) {}\n\n  getCatForUser() {\n    // The "getStore" method will always return the\n    // store instance associated with the given request.\n    const userId = this.als.getStore()["userId"] as number;\n    return this.catRepository.getForUser(userId);\n  }\n}\n'),e.qZA()(),e.TgZ(107,"pre")(108,"code",15),e._uU(109,'\n@Injectable()\n@Dependencies(AsyncLocalStorage, CatRepository)\nexport class CatService {\n  constructor(als, catRepository) {\n    // We can inject the provided ALS instance.\n    this.als = als\n    this.catRepository = catRepository\n  }\n\n  getCatForUser() {\n    // The "getStore" method will always return the\n    // store instance associated with the given request.\n    const userId = this.als.getStore()["userId"] as number;\n    return this.catRepository.getForUser(userId);\n  }\n}\n'),e.qZA()(),e.TgZ(110,"ol",18)(111,"li"),e._uU(112,"That's it. Now we have a way to share request related state without needing to inject the whole "),e.TgZ(113,"code"),e._uU(114,"REQUEST"),e.qZA(),e._uU(115," object."),e.qZA()(),e.TgZ(116,"blockquote",19)(117,"strong"),e._uU(118,"warning"),e.qZA(),e._uU(119,' Please be aware that while the technique is useful for many use-cases, it inherently obfuscates the code flow (creating implicit context), so use it responsibly and especially avoid creating contextual "'),e.TgZ(120,"a",20),e._uU(121,"God objects"),e.qZA(),e._uU(122,'".\n'),e.qZA(),e.TgZ(123,"h3",21),e._uU(124,"NestJS CLS"),e.qZA(),e.TgZ(125,"p"),e._uU(126,"The "),e.TgZ(127,"a",22),e._uU(128,"nestjs-cls"),e.qZA(),e._uU(129," package provides several DX improvements over using plain "),e.TgZ(130,"code"),e._uU(131,"AsyncLocalStorage"),e.qZA(),e._uU(132," ("),e.TgZ(133,"code"),e._uU(134,"CLS"),e.qZA(),e._uU(135," is an abbreviation of the term "),e.TgZ(136,"em"),e._uU(137,"continuation-local storage"),e.qZA(),e._uU(138,"). It abstracts the implementation into a "),e.TgZ(139,"code"),e._uU(140,"ClsModule"),e.qZA(),e._uU(141," that offers various ways of initializing the "),e.TgZ(142,"code"),e._uU(143,"store"),e.qZA(),e._uU(144," for different transports (not only HTTP), as well as a strong-typing support."),e.qZA(),e.TgZ(145,"p"),e._uU(146,"The store can then be accessed with an injectable "),e.TgZ(147,"code"),e._uU(148,"ClsService"),e.qZA(),e._uU(149,", or entirely abstracted away from the business logic by using "),e.TgZ(150,"a",23),e._uU(151,"Proxy Providers"),e.qZA(),e._uU(152,"."),e.qZA(),e.TgZ(153,"blockquote",8)(154,"strong"),e._uU(155,"info"),e.qZA(),e.TgZ(156,"code"),e._uU(157,"nestjs-cls"),e.qZA(),e._uU(158," is a third party package and is not managed by the NestJS core team. Please, report any issues found with the library in the "),e.TgZ(159,"a",24),e._uU(160,"appropriate repository"),e.qZA(),e._uU(161,".\n"),e.qZA(),e.TgZ(162,"h4",25)(163,"span"),e._uU(164,"Installation"),e.qZA()(),e.TgZ(165,"p"),e._uU(166,"Apart from a peer dependency on the "),e.TgZ(167,"code"),e._uU(168,"@nestjs"),e.qZA(),e._uU(169," libs, it only uses the built-in Node.js API. Install it as any other package."),e.qZA(),e.TgZ(170,"pre")(171,"code",26),e._uU(172,"\nnpm i nestjs-cls\n"),e.qZA()(),e.TgZ(173,"h4",27)(174,"span"),e._uU(175,"Usage"),e.qZA()(),e.TgZ(176,"p"),e._uU(177,"A similar functionality as described "),e.TgZ(178,"a",28),e._uU(179,"above"),e.qZA(),e._uU(180," can be implemented using "),e.TgZ(181,"code"),e._uU(182,"nestjs-cls"),e.qZA(),e._uU(183," as follows:"),e.qZA(),e.TgZ(184,"ol")(185,"li"),e._uU(186,"Import the "),e.TgZ(187,"code"),e._uU(188,"ClsModule"),e.qZA(),e._uU(189," in the root module."),e.qZA()(),e.TgZ(190,"span",10),e._uU(191),e.ALo(192,"extension"),e._UZ(193,"app-tabs",null,29),e.qZA(),e.TgZ(195,"pre")(196,"code",12),e._uU(197,"\n@Module({\n  imports: [\n    // Register the ClsModule,\n    ClsModule.forRoot({\n      middleware: {\n        // automatically mount the\n        // ClsMiddleware for all routes\n        mount: true,\n        // and use the setup method to\n        // provide default store values.\n        setup: (cls, req) => {\n          cls.set('userId', req.headers['x-user-id']);\n        },\n      },\n    }),\n  ],\n  providers: [CatService],\n  controllers: [CatController],\n})\nexport class AppModule {}\n"),e.qZA()(),e.TgZ(198,"ol",13)(199,"li"),e._uU(200,"And then can use the "),e.TgZ(201,"code"),e._uU(202,"ClsService"),e.qZA(),e._uU(203," to access the store values."),e.qZA()(),e.TgZ(204,"span",10),e._uU(205),e.ALo(206,"extension"),e._UZ(207,"app-tabs",null,30),e.qZA(),e.TgZ(209,"pre")(210,"code",15),e._uU(211,"\n@Injectable()\nexport class CatService {\n  constructor(\n    // We can inject the provided ClsService instance,\n    private readonly cls: ClsService,\n    private readonly catRepository: CatRepository,\n  ) {}\n\n  getCatForUser() {\n    // and use the \"get\" method to retrieve any stored value.\n    const userId = this.cls.get('userId');\n    return this.catRepository.getForUser(userId);\n  }\n}\n"),e.qZA()(),e.TgZ(212,"pre")(213,"code",15),e._uU(214,"\n@Injectable()\n@Dependencies(AsyncLocalStorage, CatRepository)\nexport class CatService {\n  constructor(als, catRepository) {\n    // We can inject the provided ClsService instance,\n    this.als = als\n    this.catRepository = catRepository\n  }\n\n  getCatForUser() {\n    // and use the \"get\" method to retrieve any stored value.\n    const userId = this.cls.get('userId');\n    return this.catRepository.getForUser(userId);\n  }\n}\n"),e.qZA()(),e.TgZ(215,"ol",16)(216,"li"),e._uU(217,"To get strong typing of the store values managed by the "),e.TgZ(218,"code"),e._uU(219,"ClsService"),e.qZA(),e._uU(220," (and also get auto-suggestions of the string keys), we can use an optional type parameter "),e.TgZ(221,"code"),e._uU(222,"ClsService<MyClsStore>"),e.qZA(),e._uU(223," when injecting it."),e.qZA()(),e.TgZ(224,"pre")(225,"code",12),e._uU(226,"\nexport interface MyClsStore extends ClsStore {\n  userId: number\n}\n"),e.qZA()(),e.TgZ(227,"blockquote",8)(228,"strong"),e._uU(229,"hint"),e.qZA(),e._uU(230," It it also possible to let the package automatically generate a Request ID and access it later with "),e.TgZ(231,"code"),e._uU(232,"cls.getId()"),e.qZA(),e._uU(233,", or to get the whole Request object using "),e.TgZ(234,"code"),e._uU(235,"cls.get(CLS_REQ)"),e.qZA(),e._uU(236,".\n"),e.qZA(),e.TgZ(237,"h4",31)(238,"span"),e._uU(239,"Testing"),e.qZA()(),e.TgZ(240,"p"),e._uU(241,"Since the "),e.TgZ(242,"code"),e._uU(243,"ClsService"),e.qZA(),e._uU(244," is just another injectable provider, it can be entirely mocked out in unit tests."),e.qZA(),e.TgZ(245,"p"),e._uU(246,"However, in certain integration tests, we might still want to use the real "),e.TgZ(247,"code"),e._uU(248,"ClsService"),e.qZA(),e._uU(249," implementation. In that case, we will need to wrap the context-aware piece of code with a call to "),e.TgZ(250,"code"),e._uU(251,"ClsService#run"),e.qZA(),e._uU(252," or "),e.TgZ(253,"code"),e._uU(254,"ClsService#runWith"),e.qZA(),e._uU(255,"."),e.qZA(),e.TgZ(256,"pre")(257,"code",12),e._uU(258,"\ndescribe('CatService', () => {\n  let service: CatService\n  let cls: ClsService\n  const mockCatRepository = createMock<CatRepository>()\n\n  beforeEach(async () => {\n    const module = await Test.createTestingModule({\n      // Set up most of the testing module as we normally would.\n      providers: [\n        CatService,\n        {\n          provide: CatRepository\n          useValue: mockCatRepository\n        }\n      ],\n      imports: [\n        // Import the static version of ClsModule which only provides\n        // the ClsService, but does not set up the store in any way.\n        ClsModule\n      ],\n    }).compile()\n\n    service = module.get(CatService)\n\n    // Also retrieve the ClsService for later use.\n    cls = module.get(ClsService)\n  })\n\n  describe('getCatForUser', () => {\n    it('retrieves cat based on user id', async () => {\n      const expectedUserId = 42\n      mockCatRepository.getForUser.mockImplementationOnce(\n        (id) => ({ userId: id })\n      )\n\n      // Wrap the test call in the `runWith` method\n      // in which we can pass hand-crafted store values.\n      const cat = await cls.runWith(\n        { userId: expectedUserId },\n        () => service.getCatForUser()\n      )\n\n      expect(cat.userId).toEqual(expectedUserId)\n    })\n  })\n})\n"),e.qZA()(),e.TgZ(259,"h4",32)(260,"span"),e._uU(261,"More information"),e.qZA()(),e.TgZ(262,"p"),e._uU(263,"Visit the "),e.TgZ(264,"a",22),e._uU(265,"NestJS CLS GitHub Page"),e.qZA(),e._uU(266," for the full API documentation and more code examples."),e.qZA()()),2&n){const r=e.MAs(60),a=e.MAs(89),u=e.MAs(103),c=e.MAs(194),i=e.MAs(208);e.xp6(57),e.hij(" ",e.xi3(58,17,"als.module",r.isJsActive),"\n"),e.xp6(29),e.hij(" ",e.xi3(87,20,"app.module",a.isJsActive),"\n"),e.xp6(4),e.ekj("hide",a.isJsActive),e.xp6(3),e.ekj("hide",!a.isJsActive),e.xp6(7),e.hij(" ",e.xi3(101,23,"cat.service",u.isJsActive),"\n"),e.xp6(4),e.ekj("hide",u.isJsActive),e.xp6(3),e.ekj("hide",!u.isJsActive),e.xp6(84),e.hij(" ",e.xi3(192,26,"app.module",c.isJsActive),"\n"),e.xp6(14),e.hij(" ",e.xi3(206,29,"cat.service",i.isJsActive),"\n"),e.xp6(4),e.ekj("hide",i.isJsActive),e.xp6(3),e.ekj("hide",!i.isJsActive)}},dependencies:[Z.n,d.U,m.F],encapsulation:2,changeDetection:0}));class H extends l.y{}(0,s.Z)(H,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(H)))(o||H)}}()),(0,s.Z)(H,"\u0275cmp",e.Xpm({type:H,selectors:[["app-automock"]],features:[e.qOj],decls:171,vars:8,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/automock.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","automock"],[1,"info"],["rel","nofollow","target","_blank","href","https://github.com/omermorad/automock"],["appAnchor","","id","introduction"],["appAnchor","","id","installation"],[1,"language-bash"],["appAnchor","","id","example"],[1,"filename"],["appe3976fd9c675d661fe255038b9de041a733ce31e",""],[1,"language-ts"],["appabecdd94d41cf1cee161e3b26be599b67ee55203",""],["rel","nofollow","target","_blank","href","https://jestjs.io/docs/mock-function-api/#jestmockedsource"],["appAnchor","","id","about-unit-and-unitref"],[1,"language-typescript"],["appAnchor","","id","working-with-different-providers"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/fundamentals/custom-providers"],["appAnchor","","id","more-information"]],template:function(n,o){if(1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"Automock"),e.qZA(),e.TgZ(7,"p"),e._uU(8,"Automock is a standalone library for unit testing. Using TypeScript Reflection\nAPI ("),e.TgZ(9,"code"),e._uU(10,"reflect-metadata"),e.qZA(),e._uU(11,") internally to produce mock objects, Automock streamlines\ntest development by automatically mocking class external dependencies."),e.qZA(),e.TgZ(12,"blockquote",6)(13,"strong"),e._uU(14,"info"),e.qZA(),e.TgZ(15,"code"),e._uU(16,"Automock"),e.qZA(),e._uU(17," is a third party package and is not managed by the NestJS core team.\nPlease, report any issues found with the library in the "),e.TgZ(18,"a",7),e._uU(19,"appropriate repository"),e.qZA()(),e.TgZ(20,"h4",8)(21,"span"),e._uU(22,"Introduction"),e.qZA()(),e.TgZ(23,"p"),e._uU(24,'The dependency injection (DI) container is an essential component of the Nest module system.\nThis container is utilized both during testing, and the application execution.\nUnit tests vary from other types of tests, such as integration tests, in that they must\nfully override providers/services within the DI container. External class dependencies\n(providers) of the so-called "unit", have to be totally isolated. That is, all dependencies\nwithin the DI container should be replaced by mock objects.\nAs a result, loading the target module and replacing the providers inside it is a process\nthat loops back on itself. Automock tackles this issue by automatically mocking all the\nclass external providers, resulting in total isolation of the unit under test.'),e.qZA(),e.TgZ(25,"h4",9)(26,"span"),e._uU(27,"Installation"),e.qZA()(),e.TgZ(28,"pre")(29,"code",10),e._uU(30,"\n$ npm i -D @automock/jest\n"),e.qZA()(),e.TgZ(31,"p"),e._uU(32,"Automock does not require any additional setup."),e.qZA(),e.TgZ(33,"blockquote",6)(34,"strong"),e._uU(35,"info"),e.qZA(),e._uU(36," Jest is the only test framework currently supported by Automock.\nSinon will shortly be released.\n"),e.qZA(),e.TgZ(37,"h4",11)(38,"span"),e._uU(39,"Example"),e.qZA()(),e.TgZ(40,"p"),e._uU(41,"Consider the following cats service, which takes three constructor parameters:"),e.qZA(),e.TgZ(42,"span",12),e._uU(43),e.ALo(44,"extension"),e._UZ(45,"app-tabs",null,13),e.qZA(),e.TgZ(47,"pre")(48,"code",14),e._uU(49,"\nimport { Injectable } from '@nestjs/core';\n\n@Injectable()\nexport class CatsService {\n  constructor(\n    private logger: Logger,\n    private httpService: HttpService,\n    private catsDal: CatsDal,\n  ) {}\n\n  async getAllCats() {\n    const cats = await this.httpService.get('http://localhost:3000/api/cats');\n    this.logger.log('Successfully fetched all cats');\n    \n    this.catsDal.saveCats(cats);\n  }\n}\n"),e.qZA()(),e.TgZ(50,"p"),e._uU(51,"The service contains one public method, "),e.TgZ(52,"code"),e._uU(53,"getAllCats"),e.qZA(),e._uU(54,", which is the method\nwe use an example for the following unit test:"),e.qZA(),e.TgZ(55,"span",12),e._uU(56),e.ALo(57,"extension"),e._UZ(58,"app-tabs",null,15),e.qZA(),e.TgZ(60,"pre")(61,"code",14),e._uU(62,"\nimport { TestBed } from '@automock/jest';\nimport { CatsService } from './cats.service';\n\ndescribe('CatsService unit spec', () => {\n  let underTest: CatsService;\n  let logger: jest.Mocked<Logger>;\n  let httpService: jest.Mocked<HttpService>;\n  let catsDal: jest.Mocked<CatsDal>;\n  \n  beforeAll(() => {\n    const { unit, unitRef } = TestBed.create(CatsService)\n      .mock(HttpService)\n      .using({ get: jest.fn() })\n      .mock(Logger)\n      .using({ log: jest.fn() })\n      .mock(CatsDal)\n      .using({ saveCats: jest.fn() })\n      .compile();\n\n    underTest = unit;\n\n    logger = unitRef.get(Logger);\n    httpService = unitRef.get(HttpService);\n    catsDal = unitRef.get(CatsDal);\n  });\n\n  describe('when getting all the cats', () => {\n    test('then meet some expectations', async () => {\n      httpService.get.mockResolvedValueOnce([{ id: 1, name: 'Catty' }]);\n      await catsService.getAllCats();\n\n      expect(logger.log).toBeCalled();\n      expect(catsDal).toBeCalledWith([{ id: 1, name: 'Catty' }]);\n    });\n  });\n});\n"),e.qZA()(),e.TgZ(63,"blockquote",6)(64,"strong"),e._uU(65,"info"),e.qZA(),e._uU(66," The jest.Mocked"),e._UZ(67,"Source"),e._uU(68," utility type returns the Source type\nwrapped with type definitions of Jest mock function. ("),e.TgZ(69,"a",16),e._uU(70,"reference"),e.qZA(),e._uU(71,")\n"),e.qZA(),e.TgZ(72,"h4",17)(73,"span"),e._uU(74,"About "),e.TgZ(75,"code"),e._uU(76,"unit"),e.qZA(),e._uU(77," and "),e.TgZ(78,"code"),e._uU(79,"unitRef"),e.qZA()()(),e.TgZ(80,"p"),e._uU(81,"Let's examine the following code:"),e.qZA(),e.TgZ(82,"pre")(83,"code",18),e._uU(84,"\nconst { unit, unitRef } = TestBed.create(CatsService).compile();\n"),e.qZA()(),e.TgZ(85,"p"),e._uU(86,"Calling "),e.TgZ(87,"code"),e._uU(88,".compile()"),e.qZA(),e._uU(89," returns an object with two properties, "),e.TgZ(90,"code"),e._uU(91,"unit"),e.qZA(),e._uU(92,", and "),e.TgZ(93,"code"),e._uU(94,"unitRef"),e.qZA(),e._uU(95,"."),e.qZA(),e.TgZ(96,"p")(97,"strong")(98,"code"),e._uU(99,"unit"),e.qZA()(),e._uU(100," is the unit under test, it is an actual instance of class being tested."),e.qZA(),e.TgZ(101,"p")(102,"strong")(103,"code"),e._uU(104,"unitRef"),e.qZA()(),e._uU(105,' is the "unit reference", where the mocked dependencies of the tested class\nare stored, in a small container. The container\'s '),e.TgZ(106,"code"),e._uU(107,".get()"),e.qZA(),e._uU(108," method returns the mocked\ndependency with all of its methods automatically stubbed (using "),e.TgZ(109,"code"),e._uU(110,"jest.fn()"),e.qZA(),e._uU(111,"):"),e.qZA(),e.TgZ(112,"pre")(113,"code",18),e._uU(114,"\nconst { unit, unitRef } = TestBed.create(CatsService).compile();\n\nlet httpServiceMock: jest.Mocked<HttpService> = unitRef.get(HttpService);\n"),e.qZA()(),e.TgZ(115,"blockquote",6)(116,"strong"),e._uU(117,"info"),e.qZA(),e._uU(118," The "),e.TgZ(119,"code"),e._uU(120,".get()"),e.qZA(),e._uU(121," method can accept either a "),e.TgZ(122,"code"),e._uU(123,"string"),e.qZA(),e._uU(124," or an actual class ("),e.TgZ(125,"code"),e._uU(126,"Type"),e.qZA(),e._uU(127,") as its argument.\nThis essentially depends on how the provider is being injected to the class under test.\n"),e.qZA(),e.TgZ(128,"h4",19)(129,"span"),e._uU(130,"Working with different providers"),e.qZA()(),e.TgZ(131,"p"),e._uU(132,"Providers are one of the most important elements in Nest. You can think of many of\nthe default Nest classes as providers, including services, repositories, factories,\nhelpers, and so on. A provider's primary function is to take the form of an\n"),e.TgZ(133,"code"),e._uU(134,"Injectable"),e.qZA(),e._uU(135," dependency."),e.qZA(),e.TgZ(136,"p"),e._uU(137,"Consider the following "),e.TgZ(138,"code"),e._uU(139,"CatsService"),e.qZA(),e._uU(140,", it takes one parameter, which is an instance\nof the following "),e.TgZ(141,"code"),e._uU(142,"Logger"),e.qZA(),e._uU(143," interface:"),e.qZA(),e.TgZ(144,"pre")(145,"code",18),e._uU(146,"\nexport interface Logger {\n  log(message: string): void;\n}\n\nexport class CatsService {\n  constructor(private logger: Logger) {}\n}\n"),e.qZA()(),e.TgZ(147,"p"),e._uU(148,"TypeScript's Reflection API does not support interface reflection yet.\nNest solves this issue with string-based injection tokens (see "),e.TgZ(149,"a",20),e._uU(150,"Custom Providers"),e.qZA(),e._uU(151,"):"),e.qZA(),e.TgZ(152,"pre")(153,"code",18),e._uU(154,"\nexport const MyLoggerProvider = {\n  provide: 'MY_LOGGER_TOKEN',\n  useValue: { ... },\n}\n\nexport class CatsService {\n  constructor(@Inject('MY_LOGGER_TOKEN') private readonly logger: Logger) {}\n}\n"),e.qZA()(),e.TgZ(155,"p"),e._uU(156,"Automock follows this practice and lets you provide a string-based token instead\nof providing the actual class in the "),e.TgZ(157,"code"),e._uU(158,"unitRef.get()"),e.qZA(),e._uU(159," method:"),e.qZA(),e.TgZ(160,"pre")(161,"code",18),e._uU(162,"\nconst { unit, unitRef } = TestBed.create(CatsService).compile();\n\nlet loggerMock: jest.Mocked<Logger> = unitRef.get('MY_LOGGER_TOKEN');\n"),e.qZA()(),e.TgZ(163,"h4",21)(164,"span"),e._uU(165,"More Information"),e.qZA()(),e.TgZ(166,"p"),e._uU(167,"Visit "),e.TgZ(168,"a",7),e._uU(169,"Automock GitHub repository"),e.qZA(),e._uU(170," for more\ninformation."),e.qZA()()),2&n){const r=e.MAs(46),a=e.MAs(59);e.xp6(43),e.hij(" ",e.xi3(44,2,"cats.service",r.isJsActive),"\n"),e.xp6(13),e.hij(" ",e.xi3(57,5,"cats.service.spec",a.isJsActive),"\n")}},dependencies:[Z.n,d.U,m.F],encapsulation:2,changeDetection:0}));class L extends l.y{}(0,s.Z)(L,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(L)))(o||L)}}()),(0,s.Z)(L,"\u0275cmp",e.Xpm({type:L,selectors:[["app-swc"]],features:[e.qOj],decls:177,vars:0,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/swc.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","swc"],[1,"warning"],["rel","nofollow","target","_blank","href","https://swc.rs/"],[1,"info"],["appAnchor","","id","installation"],[1,"language-bash"],[1,"language-json"],["appAnchor","","id","scripts"],["appAnchor","","id","common-pitfalls"],[1,"language-typescript"],["id","vitest"],["rel","nofollow","target","_blank","href","https://vitest.dev/"],["appAnchor","","id","installation-1"],["appAnchor","","id","configuration"],[1,"language-ts"],["appAnchor","","id","update-imports-in-e2e-tests"],["rel","nofollow","target","_blank","href","https://github.com/TrilonIO/nest-vitest"]],template:function(n,o){1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"SWC"),e.qZA(),e.TgZ(7,"blockquote",6)(8,"strong"),e._uU(9,"Warning"),e.qZA(),e._uU(10," SWC isn't compatible with "),e.TgZ(11,"strong"),e._uU(12,"NestJS CLI plugins"),e.qZA(),e._uU(13,". If you're using a plugin, you should stick to "),e.TgZ(14,"code"),e._uU(15,"tsc"),e.qZA(),e._uU(16," or "),e.TgZ(17,"code"),e._uU(18,"webpack"),e.qZA(),e._uU(19," ("),e.TgZ(20,"code"),e._uU(21,"nest build"),e.qZA(),e._uU(22," and "),e.TgZ(23,"code"),e._uU(24,"nest start"),e.qZA(),e._uU(25,").\n"),e.qZA(),e.TgZ(26,"p")(27,"a",7),e._uU(28,"SWC"),e.qZA(),e._uU(29," (Speedy Web Compiler) is an extensible Rust-based platform that can be used for both compilation and bundling."),e.qZA(),e.TgZ(30,"blockquote",8)(31,"strong"),e._uU(32,"Hint"),e.qZA(),e._uU(33," SWC is 20x faster than Babel on a single thread and 70x faster on four cores.\n"),e.qZA(),e.TgZ(34,"h4",9)(35,"span"),e._uU(36,"Installation"),e.qZA()(),e.TgZ(37,"p"),e._uU(38,"To get started, first install a few packages:"),e.qZA(),e.TgZ(39,"pre")(40,"code",10),e._uU(41,"\n$ npm i --save-dev @swc/cli @swc/core nodemon\n"),e.qZA()(),e.TgZ(42,"p"),e._uU(43,"Once the installation process is complete, let's create a new "),e.TgZ(44,"code"),e._uU(45,".swcrc"),e.qZA(),e._uU(46," file in the root directory of your application:"),e.qZA(),e.TgZ(47,"pre")(48,"code",11),e._uU(49,'\n{\n  "$schema": "https://json.schemastore.org/swcrc",\n  "sourceMaps": true,\n  "module": {\n    "type": "commonjs"\n  },\n  "jsc": {\n    "target": "es2017",\n    "parser": {\n      "syntax": "typescript",\n      "decorators": true,\n      "dynamicImport": true\n    },\n    "transform": {\n      "legacyDecorator": true,\n      "decoratorMetadata": true\n    },\n    "keepClassNames": true,\n    "baseUrl": "./"\n  },\n  "minify": false\n}\n'),e.qZA()(),e.TgZ(50,"h4",12)(51,"span"),e._uU(52,"Scripts"),e.qZA()(),e.TgZ(53,"p"),e._uU(54,"To make the development process easier, let's add a few scripts to the "),e.TgZ(55,"code"),e._uU(56,"package.json"),e.qZA(),e._uU(57," file:"),e.qZA(),e.TgZ(58,"pre")(59,"code",11),e._uU(60,'\n{\n  "scripts": {\n    "build:swc": "npx swc --out-dir dist -w src",\n    "start:swc": "nodemon dist/main"\n  }\n}\n'),e.qZA()(),e.TgZ(61,"blockquote",8)(62,"strong"),e._uU(63,"Hint"),e.qZA(),e._uU(64," Both scripts are dedicated for development purposes only.\n"),e.qZA(),e.TgZ(65,"p"),e._uU(66,"Now, open up the terminal and run the follwoing command:"),e.qZA(),e.TgZ(67,"pre")(68,"code",10),e._uU(69,"\n$ npm run build:swc\n"),e.qZA()(),e.TgZ(70,"p"),e._uU(71,"In another terminal window, run the following command:"),e.qZA(),e.TgZ(72,"pre")(73,"code",10),e._uU(74,"\n$ npm run start:swc\n"),e.qZA()(),e.TgZ(75,"p"),e._uU(76,"Every time you make a change to your application, the "),e.TgZ(77,"code"),e._uU(78,"build:swc"),e.qZA(),e._uU(79," script will recompile your application and the "),e.TgZ(80,"code"),e._uU(81,"start:swc"),e.qZA(),e._uU(82," script will restart the application."),e.qZA(),e.TgZ(83,"h4",13)(84,"span"),e._uU(85,"Common pitfalls"),e.qZA()(),e.TgZ(86,"p"),e._uU(87,"If you use TypeORM/MikroORM or any other ORM in your application, you may stumble upon circular import issues. SWC doesn't handle "),e.TgZ(88,"strong"),e._uU(89,"circular imports"),e.qZA(),e._uU(90," well, so you should use the following workaround:"),e.qZA(),e.TgZ(91,"pre")(92,"code",14),e._uU(93,'\n@Entity()\nexport class User {\n  @OneToOne(() => Profile, (profile) => profile.user)\n  profile: Relation<Profile>; // <--- see "Relation<>" type here instead of just "Profile"\n}\n'),e.qZA()(),e.TgZ(94,"blockquote",8)(95,"strong"),e._uU(96,"Hint"),e.qZA(),e.TgZ(97,"code"),e._uU(98,"Relation"),e.qZA(),e._uU(99," type is exported from the "),e.TgZ(100,"code"),e._uU(101,"typeorm"),e.qZA(),e._uU(102," package.\n"),e.qZA(),e.TgZ(103,"p"),e._uU(104,"Doing this prevents the type of the property from being saved in the transpiled code in the property metadata, preventing circular dependency issues."),e.qZA(),e.TgZ(105,"p"),e._uU(106,"If your ORM does not provide a similar workaround, you can define the wrapper type yourself:"),e.qZA(),e.TgZ(107,"pre")(108,"code",14),e._uU(109,"\n/**\n * Wrapper type used to circumvent ESM modules circular dependency issue\n * caused by reflection metadata saving the type of the property.\n */\nexport type WrapperType<T> = T; // WrapperType === Relation\n"),e.qZA()(),e.TgZ(110,"h3",15),e._uU(111,"Vitest"),e.qZA(),e.TgZ(112,"p")(113,"a",16),e._uU(114,"Vitest"),e.qZA(),e._uU(115," is a fast and lightweight test runner designed to work with Vite. It provides a modern, fast, and easy-to-use testing solution that can be integrated with NestJS projects."),e.qZA(),e.TgZ(116,"h4",17)(117,"span"),e._uU(118,"Installation"),e.qZA()(),e.TgZ(119,"p"),e._uU(120,"To get started, first install the required packages:"),e.qZA(),e.TgZ(121,"pre")(122,"code",10),e._uU(123,"\n$ npm i --save-dev vitest unplugin-swc @swc/core @vitest/coverage-c8\n"),e.qZA()(),e.TgZ(124,"h4",18)(125,"span"),e._uU(126,"Configuration"),e.qZA()(),e.TgZ(127,"p"),e._uU(128,"Create a "),e.TgZ(129,"code"),e._uU(130,"vitest.config.ts"),e.qZA(),e._uU(131," file in the root directory of your application with the following content:"),e.qZA(),e.TgZ(132,"pre")(133,"code",19),e._uU(134,"\nimport swc from 'unplugin-swc';\nimport { defineConfig } from 'vitest/config';\n\nexport default defineConfig({\n  test: {\n    globals: true,\n    root: './',\n  },\n  plugins: [\n    // This is required to build the test files with SWC\n    swc.vite({\n      // Explicitly set the module type to avoid inheriting this value from a `.swcrc` config file\n      module: { type: 'es6' },\n    }),\n  ],\n});\n"),e.qZA()(),e.TgZ(135,"p"),e._uU(136,"This configuration file sets up the Vitest environment, root directory, and SWC plugin. You should also create a separate configuration\nfile for e2e tests, with an additional "),e.TgZ(137,"code"),e._uU(138,"include"),e.qZA(),e._uU(139," field that specifies the test path regex:"),e.qZA(),e.TgZ(140,"pre")(141,"code",19),e._uU(142,"\nimport swc from 'unplugin-swc';\nimport { defineConfig } from 'vitest/config';\n\nexport default defineConfig({\n  test: {\n    include: ['**/*.e2e-spec.ts'],\n    globals: true,\n    root: './',\n  },\n  plugins: [swc.vite()],\n});\n"),e.qZA()(),e.TgZ(143,"p"),e._uU(144,"Additionally, you can set the "),e.TgZ(145,"code"),e._uU(146,"alias"),e.qZA(),e._uU(147," options to support TypeScript paths in your tests:"),e.qZA(),e.TgZ(148,"pre")(149,"code",19),e._uU(150,"\nimport swc from 'unplugin-swc';\nimport { defineConfig } from 'vitest/config';\n\nexport default defineConfig({\n  test: {\n    include: ['**/*.e2e-spec.ts'],\n    globals: true,\n    alias: {\n      '@src': './src',\n      '@test': './test',\n    },\n    root: './',\n  },\n  resolve: {\n    alias: {\n      '@src': './src',\n      '@test': './test',\n    },\n  },\n  plugins: [swc.vite()],\n});\n"),e.qZA()(),e.TgZ(151,"h4",20)(152,"span"),e._uU(153,"Update imports in E2E tests"),e.qZA()(),e.TgZ(154,"p"),e._uU(155,"Change any E2E test imports using "),e.TgZ(156,"code"),e._uU(157,"import * as request from 'supertest'"),e.qZA(),e._uU(158," to "),e.TgZ(159,"code"),e._uU(160,"import request from 'supertest'"),e.qZA(),e._uU(161,". This is necessary because Vitest, when bundled with Vite, expects a default import for supertest. Using a namespace import may cause issues in this specific setup."),e.qZA(),e.TgZ(162,"p"),e._uU(163,"Lastly, update the test scripts in your package.json file to the following:"),e.qZA(),e.TgZ(164,"pre")(165,"code",11),e._uU(166,'\n{\n  "scripts": {\n    "test": "vitest run",\n    "test:watch": "vitest",\n    "test:cov": "vitest run --coverage",\n    "test:debug": "vitest --inspect-brk --inspect --logHeapUsage --threads=false",\n    "test:e2e": "vitest run --config ./vitest.config.e2e.ts"\n  }\n}\n'),e.qZA()(),e.TgZ(167,"p"),e._uU(168,"These scripts configure Vitest for running tests, watching for changes, generating code coverage reports, and debugging. The test:e2e script is specifically for running E2E tests with a custom configuration file."),e.qZA(),e.TgZ(169,"p"),e._uU(170,"With this setup, you can now enjoy the benefits of using Vitest in your NestJS project, including faster test execution and a more modern testing experience."),e.qZA(),e.TgZ(171,"blockquote",8)(172,"strong"),e._uU(173,"Hint"),e.qZA(),e._uU(174," You can check out a working example in this "),e.TgZ(175,"a",21),e._uU(176,"repository"),e.qZA()()())},dependencies:[d.U],encapsulation:2,changeDetection:0}));var Q=h(190);class J extends l.y{}(0,s.Z)(J,"\u0275fac",function(){let t;return function(o){return(t||(t=e.n5z(J)))(o||J)}}()),(0,s.Z)(J,"\u0275cmp",e.Xpm({type:J,selectors:[["app-passport"]],features:[e.qOj],decls:1172,vars:122,consts:[[1,"content"],["contentReference",""],[1,"github-links"],["href","https://github.com/nestjs/docs.nestjs.com/edit/master/content/recipes/passport.md","aria-label","Suggest Edits","title","Suggest Edits"],[1,"fas","fa-edit"],["id","passport-authentication"],["rel","nofollow","target","_blank","href","https://github.com/jaredhanson/passport"],["rel","nofollow","target","_blank","href","https://jwt.io/"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/session"],["rel","nofollow","target","_blank","href","http://www.passportjs.org/"],["appAnchor","","id","authentication-requirements"],["rel","nofollow","target","_blank","href","https://tools.ietf.org/html/rfc6750"],["rel","nofollow","target","_blank","href","https://github.com/jaredhanson/passport-local"],[1,"language-bash"],[1,"warning"],["appAnchor","","id","implementing-passport-strategies"],[1,"filename"],["app87212465fe2bf3eff6d80e17dbd2f11a63e50c22",""],[1,"language-typescript"],["app77827ece349e9bf6694b3f06845a0939e7e5245a",""],["app327d08507655a945ea2e285a2e93675fd72e1d6c",""],[1,"Warning"],["rel","nofollow","target","_blank","href","https://github.com/kelektiv/node.bcrypt.js#readme"],["app2b878960efe796fb759446db3cf8050d8c7d173e",""],["appAnchor","","id","implementing-passport-local"],["app6578291639dcfc8f4eb3e89b08010b5a39436f71",""],[1,"info"],["rel","nofollow","target","_blank","href","http://www.passportjs.org/docs/configure/"],["href","exception-filters"],["app9233825243acc5793788e502c87054bc3d1dad9b",""],["appAnchor","","id","built-in-passport-guards"],["href","guards"],["appAnchor","","id","login-route"],["app880b14edffdaf88b7cd63f0d24bfc6a3a94b1c45",""],["rel","nofollow","target","_blank","href","https://curl.haxx.se/"],["appffebecce5d60f99ff22b67b354ca9a0248294ea9",""],["appAnchor","","id","jwt-functionality"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/jwt"],["app8c61a9d82ad59e8b6833e96bc5e6fccae8cbc26a",""],["app8e17d613498977613dfd541603a56640bbda2f3d",""],["app1425d5e44e2739f63c8360c5036340399c68f801",""],["rel","nofollow","target","_blank","href","https://github.com/nestjs/jwt/blob/master/README.md"],["rel","nofollow","target","_blank","href","https://github.com/auth0/node-jsonwebtoken#usage"],["app7ef5438c03a8cf1eb85c02ab1699eb47e4a0b9ce",""],["appAnchor","","id","implementing-passport-jwt"],["rel","nofollow","target","_blank","href","https://github.com/mikenicholson/passport-jwt"],["appd8fe02d1c8766a58da0ddda1da393addf8184157",""],["rel","nofollow","target","_blank","href","https://github.com/mikenicholson/passport-jwt#configure-strategy"],["rel","nofollow","target","_blank","href","https://github.com/mikenicholson/passport-jwt#extracting-the-jwt-from-the-request"],["app224be996b3ae39b8505f3132e957709189b6dec4",""],["appade3c47b401c7630191170d7d88870316ccf5711",""],["appAnchor","","id","implement-protected-route-and-jwt-strategy-guards"],["app25cd8956221d7f0ec4599d4b746bc801ad6d9390",""],["appAnchor","","id","extending-guards"],["appAnchor","","id","enable-authentication-globally"],["href","/guards#binding-guards"],["href","/guards#putting-it-all-together"],["appAnchor","","id","request-scoped-strategies"],["routerLink","/fundamentals/injection-scopes"],["routerLink","/fundamentals/module-ref"],["href","/fundamentals/module-ref#getting-current-sub-tree"],["appAnchor","","id","customize-passport"],["rel","nofollow","target","_blank","href","http://www.passportjs.org/docs/oauth/"],["appAnchor","","id","named-strategies"],["appAnchor","","id","graphql"],["rel","nofollow","target","_blank","href","https://docs.nestjs.com/graphql/quick-start"]],template:function(n,o){if(1&n&&(e.TgZ(0,"div",0,1)(2,"div",2)(3,"a",3),e._UZ(4,"i",4),e.qZA()(),e.TgZ(5,"h3",5),e._uU(6,"Passport (authentication)"),e.qZA(),e.TgZ(7,"p")(8,"a",6),e._uU(9,"Passport"),e.qZA(),e._uU(10," is the most popular node.js authentication library, well-known by the community and successfully used in many production applications. It's straightforward to integrate this library with a "),e.TgZ(11,"strong"),e._uU(12,"Nest"),e.qZA(),e._uU(13," application using the "),e.TgZ(14,"code"),e._uU(15,"@nestjs/passport"),e.qZA(),e._uU(16," module. At a high level, Passport executes a series of steps to:"),e.qZA(),e.TgZ(17,"ul")(18,"li"),e._uU(19,'Authenticate a user by verifying their "credentials" (such as username/password, JSON Web Token ('),e.TgZ(20,"a",7),e._uU(21,"JWT"),e.qZA(),e._uU(22,"), or identity token from an Identity Provider)"),e.qZA(),e.TgZ(23,"li"),e._uU(24,"Manage authenticated state (by issuing a portable token, such as a JWT, or creating an "),e.TgZ(25,"a",8),e._uU(26,"Express session"),e.qZA(),e._uU(27,")"),e.qZA(),e.TgZ(28,"li"),e._uU(29,"Attach information about the authenticated user to the "),e.TgZ(30,"code"),e._uU(31,"Request"),e.qZA(),e._uU(32," object for further use in route handlers"),e.qZA()(),e.TgZ(33,"p"),e._uU(34,"Passport has a rich ecosystem of "),e.TgZ(35,"a",9),e._uU(36,"strategies"),e.qZA(),e._uU(37," that implement various authentication mechanisms. While simple in concept, the set of Passport strategies you can choose from is large and presents a lot of variety. Passport abstracts these varied steps into a standard pattern, and the "),e.TgZ(38,"code"),e._uU(39,"@nestjs/passport"),e.qZA(),e._uU(40," module wraps and standardizes this pattern into familiar Nest constructs."),e.qZA(),e.TgZ(41,"p"),e._uU(42,"In this chapter, we'll implement a complete end-to-end authentication solution for a RESTful API server using these powerful and flexible modules. You can use the concepts described here to implement any Passport strategy to customize your authentication scheme. You can follow the steps in this chapter to build this complete example."),e.qZA(),e.TgZ(43,"h4",10)(44,"span"),e._uU(45,"Authentication requirements"),e.qZA()(),e.TgZ(46,"p"),e._uU(47,"Let's flesh out our requirements. For this use case, clients will start by authenticating with a username and password. Once authenticated, the server will issue a JWT that can be sent as a "),e.TgZ(48,"a",11),e._uU(49,"bearer token in an authorization header"),e.qZA(),e._uU(50," on subsequent requests to prove authentication. We'll also create a protected route that is accessible only to requests that contain a valid JWT."),e.qZA(),e.TgZ(51,"p"),e._uU(52,"We'll start with the first requirement: authenticating a user. We'll then extend that by issuing a JWT. Finally, we'll create a protected route that checks for a valid JWT on the request."),e.qZA(),e.TgZ(53,"p"),e._uU(54,"First we need to install the required packages. Passport provides a strategy called "),e.TgZ(55,"a",12),e._uU(56,"passport-local"),e.qZA(),e._uU(57," that implements a username/password authentication mechanism, which suits our needs for this portion of our use case."),e.qZA(),e.TgZ(58,"pre")(59,"code",13),e._uU(60,"\n$ npm install --save @nestjs/passport passport passport-local\n$ npm install --save-dev @types/passport-local\n"),e.qZA()(),e.TgZ(61,"blockquote",14)(62,"strong"),e._uU(63,"Notice"),e.qZA(),e._uU(64," For "),e.TgZ(65,"strong"),e._uU(66,"any"),e.qZA(),e._uU(67," Passport strategy you choose, you'll always need the "),e.TgZ(68,"code"),e._uU(69,"@nestjs/passport"),e.qZA(),e._uU(70," and "),e.TgZ(71,"code"),e._uU(72,"passport"),e.qZA(),e._uU(73," packages. Then, you'll need to install the strategy-specific package (e.g., "),e.TgZ(74,"code"),e._uU(75,"passport-jwt"),e.qZA(),e._uU(76," or "),e.TgZ(77,"code"),e._uU(78,"passport-local"),e.qZA(),e._uU(79,") that implements the particular authentication strategy you are building. In addition, you can also install the type definitions for any Passport strategy, as shown above with "),e.TgZ(80,"code"),e._uU(81,"@types/passport-local"),e.qZA(),e._uU(82,", which provides assistance while writing TypeScript code.\n"),e.qZA(),e.TgZ(83,"h4",15)(84,"span"),e._uU(85,"Implementing Passport strategies"),e.qZA()(),e.TgZ(86,"p"),e._uU(87,"We're now ready to implement the authentication feature. We'll start with an overview of the process used for "),e.TgZ(88,"strong"),e._uU(89,"any"),e.qZA(),e._uU(90," Passport strategy. It's helpful to think of Passport as a mini framework in itself. The elegance of the framework is that it abstracts the authentication process into a few basic steps that you customize based on the strategy you're implementing. It's like a framework because you configure it by supplying customization parameters (as plain JSON objects) and custom code in the form of callback functions, which Passport calls at the appropriate time. The "),e.TgZ(91,"code"),e._uU(92,"@nestjs/passport"),e.qZA(),e._uU(93," module wraps this framework in a Nest style package, making it easy to integrate into a Nest application. We'll use "),e.TgZ(94,"code"),e._uU(95,"@nestjs/passport"),e.qZA(),e._uU(96," below, but first let's consider how "),e.TgZ(97,"strong"),e._uU(98,"vanilla Passport"),e.qZA(),e._uU(99," works."),e.qZA(),e.TgZ(100,"p"),e._uU(101,"In vanilla Passport, you configure a strategy by providing two things:"),e.qZA(),e.TgZ(102,"ol")(103,"li"),e._uU(104,"A set of options that are specific to that strategy. For example, in a JWT strategy, you might provide a secret to sign tokens."),e.qZA(),e.TgZ(105,"li"),e._uU(106,'A "verify callback", which is where you tell Passport how to interact with your user store (where you manage user accounts). Here, you verify whether a user exists (and/or create a new user), and whether their credentials are valid. The Passport library expects this callback to return a full user if the validation succeeds, or a null if it fails (failure is defined as either the user is not found, or, in the case of passport-local, the password does not match).'),e.qZA()(),e.TgZ(107,"p"),e._uU(108,"With "),e.TgZ(109,"code"),e._uU(110,"@nestjs/passport"),e.qZA(),e._uU(111,", you configure a Passport strategy by extending the "),e.TgZ(112,"code"),e._uU(113,"PassportStrategy"),e.qZA(),e._uU(114," class. You pass the strategy options (item 1 above) by calling the "),e.TgZ(115,"code"),e._uU(116,"super()"),e.qZA(),e._uU(117," method in your subclass, optionally passing in an options object. You provide the verify callback (item 2 above) by implementing a "),e.TgZ(118,"code"),e._uU(119,"validate()"),e.qZA(),e._uU(120," method in your subclass."),e.qZA(),e.TgZ(121,"p"),e._uU(122,"We'll start by generating an "),e.TgZ(123,"code"),e._uU(124,"AuthModule"),e.qZA(),e._uU(125," and in it, an "),e.TgZ(126,"code"),e._uU(127,"AuthService"),e.qZA(),e._uU(128,":"),e.qZA(),e.TgZ(129,"pre")(130,"code",13),e._uU(131,"\n$ nest g module auth\n$ nest g service auth\n"),e.qZA()(),e.TgZ(132,"p"),e._uU(133,"As we implement the "),e.TgZ(134,"code"),e._uU(135,"AuthService"),e.qZA(),e._uU(136,", we'll find it useful to encapsulate user operations in a "),e.TgZ(137,"code"),e._uU(138,"UsersService"),e.qZA(),e._uU(139,", so let's generate that module and service now:"),e.qZA(),e.TgZ(140,"pre")(141,"code",13),e._uU(142,"\n$ nest g module users\n$ nest g service users\n"),e.qZA()(),e.TgZ(143,"p"),e._uU(144,"Replace the default contents of these generated files as shown below. For our sample app, the "),e.TgZ(145,"code"),e._uU(146,"UsersService"),e.qZA(),e._uU(147," simply maintains a hard-coded in-memory list of users, and a find method to retrieve one by username. In a real app, this is where you'd build your user model and persistence layer, using your library of choice (e.g., TypeORM, Sequelize, Mongoose, etc.)."),e.qZA(),e.TgZ(148,"span",16),e._uU(149),e.ALo(150,"extension"),e._UZ(151,"app-tabs",null,17),e.qZA(),e.TgZ(153,"pre")(154,"code",18),e._uU(155,"\nimport { Injectable } from '@nestjs/common';\n\n// This should be a real class/interface representing a user entity\nexport type User = any;\n\n@Injectable()\nexport class UsersService {\n  private readonly users = [\n    {\n      userId: 1,\n      username: 'john',\n      password: 'changeme',\n    },\n    {\n      userId: 2,\n      username: 'maria',\n      password: 'guess',\n    },\n  ];\n\n  async findOne(username: string): Promise<User | undefined> {\n    return this.users.find(user => user.username === username);\n  }\n}\n"),e.qZA()(),e.TgZ(156,"pre")(157,"code",18),e._uU(158,"\nimport { Injectable } from '@nestjs/common';\n\n@Injectable()\nexport class UsersService {\n  constructor() {\n    this.users = [\n      {\n        userId: 1,\n        username: 'john',\n        password: 'changeme',\n      },\n      {\n        userId: 2,\n        username: 'maria',\n        password: 'guess',\n      },\n    ];\n  }\n\n  async findOne(username) {\n    return this.users.find(user => user.username === username);\n  }\n}\n"),e.qZA()(),e.TgZ(159,"p"),e._uU(160,"In the "),e.TgZ(161,"code"),e._uU(162,"UsersModule"),e.qZA(),e._uU(163,", the only change needed is to add the "),e.TgZ(164,"code"),e._uU(165,"UsersService"),e.qZA(),e._uU(166," to the exports array of the "),e.TgZ(167,"code"),e._uU(168,"@Module"),e.qZA(),e._uU(169," decorator so that it is visible outside this module (we'll soon use it in our "),e.TgZ(170,"code"),e._uU(171,"AuthService"),e.qZA(),e._uU(172,")."),e.qZA(),e.TgZ(173,"span",16),e._uU(174),e.ALo(175,"extension"),e._UZ(176,"app-tabs",null,19),e.qZA(),e.TgZ(178,"pre")(179,"code",18),e._uU(180,"\nimport { Module } from '@nestjs/common';\nimport { UsersService } from './users.service';\n\n@Module({\n  providers: [UsersService],\n  exports: [UsersService],\n})\nexport class UsersModule {}\n"),e.qZA()(),e.TgZ(181,"pre")(182,"code",18),e._uU(183,"\nimport { Module } from '@nestjs/common';\nimport { UsersService } from './users.service';\n\n@Module({\n  providers: [UsersService],\n  exports: [UsersService],\n})\nexport class UsersModule {}\n"),e.qZA()(),e.TgZ(184,"p"),e._uU(185,"Our "),e.TgZ(186,"code"),e._uU(187,"AuthService"),e.qZA(),e._uU(188," has the job of retrieving a user and verifying the password. We create a "),e.TgZ(189,"code"),e._uU(190,"validateUser()"),e.qZA(),e._uU(191," method for this purpose. In the code below, we use a convenient ES6 spread operator to strip the password property from the user object before returning it. We'll be calling into the "),e.TgZ(192,"code"),e._uU(193,"validateUser()"),e.qZA(),e._uU(194," method from our Passport local strategy in a moment."),e.qZA(),e.TgZ(195,"span",16),e._uU(196),e.ALo(197,"extension"),e._UZ(198,"app-tabs",null,20),e.qZA(),e.TgZ(200,"pre")(201,"code",18),e._uU(202,"\nimport { Injectable } from '@nestjs/common';\nimport { UsersService } from '../users/users.service';\n\n@Injectable()\nexport class AuthService {\n  constructor(private usersService: UsersService) {}\n\n  async validateUser(username: string, pass: string): Promise<any> {\n    const user = await this.usersService.findOne(username);\n    if (user && user.password === pass) {\n      const { password, ...result } = user;\n      return result;\n    }\n    return null;\n  }\n}\n"),e.qZA()(),e.TgZ(203,"pre")(204,"code",18),e._uU(205,"\nimport { Injectable, Dependencies } from '@nestjs/common';\nimport { UsersService } from '../users/users.service';\n\n@Injectable()\n@Dependencies(UsersService)\nexport class AuthService {\n  constructor(usersService) {\n    this.usersService = usersService;\n  }\n\n  async validateUser(username, pass) {\n    const user = await this.usersService.findOne(username);\n    if (user && user.password === pass) {\n      const { password, ...result } = user;\n      return result;\n    }\n    return null;\n  }\n}\n"),e.qZA()(),e.TgZ(206,"blockquote",21)(207,"strong"),e._uU(208,"Warning"),e.qZA(),e._uU(209," Of course in a real application, you wouldn't store a password in plain text. You'd instead use a library like "),e.TgZ(210,"a",22),e._uU(211,"bcrypt"),e.qZA(),e._uU(212,", with a salted one-way hash algorithm. With that approach, you'd only store hashed passwords, and then compare the stored password to a hashed version of the "),e.TgZ(213,"strong"),e._uU(214,"incoming"),e.qZA(),e._uU(215," password, thus never storing or exposing user passwords in plain text. To keep our sample app simple, we violate that absolute mandate and use plain text. "),e.TgZ(216,"strong"),e._uU(217,"Don't do this in your real app!"),e.qZA()(),e.TgZ(218,"p"),e._uU(219,"Now, we update our "),e.TgZ(220,"code"),e._uU(221,"AuthModule"),e.qZA(),e._uU(222," to import the "),e.TgZ(223,"code"),e._uU(224,"UsersModule"),e.qZA(),e._uU(225,"."),e.qZA(),e.TgZ(226,"span",16),e._uU(227),e.ALo(228,"extension"),e._UZ(229,"app-tabs",null,23),e.qZA(),e.TgZ(231,"pre")(232,"code",18),e._uU(233,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { UsersModule } from '../users/users.module';\n\n@Module({\n  imports: [UsersModule],\n  providers: [AuthService],\n})\nexport class AuthModule {}\n"),e.qZA()(),e.TgZ(234,"pre")(235,"code",18),e._uU(236,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { UsersModule } from '../users/users.module';\n\n@Module({\n  imports: [UsersModule],\n  providers: [AuthService],\n})\nexport class AuthModule {}\n"),e.qZA()(),e.TgZ(237,"h4",24)(238,"span"),e._uU(239,"Implementing Passport local"),e.qZA()(),e.TgZ(240,"p"),e._uU(241,"Now we can implement our Passport "),e.TgZ(242,"strong"),e._uU(243,"local authentication strategy"),e.qZA(),e._uU(244,". Create a file called "),e.TgZ(245,"code"),e._uU(246,"local.strategy.ts"),e.qZA(),e._uU(247," in the "),e.TgZ(248,"code"),e._uU(249,"auth"),e.qZA(),e._uU(250," folder, and add the following code:"),e.qZA(),e.TgZ(251,"span",16),e._uU(252),e.ALo(253,"extension"),e._UZ(254,"app-tabs",null,25),e.qZA(),e.TgZ(256,"pre")(257,"code",18),e._uU(258,"\nimport { Strategy } from 'passport-local';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { AuthService } from './auth.service';\n\n@Injectable()\nexport class LocalStrategy extends PassportStrategy(Strategy) {\n  constructor(private authService: AuthService) {\n    super();\n  }\n\n  async validate(username: string, password: string): Promise<any> {\n    const user = await this.authService.validateUser(username, password);\n    if (!user) {\n      throw new UnauthorizedException();\n    }\n    return user;\n  }\n}\n"),e.qZA()(),e.TgZ(259,"pre")(260,"code",18),e._uU(261,"\nimport { Strategy } from 'passport-local';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { Injectable, UnauthorizedException, Dependencies } from '@nestjs/common';\nimport { AuthService } from './auth.service';\n\n@Injectable()\n@Dependencies(AuthService)\nexport class LocalStrategy extends PassportStrategy(Strategy) {\n  constructor(authService) {\n    super();\n    this.authService = authService;\n  }\n\n  async validate(username, password) {\n    const user = await this.authService.validateUser(username, password);\n    if (!user) {\n      throw new UnauthorizedException();\n    }\n    return user;\n  }\n}\n"),e.qZA()(),e.TgZ(262,"p"),e._uU(263,"We've followed the recipe described earlier for all Passport strategies. In our use case with passport-local, there are no configuration options, so our constructor simply calls "),e.TgZ(264,"code"),e._uU(265,"super()"),e.qZA(),e._uU(266,", without an options object."),e.qZA(),e.TgZ(267,"blockquote",26)(268,"strong"),e._uU(269,"Hint"),e.qZA(),e._uU(270," We can pass an options object in the call to "),e.TgZ(271,"code"),e._uU(272,"super()"),e.qZA(),e._uU(273," to customize the behavior of the passport strategy. In this example, the passport-local strategy by default expects properties called "),e.TgZ(274,"code"),e._uU(275,"username"),e.qZA(),e._uU(276," and "),e.TgZ(277,"code"),e._uU(278,"password"),e.qZA(),e._uU(279," in the request body. Pass an options object to specify different property names, for example: "),e.TgZ(280,"code"),e._uU(281),e.qZA(),e._uU(282,". See the "),e.TgZ(283,"a",27),e._uU(284,"Passport documentation"),e.qZA(),e._uU(285," for more information.\n"),e.qZA(),e.TgZ(286,"p"),e._uU(287,"We've also implemented the "),e.TgZ(288,"code"),e._uU(289,"validate()"),e.qZA(),e._uU(290," method. For each strategy, Passport will call the verify function (implemented with the "),e.TgZ(291,"code"),e._uU(292,"validate()"),e.qZA(),e._uU(293," method in "),e.TgZ(294,"code"),e._uU(295,"@nestjs/passport"),e.qZA(),e._uU(296,") using an appropriate strategy-specific set of parameters. For the local-strategy, Passport expects a "),e.TgZ(297,"code"),e._uU(298,"validate()"),e.qZA(),e._uU(299," method with the following signature: "),e.TgZ(300,"code"),e._uU(301,"validate(username: string, password:string): any"),e.qZA(),e._uU(302,"."),e.qZA(),e.TgZ(303,"p"),e._uU(304,"Most of the validation work is done in our "),e.TgZ(305,"code"),e._uU(306,"AuthService"),e.qZA(),e._uU(307," (with the help of our "),e.TgZ(308,"code"),e._uU(309,"UsersService"),e.qZA(),e._uU(310,"), so this method is quite straightforward. The "),e.TgZ(311,"code"),e._uU(312,"validate()"),e.qZA(),e._uU(313," method for "),e.TgZ(314,"strong"),e._uU(315,"any"),e.qZA(),e._uU(316," Passport strategy will follow a similar pattern, varying only in the details of how credentials are represented. If a user is found and the credentials are valid, the user is returned so Passport can complete its tasks (e.g., creating the "),e.TgZ(317,"code"),e._uU(318,"user"),e.qZA(),e._uU(319," property on the "),e.TgZ(320,"code"),e._uU(321,"Request"),e.qZA(),e._uU(322," object), and the request handling pipeline can continue. If it's not found, we throw an exception and let our "),e.TgZ(323,"a",28),e._uU(324,"exceptions layer"),e.qZA(),e._uU(325," handle it."),e.qZA(),e.TgZ(326,"p"),e._uU(327,"Typically, the only significant difference in the "),e.TgZ(328,"code"),e._uU(329,"validate()"),e.qZA(),e._uU(330," method for each strategy is "),e.TgZ(331,"strong"),e._uU(332,"how"),e.qZA(),e._uU(333," you determine if a user exists and is valid. For example, in a JWT strategy, depending on requirements, we may evaluate whether the "),e.TgZ(334,"code"),e._uU(335,"userId"),e.qZA(),e._uU(336," carried in the decoded token matches a record in our user database, or matches a list of revoked tokens. Hence, this pattern of sub-classing and implementing strategy-specific validation is consistent, elegant and extensible."),e.qZA(),e.TgZ(337,"p"),e._uU(338,"We need to configure our "),e.TgZ(339,"code"),e._uU(340,"AuthModule"),e.qZA(),e._uU(341," to use the Passport features we just defined. Update "),e.TgZ(342,"code"),e._uU(343,"auth.module.ts"),e.qZA(),e._uU(344," to look like this:"),e.qZA(),e.TgZ(345,"span",16),e._uU(346),e.ALo(347,"extension"),e._UZ(348,"app-tabs",null,29),e.qZA(),e.TgZ(350,"pre")(351,"code",18),e._uU(352,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { UsersModule } from '../users/users.module';\nimport { PassportModule } from '@nestjs/passport';\nimport { LocalStrategy } from './local.strategy';\n\n@Module({\n  imports: [UsersModule, PassportModule],\n  providers: [AuthService, LocalStrategy],\n})\nexport class AuthModule {}\n"),e.qZA()(),e.TgZ(353,"pre")(354,"code",18),e._uU(355,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { UsersModule } from '../users/users.module';\nimport { PassportModule } from '@nestjs/passport';\nimport { LocalStrategy } from './local.strategy';\n\n@Module({\n  imports: [UsersModule, PassportModule],\n  providers: [AuthService, LocalStrategy],\n})\nexport class AuthModule {}\n"),e.qZA()(),e.TgZ(356,"h4",30)(357,"span"),e._uU(358,"Built-in Passport Guards"),e.qZA()(),e.TgZ(359,"p"),e._uU(360,"The "),e.TgZ(361,"a",31),e._uU(362,"Guards"),e.qZA(),e._uU(363," chapter describes the primary function of Guards: to determine whether a request will be handled by the route handler or not. That remains true, and we'll use that standard capability soon. However, in the context of using the "),e.TgZ(364,"code"),e._uU(365,"@nestjs/passport"),e.qZA(),e._uU(366," module, we will also introduce a slight new wrinkle that may at first be confusing, so let's discuss that now. Consider that your app can exist in two states, from an authentication perspective:"),e.qZA(),e.TgZ(367,"ol")(368,"li"),e._uU(369,"the user/client is "),e.TgZ(370,"strong"),e._uU(371,"not"),e.qZA(),e._uU(372," logged in (is not authenticated)"),e.qZA(),e.TgZ(373,"li"),e._uU(374,"the user/client "),e.TgZ(375,"strong"),e._uU(376,"is"),e.qZA(),e._uU(377," logged in (is authenticated)"),e.qZA()(),e.TgZ(378,"p"),e._uU(379,"In the first case (user is not logged in), we need to perform two distinct functions:"),e.qZA(),e.TgZ(380,"ul")(381,"li")(382,"p"),e._uU(383,"Restrict the routes an unauthenticated user can access (i.e., deny access to restricted routes). We'll use Guards in their familiar capacity to handle this function, by placing a Guard on the protected routes. As you may anticipate, we'll be checking for the presence of a valid JWT in this Guard, so we'll work on this Guard later, once we are successfully issuing JWTs."),e.qZA()(),e.TgZ(384,"li")(385,"p"),e._uU(386,"Initiate the "),e.TgZ(387,"strong"),e._uU(388,"authentication step"),e.qZA(),e._uU(389," itself when a previously unauthenticated user attempts to login. This is the step where we'll "),e.TgZ(390,"strong"),e._uU(391,"issue"),e.qZA(),e._uU(392," a JWT to a valid user. Thinking about this for a moment, we know we'll need to "),e.TgZ(393,"code"),e._uU(394,"POST"),e.qZA(),e._uU(395," username/password credentials to initiate authentication, so we'll set up a "),e.TgZ(396,"code"),e._uU(397,"POST /auth/login"),e.qZA(),e._uU(398," route to handle that. This raises the question: how exactly do we invoke the passport-local strategy in that route?"),e.qZA()()(),e.TgZ(399,"p"),e._uU(400,"The answer is straightforward: by using another, slightly different type of Guard. The "),e.TgZ(401,"code"),e._uU(402,"@nestjs/passport"),e.qZA(),e._uU(403," module provides us with a built-in Guard that does this for us. This Guard invokes the Passport strategy and kicks off the steps described above (retrieving credentials, running the verify function, creating the "),e.TgZ(404,"code"),e._uU(405,"user"),e.qZA(),e._uU(406," property, etc)."),e.qZA(),e.TgZ(407,"p"),e._uU(408,"The second case enumerated above (logged in user) simply relies on the standard type of Guard we already discussed to enable access to protected routes for logged in users."),e.qZA(),e.TgZ(409,"p"),e._UZ(410,"app-banner-courses-auth"),e.qZA(),e.TgZ(411,"h4",32)(412,"span"),e._uU(413,"Login route"),e.qZA()(),e.TgZ(414,"p"),e._uU(415,"With the strategy in place, we can now implement a bare-bones "),e.TgZ(416,"code"),e._uU(417,"/auth/login"),e.qZA(),e._uU(418," route, and apply the built-in Guard to initiate the passport-local flow."),e.qZA(),e.TgZ(419,"p"),e._uU(420,"Open the "),e.TgZ(421,"code"),e._uU(422,"app.controller.ts"),e.qZA(),e._uU(423," file and replace its contents with the following:"),e.qZA(),e.TgZ(424,"span",16),e._uU(425),e.ALo(426,"extension"),e._UZ(427,"app-tabs",null,33),e.qZA(),e.TgZ(429,"pre")(430,"code",18),e._uU(431,"\nimport { Controller, Request, Post, UseGuards } from '@nestjs/common';\nimport { AuthGuard } from '@nestjs/passport';\n\n@Controller()\nexport class AppController {\n  @UseGuards(AuthGuard('local'))\n  @Post('auth/login')\n  async login(@Request() req) {\n    return req.user;\n  }\n}\n"),e.qZA()(),e.TgZ(432,"pre")(433,"code",18),e._uU(434,"\nimport { Controller, Bind, Request, Post, UseGuards } from '@nestjs/common';\nimport { AuthGuard } from '@nestjs/passport';\n\n@Controller()\nexport class AppController {\n  @UseGuards(AuthGuard('local'))\n  @Post('auth/login')\n  @Bind(Request())\n  async login(req) {\n    return req.user;\n  }\n}\n"),e.qZA()(),e.TgZ(435,"p"),e._uU(436,"With "),e.TgZ(437,"code"),e._uU(438,"@UseGuards(AuthGuard('local'))"),e.qZA(),e._uU(439," we are using an "),e.TgZ(440,"code"),e._uU(441,"AuthGuard"),e.qZA(),e._uU(442," that "),e.TgZ(443,"code"),e._uU(444,"@nestjs/passport"),e.qZA(),e.TgZ(445,"strong"),e._uU(446,"automatically provisioned"),e.qZA(),e._uU(447," for us when we extended the passport-local strategy. Let's break that down. Our Passport local strategy has a default name of "),e.TgZ(448,"code"),e._uU(449,"'local'"),e.qZA(),e._uU(450,". We reference that name in the "),e.TgZ(451,"code"),e._uU(452,"@UseGuards()"),e.qZA(),e._uU(453," decorator to associate it with code supplied by the "),e.TgZ(454,"code"),e._uU(455,"passport-local"),e.qZA(),e._uU(456," package. This is used to disambiguate which strategy to invoke in case we have multiple Passport strategies in our app (each of which may provision a strategy-specific "),e.TgZ(457,"code"),e._uU(458,"AuthGuard"),e.qZA(),e._uU(459,"). While we only have one such strategy so far, we'll shortly add a second, so this is needed for disambiguation."),e.qZA(),e.TgZ(460,"p"),e._uU(461,"In order to test our route we'll have our "),e.TgZ(462,"code"),e._uU(463,"/auth/login"),e.qZA(),e._uU(464," route simply return the user for now. This also lets us demonstrate another Passport feature: Passport automatically creates a "),e.TgZ(465,"code"),e._uU(466,"user"),e.qZA(),e._uU(467," object, based on the value we return from the "),e.TgZ(468,"code"),e._uU(469,"validate()"),e.qZA(),e._uU(470," method, and assigns it to the "),e.TgZ(471,"code"),e._uU(472,"Request"),e.qZA(),e._uU(473," object as "),e.TgZ(474,"code"),e._uU(475,"req.user"),e.qZA(),e._uU(476,". Later, we'll replace this with code to create and return a JWT instead."),e.qZA(),e.TgZ(477,"p"),e._uU(478,"Since these are API routes, we'll test them using the commonly available "),e.TgZ(479,"a",34),e._uU(480,"cURL"),e.qZA(),e._uU(481," library. You can test with any of the "),e.TgZ(482,"code"),e._uU(483,"user"),e.qZA(),e._uU(484," objects hard-coded in the "),e.TgZ(485,"code"),e._uU(486,"UsersService"),e.qZA(),e._uU(487,"."),e.qZA(),e.TgZ(488,"pre")(489,"code",13),e._uU(490,'\n$ # POST to /auth/login\n$ curl -X POST http://localhost:3000/auth/login -d \'{"username": "john", "password": "changeme"}\' -H "Content-Type: application/json"\n$ # result -> {"userId":1,"username":"john"}\n'),e.qZA()(),e.TgZ(491,"p"),e._uU(492,"While this works, passing the strategy name directly to the "),e.TgZ(493,"code"),e._uU(494,"AuthGuard()"),e.qZA(),e._uU(495," introduces magic strings in the codebase. Instead, we recommend creating your own class, as shown below:"),e.qZA(),e.TgZ(496,"span",16),e._uU(497),e.ALo(498,"extension"),e._UZ(499,"app-tabs",null,35),e.qZA(),e.TgZ(501,"pre")(502,"code",18),e._uU(503,"\nimport { Injectable } from '@nestjs/common';\nimport { AuthGuard } from '@nestjs/passport';\n\n@Injectable()\nexport class LocalAuthGuard extends AuthGuard('local') {}\n"),e.qZA()(),e.TgZ(504,"p"),e._uU(505,"Now, we can update the "),e.TgZ(506,"code"),e._uU(507,"/auth/login"),e.qZA(),e._uU(508," route handler and use the "),e.TgZ(509,"code"),e._uU(510,"LocalAuthGuard"),e.qZA(),e._uU(511," instead:"),e.qZA(),e.TgZ(512,"pre")(513,"code",18),e._uU(514,"\n@UseGuards(LocalAuthGuard)\n@Post('auth/login')\nasync login(@Request() req) {\n  return req.user;\n}\n"),e.qZA()(),e.TgZ(515,"h4",36)(516,"span"),e._uU(517,"JWT functionality"),e.qZA()(),e.TgZ(518,"p"),e._uU(519,"We're ready to move on to the JWT portion of our auth system. Let's review and refine our requirements:"),e.qZA(),e.TgZ(520,"ul")(521,"li"),e._uU(522,"Allow users to authenticate with username/password, returning a JWT for use in subsequent calls to protected API endpoints. We're well on our way to meeting this requirement. To complete it, we'll need to write the code that issues a JWT."),e.qZA(),e.TgZ(523,"li"),e._uU(524,"Create API routes which are protected based on the presence of a valid JWT as a bearer token"),e.qZA()(),e.TgZ(525,"p"),e._uU(526,"We'll need to install a couple more packages to support our JWT requirements:"),e.qZA(),e.TgZ(527,"pre")(528,"code",13),e._uU(529,"\n$ npm install --save @nestjs/jwt passport-jwt\n$ npm install --save-dev @types/passport-jwt\n"),e.qZA()(),e.TgZ(530,"p"),e._uU(531,"The "),e.TgZ(532,"code"),e._uU(533,"@nestjs/jwt"),e.qZA(),e._uU(534," package (see more "),e.TgZ(535,"a",37),e._uU(536,"here"),e.qZA(),e._uU(537,") is a utility package that helps with JWT manipulation. The "),e.TgZ(538,"code"),e._uU(539,"passport-jwt"),e.qZA(),e._uU(540," package is the Passport package that implements the JWT strategy and "),e.TgZ(541,"code"),e._uU(542,"@types/passport-jwt"),e.qZA(),e._uU(543," provides the TypeScript type definitions."),e.qZA(),e.TgZ(544,"p"),e._uU(545,"Let's take a closer look at how a "),e.TgZ(546,"code"),e._uU(547,"POST /auth/login"),e.qZA(),e._uU(548," request is handled. We've decorated the route using the built-in "),e.TgZ(549,"code"),e._uU(550,"AuthGuard"),e.qZA(),e._uU(551," provided by the passport-local strategy. This means that:"),e.qZA(),e.TgZ(552,"ol")(553,"li"),e._uU(554,"The route handler "),e.TgZ(555,"strong"),e._uU(556,"will only be invoked if the user has been validated"),e.qZA()(),e.TgZ(557,"li"),e._uU(558,"The "),e.TgZ(559,"code"),e._uU(560,"req"),e.qZA(),e._uU(561," parameter will contain a "),e.TgZ(562,"code"),e._uU(563,"user"),e.qZA(),e._uU(564," property (populated by Passport during the passport-local authentication flow)"),e.qZA()(),e.TgZ(565,"p"),e._uU(566,"With this in mind, we can now finally generate a real JWT, and return it in this route. To keep our services cleanly modularized, we'll handle generating the JWT in the "),e.TgZ(567,"code"),e._uU(568,"authService"),e.qZA(),e._uU(569,". Open the "),e.TgZ(570,"code"),e._uU(571,"auth.service.ts"),e.qZA(),e._uU(572," file in the "),e.TgZ(573,"code"),e._uU(574,"auth"),e.qZA(),e._uU(575," folder, and add the "),e.TgZ(576,"code"),e._uU(577,"login()"),e.qZA(),e._uU(578," method, and import the "),e.TgZ(579,"code"),e._uU(580,"JwtService"),e.qZA(),e._uU(581," as shown:"),e.qZA(),e.TgZ(582,"span",16),e._uU(583),e.ALo(584,"extension"),e._UZ(585,"app-tabs",null,38),e.qZA(),e.TgZ(587,"pre")(588,"code",18),e._uU(589,"\nimport { Injectable } from '@nestjs/common';\nimport { UsersService } from '../users/users.service';\nimport { JwtService } from '@nestjs/jwt';\n\n@Injectable()\nexport class AuthService {\n  constructor(\n    private usersService: UsersService,\n    private jwtService: JwtService\n  ) {}\n\n  async validateUser(username: string, pass: string): Promise<any> {\n    const user = await this.usersService.findOne(username);\n    if (user && user.password === pass) {\n      const { password, ...result } = user;\n      return result;\n    }\n    return null;\n  }\n\n  async login(user: any) {\n    const payload = { username: user.username, sub: user.userId };\n    return {\n      access_token: this.jwtService.sign(payload),\n    };\n  }\n}\n"),e.qZA()(),e.TgZ(590,"pre")(591,"code",18),e._uU(592,"\nimport { Injectable, Dependencies } from '@nestjs/common';\nimport { UsersService } from '../users/users.service';\nimport { JwtService } from '@nestjs/jwt';\n\n@Dependencies(UsersService, JwtService)\n@Injectable()\nexport class AuthService {\n  constructor(usersService, jwtService) {\n    this.usersService = usersService;\n    this.jwtService = jwtService;\n  }\n\n  async validateUser(username, pass) {\n    const user = await this.usersService.findOne(username);\n    if (user && user.password === pass) {\n      const { password, ...result } = user;\n      return result;\n    }\n    return null;\n  }\n\n  async login(user) {\n    const payload = { username: user.username, sub: user.userId };\n    return {\n      access_token: this.jwtService.sign(payload),\n    };\n  }\n}\n"),e.qZA()(),e.TgZ(593,"p"),e._uU(594,"We're using the "),e.TgZ(595,"code"),e._uU(596,"@nestjs/jwt"),e.qZA(),e._uU(597," library, which supplies a "),e.TgZ(598,"code"),e._uU(599,"sign()"),e.qZA(),e._uU(600," function to generate our JWT from a subset of the "),e.TgZ(601,"code"),e._uU(602,"user"),e.qZA(),e._uU(603," object properties, which we then return as a simple object with a single "),e.TgZ(604,"code"),e._uU(605,"access_token"),e.qZA(),e._uU(606," property. Note: we choose a property name of "),e.TgZ(607,"code"),e._uU(608,"sub"),e.qZA(),e._uU(609," to hold our "),e.TgZ(610,"code"),e._uU(611,"userId"),e.qZA(),e._uU(612," value to be consistent with JWT standards. Don't forget to inject the JwtService provider into the "),e.TgZ(613,"code"),e._uU(614,"AuthService"),e.qZA(),e._uU(615,"."),e.qZA(),e.TgZ(616,"p"),e._uU(617,"We now need to update the "),e.TgZ(618,"code"),e._uU(619,"AuthModule"),e.qZA(),e._uU(620," to import the new dependencies and configure the "),e.TgZ(621,"code"),e._uU(622,"JwtModule"),e.qZA(),e._uU(623,"."),e.qZA(),e.TgZ(624,"p"),e._uU(625,"First, create "),e.TgZ(626,"code"),e._uU(627,"constants.ts"),e.qZA(),e._uU(628," in the "),e.TgZ(629,"code"),e._uU(630,"auth"),e.qZA(),e._uU(631," folder, and add the following code:"),e.qZA(),e.TgZ(632,"span",16),e._uU(633),e.ALo(634,"extension"),e._UZ(635,"app-tabs",null,39),e.qZA(),e.TgZ(637,"pre")(638,"code",18),e._uU(639,"\nexport const jwtConstants = {\n  secret: 'DO NOT USE THIS VALUE. INSTEAD, CREATE A COMPLEX SECRET AND KEEP IT SAFE OUTSIDE OF THE SOURCE CODE.',\n};\n"),e.qZA()(),e.TgZ(640,"pre")(641,"code",18),e._uU(642,"\nexport const jwtConstants = {\n  secret: 'DO NOT USE THIS VALUE. INSTEAD, CREATE A COMPLEX SECRET AND KEEP IT SAFE OUTSIDE OF THE SOURCE CODE.',\n};\n"),e.qZA()(),e.TgZ(643,"p"),e._uU(644,"We'll use this to share our key between the JWT signing and verifying steps."),e.qZA(),e.TgZ(645,"blockquote",21)(646,"strong"),e._uU(647,"Warning"),e.qZA(),e.TgZ(648,"strong"),e._uU(649,"Do not expose this key publicly"),e.qZA(),e._uU(650,". We have done so here to make it clear what the code is doing, but in a production system "),e.TgZ(651,"strong"),e._uU(652,"you must protect this key"),e.qZA(),e._uU(653," using appropriate measures such as a secrets vault, environment variable, or configuration service.\n"),e.qZA(),e.TgZ(654,"p"),e._uU(655,"Now, open "),e.TgZ(656,"code"),e._uU(657,"auth.module.ts"),e.qZA(),e._uU(658," in the "),e.TgZ(659,"code"),e._uU(660,"auth"),e.qZA(),e._uU(661," folder and update it to look like this:"),e.qZA(),e.TgZ(662,"span",16),e._uU(663),e.ALo(664,"extension"),e._UZ(665,"app-tabs",null,40),e.qZA(),e.TgZ(667,"pre")(668,"code",18),e._uU(669,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { LocalStrategy } from './local.strategy';\nimport { UsersModule } from '../users/users.module';\nimport { PassportModule } from '@nestjs/passport';\nimport { JwtModule } from '@nestjs/jwt';\nimport { jwtConstants } from './constants';\n\n@Module({\n  imports: [\n    UsersModule,\n    PassportModule,\n    JwtModule.register({\n      secret: jwtConstants.secret,\n      signOptions: { expiresIn: '60s' },\n    }),\n  ],\n  providers: [AuthService, LocalStrategy],\n  exports: [AuthService],\n})\nexport class AuthModule {}\n"),e.qZA()(),e.TgZ(670,"pre")(671,"code",18),e._uU(672,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { LocalStrategy } from './local.strategy';\nimport { UsersModule } from '../users/users.module';\nimport { PassportModule } from '@nestjs/passport';\nimport { JwtModule } from '@nestjs/jwt';\nimport { jwtConstants } from './constants';\n\n@Module({\n  imports: [\n    UsersModule,\n    PassportModule,\n    JwtModule.register({\n      secret: jwtConstants.secret,\n      signOptions: { expiresIn: '60s' },\n    }),\n  ],\n  providers: [AuthService, LocalStrategy],\n  exports: [AuthService],\n})\nexport class AuthModule {}\n"),e.qZA()(),e.TgZ(673,"p"),e._uU(674,"We configure the "),e.TgZ(675,"code"),e._uU(676,"JwtModule"),e.qZA(),e._uU(677," using "),e.TgZ(678,"code"),e._uU(679,"register()"),e.qZA(),e._uU(680,", passing in a configuration object. See "),e.TgZ(681,"a",41),e._uU(682,"here"),e.qZA(),e._uU(683," for more on the Nest "),e.TgZ(684,"code"),e._uU(685,"JwtModule"),e.qZA(),e._uU(686," and "),e.TgZ(687,"a",42),e._uU(688,"here"),e.qZA(),e._uU(689," for more details on the available configuration options."),e.qZA(),e.TgZ(690,"p"),e._uU(691,"Now we can update the "),e.TgZ(692,"code"),e._uU(693,"/auth/login"),e.qZA(),e._uU(694," route to return a JWT."),e.qZA(),e.TgZ(695,"span",16),e._uU(696),e.ALo(697,"extension"),e._UZ(698,"app-tabs",null,43),e.qZA(),e.TgZ(700,"pre")(701,"code",18),e._uU(702,"\nimport { Controller, Request, Post, UseGuards } from '@nestjs/common';\nimport { LocalAuthGuard } from './auth/local-auth.guard';\nimport { AuthService } from './auth/auth.service';\n\n@Controller()\nexport class AppController {\n  constructor(private authService: AuthService) {}\n\n  @UseGuards(LocalAuthGuard)\n  @Post('auth/login')\n  async login(@Request() req) {\n    return this.authService.login(req.user);\n  }\n}\n"),e.qZA()(),e.TgZ(703,"pre")(704,"code",18),e._uU(705,"\nimport { Controller, Bind, Request, Post, UseGuards } from '@nestjs/common';\nimport { LocalAuthGuard } from './auth/local-auth.guard';\nimport { AuthService } from './auth/auth.service';\n\n@Controller()\nexport class AppController {\n  constructor(private authService: AuthService) {}\n\n  @UseGuards(LocalAuthGuard)\n  @Post('auth/login')\n  @Bind(Request())\n  async login(req) {\n    return this.authService.login(req.user);\n  }\n}\n"),e.qZA()(),e.TgZ(706,"p"),e._uU(707,"Let's go ahead and test our routes using cURL again. You can test with any of the "),e.TgZ(708,"code"),e._uU(709,"user"),e.qZA(),e._uU(710," objects hard-coded in the "),e.TgZ(711,"code"),e._uU(712,"UsersService"),e.qZA(),e._uU(713,"."),e.qZA(),e.TgZ(714,"pre")(715,"code",13),e._uU(716,'\n$ # POST to /auth/login\n$ curl -X POST http://localhost:3000/auth/login -d \'{"username": "john", "password": "changeme"}\' -H "Content-Type: application/json"\n$ # result -> {"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."}\n$ # Note: above JWT truncated\n'),e.qZA()(),e.TgZ(717,"h4",44)(718,"span"),e._uU(719,"Implementing Passport JWT"),e.qZA()(),e.TgZ(720,"p"),e._uU(721,"We can now address our final requirement: protecting endpoints by requiring a valid JWT be present on the request. Passport can help us here too. It provides the "),e.TgZ(722,"a",45),e._uU(723,"passport-jwt"),e.qZA(),e._uU(724," strategy for securing RESTful endpoints with JSON Web Tokens. Start by creating a file called "),e.TgZ(725,"code"),e._uU(726,"jwt.strategy.ts"),e.qZA(),e._uU(727," in the "),e.TgZ(728,"code"),e._uU(729,"auth"),e.qZA(),e._uU(730," folder, and add the following code:"),e.qZA(),e.TgZ(731,"span",16),e._uU(732),e.ALo(733,"extension"),e._UZ(734,"app-tabs",null,46),e.qZA(),e.TgZ(736,"pre")(737,"code",18),e._uU(738,"\nimport { ExtractJwt, Strategy } from 'passport-jwt';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { Injectable } from '@nestjs/common';\nimport { jwtConstants } from './constants';\n\n@Injectable()\nexport class JwtStrategy extends PassportStrategy(Strategy) {\n  constructor() {\n    super({\n      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\n      ignoreExpiration: false,\n      secretOrKey: jwtConstants.secret,\n    });\n  }\n\n  async validate(payload: any) {\n    return { userId: payload.sub, username: payload.username };\n  }\n}\n"),e.qZA()(),e.TgZ(739,"pre")(740,"code",18),e._uU(741,"\nimport { ExtractJwt, Strategy } from 'passport-jwt';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { Injectable } from '@nestjs/common';\nimport { jwtConstants } from './constants';\n\n@Injectable()\nexport class JwtStrategy extends PassportStrategy(Strategy) {\n  constructor() {\n    super({\n      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\n      ignoreExpiration: false,\n      secretOrKey: jwtConstants.secret,\n    });\n  }\n\n  async validate(payload) {\n    return { userId: payload.sub, username: payload.username };\n  }\n}\n"),e.qZA()(),e.TgZ(742,"p"),e._uU(743,"With our "),e.TgZ(744,"code"),e._uU(745,"JwtStrategy"),e.qZA(),e._uU(746,", we've followed the same recipe described earlier for all Passport strategies. This strategy requires some initialization, so we do that by passing in an options object in the "),e.TgZ(747,"code"),e._uU(748,"super()"),e.qZA(),e._uU(749," call. You can read more about the available options "),e.TgZ(750,"a",47),e._uU(751,"here"),e.qZA(),e._uU(752,". In our case, these options are:"),e.qZA(),e.TgZ(753,"ul")(754,"li")(755,"code"),e._uU(756,"jwtFromRequest"),e.qZA(),e._uU(757,": supplies the method by which the JWT will be extracted from the "),e.TgZ(758,"code"),e._uU(759,"Request"),e.qZA(),e._uU(760,". We will use the standard approach of supplying a bearer token in the Authorization header of our API requests. Other options are described "),e.TgZ(761,"a",48),e._uU(762,"here"),e.qZA(),e._uU(763,"."),e.qZA(),e.TgZ(764,"li")(765,"code"),e._uU(766,"ignoreExpiration"),e.qZA(),e._uU(767,": just to be explicit, we choose the default "),e.TgZ(768,"code"),e._uU(769,"false"),e.qZA(),e._uU(770," setting, which delegates the responsibility of ensuring that a JWT has not expired to the Passport module. This means that if our route is supplied with an expired JWT, the request will be denied and a "),e.TgZ(771,"code"),e._uU(772,"401 Unauthorized"),e.qZA(),e._uU(773," response sent. Passport conveniently handles this automatically for us."),e.qZA(),e.TgZ(774,"li")(775,"code"),e._uU(776,"secretOrKey"),e.qZA(),e._uU(777,": we are using the expedient option of supplying a symmetric secret for signing the token. Other options, such as a PEM-encoded public key, may be more appropriate for production apps (see "),e.TgZ(778,"a",47),e._uU(779,"here"),e.qZA(),e._uU(780," for more information). In any case, as cautioned earlier, "),e.TgZ(781,"strong"),e._uU(782,"do not expose this secret publicly"),e.qZA(),e._uU(783,"."),e.qZA()(),e.TgZ(784,"p"),e._uU(785,"The "),e.TgZ(786,"code"),e._uU(787,"validate()"),e.qZA(),e._uU(788," method deserves some discussion. For the jwt-strategy, Passport first verifies the JWT's signature and decodes the JSON. It then invokes our "),e.TgZ(789,"code"),e._uU(790,"validate()"),e.qZA(),e._uU(791," method passing the decoded JSON as its single parameter. Based on the way JWT signing works, "),e.TgZ(792,"strong"),e._uU(793,"we're guaranteed that we're receiving a valid token"),e.qZA(),e._uU(794," that we have previously signed and issued to a valid user."),e.qZA(),e.TgZ(795,"p"),e._uU(796,"As a result of all this, our response to the "),e.TgZ(797,"code"),e._uU(798,"validate()"),e.qZA(),e._uU(799," callback is trivial: we simply return an object containing the "),e.TgZ(800,"code"),e._uU(801,"userId"),e.qZA(),e._uU(802," and "),e.TgZ(803,"code"),e._uU(804,"username"),e.qZA(),e._uU(805," properties. Recall again that Passport will build a "),e.TgZ(806,"code"),e._uU(807,"user"),e.qZA(),e._uU(808," object based on the return value of our "),e.TgZ(809,"code"),e._uU(810,"validate()"),e.qZA(),e._uU(811," method, and attach it as a property on the "),e.TgZ(812,"code"),e._uU(813,"Request"),e.qZA(),e._uU(814," object."),e.qZA(),e.TgZ(815,"p"),e._uU(816,"It's also worth pointing out that this approach leaves us room ('hooks' as it were) to inject other business logic into the process. For example, we could do a database lookup in our "),e.TgZ(817,"code"),e._uU(818,"validate()"),e.qZA(),e._uU(819," method to extract more information about the user, resulting in a more enriched "),e.TgZ(820,"code"),e._uU(821,"user"),e.qZA(),e._uU(822," object being available in our "),e.TgZ(823,"code"),e._uU(824,"Request"),e.qZA(),e._uU(825,". This is also the place we may decide to do further token validation, such as looking up the "),e.TgZ(826,"code"),e._uU(827,"userId"),e.qZA(),e._uU(828,' in a list of revoked tokens, enabling us to perform token revocation. The model we\'ve implemented here in our sample code is a fast, "stateless JWT" model, where each API call is immediately authorized based on the presence of a valid JWT, and a small bit of information about the requester (its '),e.TgZ(829,"code"),e._uU(830,"userId"),e.qZA(),e._uU(831," and "),e.TgZ(832,"code"),e._uU(833,"username"),e.qZA(),e._uU(834,") is available in our Request pipeline."),e.qZA(),e.TgZ(835,"p"),e._uU(836,"Add the new "),e.TgZ(837,"code"),e._uU(838,"JwtStrategy"),e.qZA(),e._uU(839," as a provider in the "),e.TgZ(840,"code"),e._uU(841,"AuthModule"),e.qZA(),e._uU(842,":"),e.qZA(),e.TgZ(843,"span",16),e._uU(844),e.ALo(845,"extension"),e._UZ(846,"app-tabs",null,49),e.qZA(),e.TgZ(848,"pre")(849,"code",18),e._uU(850,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { LocalStrategy } from './local.strategy';\nimport { JwtStrategy } from './jwt.strategy';\nimport { UsersModule } from '../users/users.module';\nimport { PassportModule } from '@nestjs/passport';\nimport { JwtModule } from '@nestjs/jwt';\nimport { jwtConstants } from './constants';\n\n@Module({\n  imports: [\n    UsersModule,\n    PassportModule,\n    JwtModule.register({\n      secret: jwtConstants.secret,\n      signOptions: { expiresIn: '60s' },\n    }),\n  ],\n  providers: [AuthService, LocalStrategy, JwtStrategy],\n  exports: [AuthService],\n})\nexport class AuthModule {}\n"),e.qZA()(),e.TgZ(851,"pre")(852,"code",18),e._uU(853,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { LocalStrategy } from './local.strategy';\nimport { JwtStrategy } from './jwt.strategy';\nimport { UsersModule } from '../users/users.module';\nimport { PassportModule } from '@nestjs/passport';\nimport { JwtModule } from '@nestjs/jwt';\nimport { jwtConstants } from './constants';\n\n@Module({\n  imports: [\n    UsersModule,\n    PassportModule,\n    JwtModule.register({\n      secret: jwtConstants.secret,\n      signOptions: { expiresIn: '60s' },\n    }),\n  ],\n  providers: [AuthService, LocalStrategy, JwtStrategy],\n  exports: [AuthService],\n})\nexport class AuthModule {}\n"),e.qZA()(),e.TgZ(854,"p"),e._uU(855,"By importing the same secret used when we signed the JWT, we ensure that the "),e.TgZ(856,"strong"),e._uU(857,"verify"),e.qZA(),e._uU(858," phase performed by Passport, and the "),e.TgZ(859,"strong"),e._uU(860,"sign"),e.qZA(),e._uU(861," phase performed in our AuthService, use a common secret."),e.qZA(),e.TgZ(862,"p"),e._uU(863,"Finally, we define the "),e.TgZ(864,"code"),e._uU(865,"JwtAuthGuard"),e.qZA(),e._uU(866," class which extends the built-in "),e.TgZ(867,"code"),e._uU(868,"AuthGuard"),e.qZA(),e._uU(869,":"),e.qZA(),e.TgZ(870,"span",16),e._uU(871),e.ALo(872,"extension"),e._UZ(873,"app-tabs",null,50),e.qZA(),e.TgZ(875,"pre")(876,"code",18),e._uU(877,"\nimport { Injectable } from '@nestjs/common';\nimport { AuthGuard } from '@nestjs/passport';\n\n@Injectable()\nexport class JwtAuthGuard extends AuthGuard('jwt') {}\n"),e.qZA()(),e.TgZ(878,"h4",51)(879,"span"),e._uU(880,"Implement protected route and JWT strategy guards"),e.qZA()(),e.TgZ(881,"p"),e._uU(882,"We can now implement our protected route and its associated Guard."),e.qZA(),e.TgZ(883,"p"),e._uU(884,"Open the "),e.TgZ(885,"code"),e._uU(886,"app.controller.ts"),e.qZA(),e._uU(887," file and update it as shown below:"),e.qZA(),e.TgZ(888,"span",16),e._uU(889),e.ALo(890,"extension"),e._UZ(891,"app-tabs",null,52),e.qZA(),e.TgZ(893,"pre")(894,"code",18),e._uU(895,"\nimport { Controller, Get, Request, Post, UseGuards } from '@nestjs/common';\nimport { JwtAuthGuard } from './auth/jwt-auth.guard';\nimport { LocalAuthGuard } from './auth/local-auth.guard';\nimport { AuthService } from './auth/auth.service';\n\n@Controller()\nexport class AppController {\n  constructor(private authService: AuthService) {}\n\n  @UseGuards(LocalAuthGuard)\n  @Post('auth/login')\n  async login(@Request() req) {\n    return this.authService.login(req.user);\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Get('profile')\n  getProfile(@Request() req) {\n    return req.user;\n  }\n}\n"),e.qZA()(),e.TgZ(896,"pre")(897,"code",18),e._uU(898,"\nimport { Controller, Dependencies, Bind, Get, Request, Post, UseGuards } from '@nestjs/common';\nimport { JwtAuthGuard } from './auth/jwt-auth.guard';\nimport { LocalAuthGuard } from './auth/local-auth.guard';\nimport { AuthService } from './auth/auth.service';\n\n@Dependencies(AuthService)\n@Controller()\nexport class AppController {\n  constructor(authService) {\n    this.authService = authService;\n  }\n\n  @UseGuards(LocalAuthGuard)\n  @Post('auth/login')\n  @Bind(Request())\n  async login(req) {\n    return this.authService.login(req.user);\n  }\n\n  @UseGuards(JwtAuthGuard)\n  @Get('profile')\n  @Bind(Request())\n  getProfile(req) {\n    return req.user;\n  }\n}\n"),e.qZA()(),e.TgZ(899,"p"),e._uU(900,"Once again, we're applying the "),e.TgZ(901,"code"),e._uU(902,"AuthGuard"),e.qZA(),e._uU(903," that the "),e.TgZ(904,"code"),e._uU(905,"@nestjs/passport"),e.qZA(),e._uU(906," module has automatically provisioned for us when we configured the passport-jwt module. This Guard is referenced by its default name, "),e.TgZ(907,"code"),e._uU(908,"jwt"),e.qZA(),e._uU(909,". When our "),e.TgZ(910,"code"),e._uU(911,"GET /profile"),e.qZA(),e._uU(912," route is hit, the Guard will automatically invoke our passport-jwt custom configured strategy, validate the JWT, and assign the "),e.TgZ(913,"code"),e._uU(914,"user"),e.qZA(),e._uU(915," property to the "),e.TgZ(916,"code"),e._uU(917,"Request"),e.qZA(),e._uU(918," object."),e.qZA(),e.TgZ(919,"p"),e._uU(920,"Ensure the app is running, and test the routes using "),e.TgZ(921,"code"),e._uU(922,"cURL"),e.qZA(),e._uU(923,"."),e.qZA(),e.TgZ(924,"pre")(925,"code",13),e._uU(926,'\n$ # GET /profile\n$ curl http://localhost:3000/profile\n$ # result -> {"statusCode":401,"message":"Unauthorized"}\n\n$ # POST /auth/login\n$ curl -X POST http://localhost:3000/auth/login -d \'{"username": "john", "password": "changeme"}\' -H "Content-Type: application/json"\n$ # result -> {"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm... }\n\n$ # GET /profile using access_token returned from previous step as bearer code\n$ curl http://localhost:3000/profile -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm..."\n$ # result -> {"userId":1,"username":"john"}\n'),e.qZA()(),e.TgZ(927,"p"),e._uU(928,"Note that in the "),e.TgZ(929,"code"),e._uU(930,"AuthModule"),e.qZA(),e._uU(931,", we configured the JWT to have an expiration of "),e.TgZ(932,"code"),e._uU(933,"60 seconds"),e.qZA(),e._uU(934,". This is probably too short an expiration, and dealing with the details of token expiration and refresh is beyond the scope of this article. However, we chose that to demonstrate an important quality of JWTs and the passport-jwt strategy. If you wait 60 seconds after authenticating before attempting a "),e.TgZ(935,"code"),e._uU(936,"GET /profile"),e.qZA(),e._uU(937," request, you'll receive a "),e.TgZ(938,"code"),e._uU(939,"401 Unauthorized"),e.qZA(),e._uU(940," response. This is because Passport automatically checks the JWT for its expiration time, saving you the trouble of doing so in your application."),e.qZA(),e.TgZ(941,"p"),e._uU(942,"We've now completed our JWT authentication implementation. JavaScript clients (such as Angular/React/Vue), and other JavaScript apps, can now authenticate and communicate securely with our API Server."),e.qZA(),e.TgZ(943,"h4",53)(944,"span"),e._uU(945,"Extending guards"),e.qZA()(),e.TgZ(946,"p"),e._uU(947,"In most cases, using a provided "),e.TgZ(948,"code"),e._uU(949,"AuthGuard"),e.qZA(),e._uU(950," class is sufficient. However, there might be use-cases when you would like to simply extend the default error handling or authentication logic. For this, you can extend the built-in class and override methods within a sub-class."),e.qZA(),e.TgZ(951,"pre")(952,"code",18),e._uU(953,"\nimport {\n  ExecutionContext,\n  Injectable,\n  UnauthorizedException,\n} from '@nestjs/common';\nimport { AuthGuard } from '@nestjs/passport';\n\n@Injectable()\nexport class JwtAuthGuard extends AuthGuard('jwt') {\n  canActivate(context: ExecutionContext) {\n    // Add your custom authentication logic here\n    // for example, call super.logIn(request) to establish a session.\n    return super.canActivate(context);\n  }\n\n  handleRequest(err, user, info) {\n    // You can throw an exception based on either \"info\" or \"err\" arguments\n    if (err || !user) {\n      throw err || new UnauthorizedException();\n    }\n    return user;\n  }\n}\n"),e.qZA()(),e.TgZ(954,"p"),e._uU(955,"In addition to extending the default error handling and authentication logic, we can allow authentication to go through a chain of strategies. The first strategy to succeed, redirect, or error will halt the chain. Authentication failures will proceed through each strategy in series, ultimately failing if all strategies fail."),e.qZA(),e.TgZ(956,"pre")(957,"code",18),e._uU(958,"\nexport class JwtAuthGuard extends AuthGuard(['strategy_jwt_1', 'strategy_jwt_2', '...']) { ... }\n"),e.qZA()(),e.TgZ(959,"h4",54)(960,"span"),e._uU(961,"Enable authentication globally"),e.qZA()(),e.TgZ(962,"p"),e._uU(963,"If the vast majority of your endpoints should be protected by default, you can register the authentication guard as a "),e.TgZ(964,"a",55),e._uU(965,"global guard"),e.qZA(),e._uU(966," and instead of using "),e.TgZ(967,"code"),e._uU(968,"@UseGuards()"),e.qZA(),e._uU(969," decorator on top of each controller, you could simply flag which routes should be public."),e.qZA(),e.TgZ(970,"p"),e._uU(971,"First, register the "),e.TgZ(972,"code"),e._uU(973,"JwtAuthGuard"),e.qZA(),e._uU(974," as a global guard using the following construction (in any module):"),e.qZA(),e.TgZ(975,"pre")(976,"code",18),e._uU(977,"\nproviders: [\n  {\n    provide: APP_GUARD,\n    useClass: JwtAuthGuard,\n  },\n],\n"),e.qZA()(),e.TgZ(978,"p"),e._uU(979,"With this in place, Nest will automatically bind "),e.TgZ(980,"code"),e._uU(981,"JwtAuthGuard"),e.qZA(),e._uU(982," to all endpoints."),e.qZA(),e.TgZ(983,"p"),e._uU(984,"Now we must provide a mechanism for declaring routes as public. For this, we can create a custom decorator using the "),e.TgZ(985,"code"),e._uU(986,"SetMetadata"),e.qZA(),e._uU(987," decorator factory function."),e.qZA(),e.TgZ(988,"pre")(989,"code",18),e._uU(990,"\nimport { SetMetadata } from '@nestjs/common';\n\nexport const IS_PUBLIC_KEY = 'isPublic';\nexport const Public = () => SetMetadata(IS_PUBLIC_KEY, true);\n"),e.qZA()(),e.TgZ(991,"p"),e._uU(992,"In the file above, we exported two constants. One being our metadata key named "),e.TgZ(993,"code"),e._uU(994,"IS_PUBLIC_KEY"),e.qZA(),e._uU(995,", and the other being our new decorator itself that we\u2019re going to call "),e.TgZ(996,"code"),e._uU(997,"Public"),e.qZA(),e._uU(998," (you can alternatively name it "),e.TgZ(999,"code"),e._uU(1e3,"SkipAuth"),e.qZA(),e._uU(1001," or "),e.TgZ(1002,"code"),e._uU(1003,"AllowAnon"),e.qZA(),e._uU(1004,", whatever fits your project)."),e.qZA(),e.TgZ(1005,"p"),e._uU(1006,"Now that we have a custom "),e.TgZ(1007,"code"),e._uU(1008,"@Public()"),e.qZA(),e._uU(1009," decorator, we can use it to decorate any method, as follows:"),e.qZA(),e.TgZ(1010,"pre")(1011,"code",18),e._uU(1012,"\n@Public()\n@Get()\nfindAll() {\n  return [];\n}\n"),e.qZA()(),e.TgZ(1013,"p"),e._uU(1014,"Lastly, we need the "),e.TgZ(1015,"code"),e._uU(1016,"JwtAuthGuard"),e.qZA(),e._uU(1017," to return "),e.TgZ(1018,"code"),e._uU(1019,"true"),e.qZA(),e._uU(1020," when the "),e.TgZ(1021,"code"),e._uU(1022,'"isPublic"'),e.qZA(),e._uU(1023," metadata is found. For this, we'll use the "),e.TgZ(1024,"code"),e._uU(1025,"Reflector"),e.qZA(),e._uU(1026," class (read more "),e.TgZ(1027,"a",56),e._uU(1028,"here"),e.qZA(),e._uU(1029,")."),e.qZA(),e.TgZ(1030,"pre")(1031,"code",18),e._uU(1032,"\n@Injectable()\nexport class JwtAuthGuard extends AuthGuard('jwt') {\n  constructor(private reflector: Reflector) {\n    super();\n  }\n\n  canActivate(context: ExecutionContext) {\n    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [\n      context.getHandler(),\n      context.getClass(),\n    ]);\n    if (isPublic) {\n      return true;\n    }\n    return super.canActivate(context);\n  }\n}\n"),e.qZA()(),e.TgZ(1033,"h4",57)(1034,"span"),e._uU(1035,"Request-scoped strategies"),e.qZA()(),e.TgZ(1036,"p"),e._uU(1037,"The passport API is based on registering strategies to the global instance of the library. Therefore strategies are not designed to have request-dependent options or to be dynamically instantiated per request (read more about the "),e.TgZ(1038,"a",58),e._uU(1039,"request-scoped"),e.qZA(),e._uU(1040,' providers). When you configure your strategy to be request-scoped, Nest will never instantiate it since it\'s not tied to any specific route. There is no physical way to determine which "request-scoped" strategies should be executed per request.'),e.qZA(),e.TgZ(1041,"p"),e._uU(1042,"However, there are ways to dynamically resolve request-scoped providers within the strategy. For this, we leverage the "),e.TgZ(1043,"a",59),e._uU(1044,"module reference"),e.qZA(),e._uU(1045," feature."),e.qZA(),e.TgZ(1046,"p"),e._uU(1047,"First, open the "),e.TgZ(1048,"code"),e._uU(1049,"local.strategy.ts"),e.qZA(),e._uU(1050," file and inject the "),e.TgZ(1051,"code"),e._uU(1052,"ModuleRef"),e.qZA(),e._uU(1053," in the normal way:"),e.qZA(),e.TgZ(1054,"pre")(1055,"code",18),e._uU(1056,"\nconstructor(private moduleRef: ModuleRef) {\n  super({\n    passReqToCallback: true,\n  });\n}\n"),e.qZA()(),e.TgZ(1057,"blockquote",26)(1058,"strong"),e._uU(1059,"Hint"),e.qZA(),e._uU(1060," The "),e.TgZ(1061,"code"),e._uU(1062,"ModuleRef"),e.qZA(),e._uU(1063," class is imported from the "),e.TgZ(1064,"code"),e._uU(1065,"@nestjs/core"),e.qZA(),e._uU(1066," package.\n"),e.qZA(),e.TgZ(1067,"p"),e._uU(1068,"Be sure to set the "),e.TgZ(1069,"code"),e._uU(1070,"passReqToCallback"),e.qZA(),e._uU(1071," configuration property to "),e.TgZ(1072,"code"),e._uU(1073,"true"),e.qZA(),e._uU(1074,", as shown above."),e.qZA(),e.TgZ(1075,"p"),e._uU(1076,"In the next step, the request instance will be used to obtain the current context identifier, instead of generating a new one (read more about request context "),e.TgZ(1077,"a",60),e._uU(1078,"here"),e.qZA(),e._uU(1079,")."),e.qZA(),e.TgZ(1080,"p"),e._uU(1081,"Now, inside the "),e.TgZ(1082,"code"),e._uU(1083,"validate()"),e.qZA(),e._uU(1084," method of the "),e.TgZ(1085,"code"),e._uU(1086,"LocalStrategy"),e.qZA(),e._uU(1087," class, use the "),e.TgZ(1088,"code"),e._uU(1089,"getByRequest()"),e.qZA(),e._uU(1090," method of the "),e.TgZ(1091,"code"),e._uU(1092,"ContextIdFactory"),e.qZA(),e._uU(1093," class to create a context id based on the request object, and pass this to the "),e.TgZ(1094,"code"),e._uU(1095,"resolve()"),e.qZA(),e._uU(1096," call:"),e.qZA(),e.TgZ(1097,"pre")(1098,"code",18),e._uU(1099,'\nasync validate(\n  request: Request,\n  username: string,\n  password: string,\n) {\n  const contextId = ContextIdFactory.getByRequest(request);\n  // "AuthService" is a request-scoped provider\n  const authService = await this.moduleRef.resolve(AuthService, contextId);\n  ...\n}\n'),e.qZA()(),e.TgZ(1100,"p"),e._uU(1101,"In the example above, the "),e.TgZ(1102,"code"),e._uU(1103,"resolve()"),e.qZA(),e._uU(1104," method will asynchronously return the request-scoped instance of the "),e.TgZ(1105,"code"),e._uU(1106,"AuthService"),e.qZA(),e._uU(1107," provider (we assumed that "),e.TgZ(1108,"code"),e._uU(1109,"AuthService"),e.qZA(),e._uU(1110," is marked as a request-scoped provider)."),e.qZA(),e.TgZ(1111,"h4",61)(1112,"span"),e._uU(1113,"Customize Passport"),e.qZA()(),e.TgZ(1114,"p"),e._uU(1115,"Any standard Passport customization options can be passed the same way, using the "),e.TgZ(1116,"code"),e._uU(1117,"register()"),e.qZA(),e._uU(1118," method. The available options depend on the strategy being implemented. For example:"),e.qZA(),e.TgZ(1119,"pre")(1120,"code",18),e._uU(1121,"\nPassportModule.register({ session: true });\n"),e.qZA()(),e.TgZ(1122,"p"),e._uU(1123,"You can also pass strategies an options object in their constructors to configure them.\nFor the local strategy you can pass e.g.:"),e.qZA(),e.TgZ(1124,"pre")(1125,"code",18),e._uU(1126,"\nconstructor(private authService: AuthService) {\n  super({\n    usernameField: 'email',\n    passwordField: 'password',\n  });\n}\n"),e.qZA()(),e.TgZ(1127,"p"),e._uU(1128,"Take a look at the official "),e.TgZ(1129,"a",62),e._uU(1130,"Passport Website"),e.qZA(),e._uU(1131," for property names."),e.qZA(),e.TgZ(1132,"h4",63)(1133,"span"),e._uU(1134,"Named strategies"),e.qZA()(),e.TgZ(1135,"p"),e._uU(1136,"When implementing a strategy, you can provide a name for it by passing a second argument to the "),e.TgZ(1137,"code"),e._uU(1138,"PassportStrategy"),e.qZA(),e._uU(1139," function. If you don't do this, each strategy will have a default name (e.g., 'jwt' for jwt-strategy):"),e.qZA(),e.TgZ(1140,"pre")(1141,"code",18),e._uU(1142,"\nexport class JwtStrategy extends PassportStrategy(Strategy, 'myjwt')\n"),e.qZA()(),e.TgZ(1143,"p"),e._uU(1144,"Then, you refer to this via a decorator like "),e.TgZ(1145,"code"),e._uU(1146,"@UseGuards(AuthGuard('myjwt'))"),e.qZA(),e._uU(1147,"."),e.qZA(),e.TgZ(1148,"h4",64)(1149,"span"),e._uU(1150,"GraphQL"),e.qZA()(),e.TgZ(1151,"p"),e._uU(1152,"In order to use an AuthGuard with "),e.TgZ(1153,"a",65),e._uU(1154,"GraphQL"),e.qZA(),e._uU(1155,", extend the built-in AuthGuard class and override the getRequest() method."),e.qZA(),e.TgZ(1156,"pre")(1157,"code",18),e._uU(1158,"\n@Injectable()\nexport class GqlAuthGuard extends AuthGuard('jwt') {\n  getRequest(context: ExecutionContext) {\n    const ctx = GqlExecutionContext.create(context);\n    return ctx.getContext().req;\n  }\n}\n"),e.qZA()(),e.TgZ(1159,"p"),e._uU(1160,"To get the current authenticated user in your graphql resolver, you can define a "),e.TgZ(1161,"code"),e._uU(1162,"@CurrentUser()"),e.qZA(),e._uU(1163," decorator:"),e.qZA(),e.TgZ(1164,"pre")(1165,"code",18),e._uU(1166,"\nimport { createParamDecorator, ExecutionContext } from '@nestjs/common';\nimport { GqlExecutionContext } from '@nestjs/graphql';\n\nexport const CurrentUser = createParamDecorator(\n  (data: unknown, context: ExecutionContext) => {\n    const ctx = GqlExecutionContext.create(context);\n    return ctx.getContext().req.user;\n  },\n);\n"),e.qZA()(),e.TgZ(1167,"p"),e._uU(1168,"To use above decorator in your resolver, be sure to include it as a parameter of your query or mutation:"),e.qZA(),e.TgZ(1169,"pre")(1170,"code",18),e._uU(1171,"\n@Query(returns => User)\n@UseGuards(GqlAuthGuard)\nwhoAmI(@CurrentUser() user: User) {\n  return this.usersService.findById(user.id);\n}\n"),e.qZA()()()),2&n){const r=e.MAs(152),a=e.MAs(177),u=e.MAs(199),c=e.MAs(230),i=e.MAs(255),p=e.MAs(349),U=e.MAs(428),A=e.MAs(500),_=e.MAs(586),D=e.MAs(636),T=e.MAs(666),N=e.MAs(699),q=e.MAs(735),W=e.MAs(847),F=e.MAs(874),G=e.MAs(892);e.xp6(149),e.hij(" ",e.xi3(150,74,"users/users.service",r.isJsActive),"\n"),e.xp6(4),e.ekj("hide",r.isJsActive),e.xp6(3),e.ekj("hide",!r.isJsActive),e.xp6(18),e.hij(" ",e.xi3(175,77,"users/users.module",a.isJsActive),"\n"),e.xp6(4),e.ekj("hide",a.isJsActive),e.xp6(3),e.ekj("hide",!a.isJsActive),e.xp6(15),e.hij(" ",e.xi3(197,80,"auth/auth.service",u.isJsActive),"\n"),e.xp6(4),e.ekj("hide",u.isJsActive),e.xp6(3),e.ekj("hide",!u.isJsActive),e.xp6(24),e.hij(" ",e.xi3(228,83,"auth/auth.module",c.isJsActive),"\n"),e.xp6(4),e.ekj("hide",c.isJsActive),e.xp6(3),e.ekj("hide",!c.isJsActive),e.xp6(18),e.hij(" ",e.xi3(253,86,"auth/local.strategy",i.isJsActive),"\n"),e.xp6(4),e.ekj("hide",i.isJsActive),e.xp6(3),e.ekj("hide",!i.isJsActive),e.xp6(22),e.AsE("super(","{"," usernameField: 'email' ","}",")"),e.xp6(65),e.hij(" ",e.xi3(347,89,"auth/auth.module",p.isJsActive),"\n"),e.xp6(4),e.ekj("hide",p.isJsActive),e.xp6(3),e.ekj("hide",!p.isJsActive),e.xp6(72),e.hij(" ",e.xi3(426,92,"app.controller",U.isJsActive),"\n"),e.xp6(4),e.ekj("hide",U.isJsActive),e.xp6(3),e.ekj("hide",!U.isJsActive),e.xp6(65),e.hij(" ",e.xi3(498,95,"auth/local-auth.guard",A.isJsActive),"\n"),e.xp6(86),e.hij(" ",e.xi3(584,98,"auth/auth.service",_.isJsActive),"\n"),e.xp6(4),e.ekj("hide",_.isJsActive),e.xp6(3),e.ekj("hide",!_.isJsActive),e.xp6(43),e.hij(" ",e.xi3(634,101,"auth/constants",D.isJsActive),"\n"),e.xp6(4),e.ekj("hide",D.isJsActive),e.xp6(3),e.ekj("hide",!D.isJsActive),e.xp6(23),e.hij(" ",e.xi3(664,104,"auth/auth.module",T.isJsActive),"\n"),e.xp6(4),e.ekj("hide",T.isJsActive),e.xp6(3),e.ekj("hide",!T.isJsActive),e.xp6(26),e.hij(" ",e.xi3(697,107,"app.controller",N.isJsActive),"\n"),e.xp6(4),e.ekj("hide",N.isJsActive),e.xp6(3),e.ekj("hide",!N.isJsActive),e.xp6(29),e.hij(" ",e.xi3(733,110,"auth/jwt.strategy",q.isJsActive),"\n"),e.xp6(4),e.ekj("hide",q.isJsActive),e.xp6(3),e.ekj("hide",!q.isJsActive),e.xp6(105),e.hij(" ",e.xi3(845,113,"auth/auth.module",W.isJsActive),"\n"),e.xp6(4),e.ekj("hide",W.isJsActive),e.xp6(3),e.ekj("hide",!W.isJsActive),e.xp6(20),e.hij(" ",e.xi3(872,116,"auth/jwt-auth.guard",F.isJsActive),"\n"),e.xp6(18),e.hij(" ",e.xi3(890,119,"app.controller",G.isJsActive),"\n"),e.xp6(4),e.ekj("hide",G.isJsActive),e.xp6(3),e.ekj("hide",!G.isJsActive)}},dependencies:[Z.n,d.U,Q.N,g.rH,m.F],encapsulation:2,changeDetection:0}));const Y=[{path:"mikroorm",component:v,data:{title:"MikroORM"}},{path:"sql-typeorm",component:I,data:{title:"SQL (TypeORM)"}},{path:"mongodb",component:k,data:{title:"MongoDB (Mongoose)"}},{path:"sql-sequelize",component:C,data:{title:"SQL (Sequelize)"}},{path:"cqrs",component:f,data:{title:"CQRS"}},{path:"swagger",redirectTo:"/openapi/introduction"},{path:"prisma",component:x,data:{title:"Prisma"}},{path:"terminus",component:M,data:{title:"Health checks (Terminus)"}},{path:"documentation",component:b,data:{title:"Documentation (Compodoc)"}},{path:"crud-utilities",redirectTo:"/recipes/crud-generator"},{path:"crud",redirectTo:"/recipes/crud-generator"},{path:"crud-generator",component:y,data:{title:"CRUD generator"}},{path:"hot-reload",component:w,data:{title:"Hot reload"}},{path:"serve-static",component:j,data:{title:"Serve static"}},{path:"router-module",component:P,data:{title:"Router module"}},{path:"nest-commander",component:R,data:{title:"Nest Commander"}},{path:"async-local-storage",component:E,data:{title:"Async Local Storage"}},{path:"repl",component:S,data:{title:"REPL"}},{path:"swc",component:L,data:{title:"SWC (fast compiler)"}},{path:"automock",component:H,data:{title:"Automock"}},{path:"passport",component:J,data:{title:"passport"}}];class O{}(0,s.Z)(O,"\u0275fac",function(n){return new(n||O)}),(0,s.Z)(O,"\u0275mod",e.oAB({type:O})),(0,s.Z)(O,"\u0275inj",e.cJS({imports:[z.ez,$.m,g.Bz.forChild(Y)]}))}}]);